{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% trans "DislexIA - Panel Administrativo" %}{% endblock %}</title>
    <link rel="icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#8b5cf6',
                        sidebar: '#f8f9fc'
                    }
                }
            }
        }
    </script>
    <!-- Script para aplicar el tema antes de que se renderice la página (evita parpadeo) -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else if (theme === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                // Si no hay preferencia guardada, usar preferencia del sistema
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
            }
        })();
    </script>
    <style>
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }

        /* Toast Notifications - Estilo consistente */
        @keyframes slide-in {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .animate-slide-in {
            animation: slide-in 0.3s ease-out;
        }

        /* Botón Ir Arriba */
        #scrollToTopBtn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            color: white;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            transition: all 0.3s ease;
            z-index: 9998;
            font-size: 18px;
        }

        #scrollToTopBtn:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6);
            background: linear-gradient(135deg, #7c3aed, #8b5cf6);
        }

        #scrollToTopBtn:active {
            transform: translateY(-2px);
        }

        #scrollToTopBtn.show {
            display: flex;
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Animación del icono */
        #scrollToTopBtn i {
            animation: bounceUp 2s infinite;
        }

        @keyframes bounceUp {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            #scrollToTopBtn {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
        }

        /* Estilos para el dropdown de idiomas */
        .language-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 50;
            overflow: hidden;
        }

        .dark .language-dropdown {
            background: #1f2937;
            border-color: #374151;
        }

        .language-dropdown.active {
            display: block;
        }

        .language-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: #374151;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }

        .dark .language-option {
            color: #d1d5db;
        }

        .language-option:hover {
            background: #f3f4f6;
        }

        .dark .language-option:hover {
            background: #374151;
        }

        .language-option.selected {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .dark .language-option.selected {
            background: rgba(124, 58, 237, 0.2);
            color: #a78bfa;
        }

        .language-option:first-child {
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .language-option:last-child {
            border-radius: 0 0 0.5rem 0.5rem;
        }


        /* Estilos para sidebar derecho (animación de entrada/salida) */
        .right-sidebar {
            width: 280px; /* Mismo ancho que el sidebar izquierdo */
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            overflow-y: auto;
            background: white;
            border-left: 1px solid #e5e7eb;
            z-index: 99; /* Por encima de todo */
            display: flex;
            flex-direction: column;
            /* Estado cerrado: fuera de la pantalla a la derecha */
            transform: translateX(100%);
            opacity: 0;
            transition: transform 300ms ease, opacity 300ms ease;
            will-change: transform, opacity;
            pointer-events: none; /* evitar interacción cuando está cerrado */
        }

        /* Estado abierto */
        .right-sidebar.open {
            transform: translateX(0);
            opacity: 1;
            pointer-events: auto;
        }

        .dark .right-sidebar {
            background: #111827;
            border-left-color: #374151;
        }

        .mini-calendar-day {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            color: #374151; /* Color por defecto en modo claro */
        }

        .dark .mini-calendar-day {
            color: #f9fafb; /* Color blanco en modo oscuro */
        }

        .mini-calendar-day:hover {
            background-color: #f3f4f6;
        }

        .dark .mini-calendar-day:hover {
            background-color: #374151;
        }

        .mini-calendar-day.selected {
            background-color: #8b5cf6;
            color: white;
            font-weight: 600;
        }

        .mini-calendar-day.has-cita::after {
            content: '';
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            background-color: #8b5cf6;
            border-radius: 50%;
        }

        .mini-calendar-day.selected.has-cita::after {
            background-color: white;
        }

        .cita-card {
            transition: all 0.2s;
        }

        .cita-card:hover {
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        /* Ajustar main content para el nuevo sidebar */
        .main-content-with-sidebars {
            margin-left: 280px;
            padding-top: 0;
            transition: margin 300ms ease;
        }

        /* Cuando el sidebar derecho esté abierto, ajustar el main para dejar espacio */
        .main-content-with-sidebars.shift-right {
            margin-right: 280px;
        }

        /* Ajuste para el topbar cuando el sidebar derecho está abierto */
        #topBar {
            transition: margin 300ms ease, max-width 300ms ease;
        }
        #topBar.shift-right {
            margin-right: 280px;
            max-width: calc(100vw - 560px);
        }

        @media (max-width: 1024px) {
            .main-content-with-sidebars {
                margin-left: 0;
            }
            /* En pantallas pequeñas no forzamos desplazamiento a la derecha */
            .main-content-with-sidebars.shift-right {
                margin-right: 0;
            }
        }
        #content-area {
            padding-top: 32px; /* Si quieres más separación debajo de la top bar */
        }
    </style>
    
    {% block extra_head %}{% endblock %}
</head>

<body class="bg-gray-100 dark:bg-gray-950 transition-colors duration-200 h-full">
    <!-- Pantalla de Carga -->
    <div id="preloader" class="preloader" aria-hidden="true">
        <img src="{% static 'img/carga.gif' %}" alt="{% trans 'Cargando...' %}" />
    </div>

    <!-- Sidebar Izquierdo -->
    <div class="fixed top-0 left-0 h-screen border-r border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 transition-colors duration-200 shadow-sm dark:shadow-2xl" style="width: 280px; z-index:40;">
        <div class="flex flex-col h-full"> <!-- Quita el pt-[96px] -->
            <!-- Logo -->
            <div class="p-6">
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 rounded-full overflow-hidden">
                        <img src="{% static 'img/favicon.ico' %}" alt="{% trans 'Foto de perfil' %}" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h1 class="text-sm font-bold text-gray-900 dark:text-white">{% trans "DislexIA" %}</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400">{% trans "Tu neuropsicólogo amigo" %}</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 px-3">
                <a href="{% url 'dashboard' %}"
                    class="nav-link flex items-center gap-3 px-3 py-2 mb-1 
                    {% if request.resolver_match.url_name == 'dashboard' %}
                        text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-500/20
                    {% else %}
                        text-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800
                    {% endif %}
                    rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105 hover:shadow-sm group">

                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-panel-left-icon lucide-layout-panel-left"><rect width="7" height="18" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/></svg>

                    {% trans "Panel Administrativo" %}
                </a>

                <a href="{% url 'games:session_list' %}"
                    class="nav-link flex items-center gap-3 px-3 py-2 mb-1 
                    {% if request.resolver_match.url_name == 'session_list' %}text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-500/20{% else %}text-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800{% endif %} 
                    rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105 hover:shadow-sm">
                        
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chart-no-axes-combined-icon lucide-chart-no-axes-combined"><path d="M12 16v5"/><path d="M16 14v7"/><path d="M20 10v11"/><path d="m22 3-8.646 8.646a.5.5 0 0 1-.708 0L9.354 8.354a.5.5 0 0 0-.707 0L2 15"/><path d="M4 18v3"/><path d="M8 14v7"/></svg>
                        
                    {% trans "Gestión de Sesiones" %}
                </a>

                <a href="{% url 'games:game_list' %}"
                    class="nav-link flex items-center gap-3 px-3 py-2 mb-1 
                    {% if request.resolver_match.url_name == 'game_list' %}
                        text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-500/20
                    {% else %}
                        text-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800
                    {% endif %}
                    rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105 hover:shadow-sm group">

                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gamepad2-icon lucide-gamepad-2"><line x1="6" x2="10" y1="11" y2="11"/><line x1="8" x2="8" y1="9" y2="13"/><line x1="15" x2="15.01" y1="12" y2="12"/><line x1="18" x2="18.01" y1="10" y2="10"/><path d="M17.32 5H6.68a4 4 0 0 0-3.978 3.59c-.006.052-.01.101-.017.152C2.604 9.416 2 14.456 2 16a3 3 0 0 0 3 3c1 0 1.5-.5 2-1l1.414-1.414A2 2 0 0 1 9.828 16h4.344a2 2 0 0 1 1.414.586L17 18c.5.5 1 1 2 1a3 3 0 0 0 3-3c0-1.545-.604-6.584-.685-7.258-.007-.05-.011-.1-.017-.151A4 4 0 0 0 17.32 5z"/></svg>

                    {% trans "Juegos" %}
                </a>

                <a href="{% url 'core:calendar' %}"
                class="group nav-link flex items-center gap-3 px-3 py-2 mb-1 {% if request.resolver_match.url_name == 'calendar' %}text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-500/20{% else %}text-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800{% endif %} rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105 hover:shadow-sm">

                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-icon lucide-calendar"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>

                    {% trans "Calendario" %}
                </a>

                <a href="{% url 'core:documents' %}"
                    class="nav-link flex items-center gap-3 px-3 py-2 mb-1 
                    {% if request.resolver_match.url_name == 'documents' %}
                        text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-500/20
                    {% else %}
                        text-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800
                    {% endif %}
                    rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105 hover:shadow-sm group">

                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text-icon lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>

                    {% trans "Recursos Digitales" %}
                </a>
<<<<<<< HEAD
                <a href="{% url 'core:lista_ninos' %}"
                    class="nav-link flex items-center gap-3 px-3 py-2 mb-1 {% if request.resolver_match.url_name == 'documents' %}text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-500/20{% else %}text-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800{% endif %} rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105 hover:shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Datos 
=======

                <a href="{% url 'core:lista_ninos' %}"
                    class="nav-link flex items-center gap-3 px-3 py-2 mb-1 
                    {% if request.resolver_match.url_name == 'lista_ninos' %}
                        text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-500/20
                    {% else %}
                        text-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800
                    {% endif %}
                    rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105 hover:shadow-sm group">

                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-id-card-icon lucide-id-card"><path d="M16 10h2"/><path d="M16 14h2"/><path d="M6.17 15a3 3 0 0 1 5.66 0"/><circle cx="9" cy="11" r="2"/><rect x="2" y="5" width="20" height="14" rx="2"/></svg>

                    {% trans "Datos de Pacientes" %}
>>>>>>> origin/develop
                </a>
            </nav>

            <!-- Bottom Section -->
            <div class="p-3">
                <a href="{% url 'core:settings' %}"
                    class="nav-link flex items-center gap-3 px-3 py-2 mb-1 
                    {% if request.resolver_match.url_name == 'settings' %}
                        text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-500/20
                    {% else %}
                        text-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800
                    {% endif %}
                    rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105 hover:shadow-sm group">

                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-icon lucide-settings"><path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/><circle cx="12" cy="12" r="3"/></svg>

                    {% trans "Configuraciones" %}
                </a>

                <a href="{% url 'core:support' %}"
                    class="nav-link flex items-center gap-3 px-3 py-2 mb-3 
                    {% if request.resolver_match.url_name == 'support' %}
                        text-purple-600 dark:text-purple-400 bg-purple-100 dark:bg-purple-500/20
                    {% else %}
                        text-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800
                    {% endif %}
                    rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105 hover:shadow-sm group">

                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-headset-icon lucide-headset"><path d="M3 11h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5Zm0 0a9 9 0 1 1 18 0m0 0v5a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3Z"/><path d="M21 16v2a4 4 0 0 1-4 4h-5"/></svg>

                    {% trans "Soporte" %}
                </a>

                <!-- User Profile con borde superior -->
                <div class="border-t border-gray-200 dark:border-gray-800 pt-3">
                    <a href="{% url 'core:profile' %}"
                        class="nav-link flex items-center gap-2 p-2 {% if request.resolver_match.url_name == 'profile' %}bg-purple-100 dark:bg-purple-500/20{% else %}hover:bg-gray-100 dark:hover:bg-gray-800{% endif %} rounded-lg cursor-pointer transition-all duration-200 hover:scale-105 mb-2">
                        <div class="w-10 h-10 rounded-full overflow-hidden bg-purple-100 dark:bg-purple-900/50 ring-2 ring-purple-200 dark:ring-purple-500/30">
                            {% if user.imagen %}
                                <img src="{{ user.imagen.url }}" alt="{% trans 'Foto de perfil' %}" class="w-full h-full object-cover">
                            {% else %}
                                <img src="{% static 'img/profile.png' %}" alt="{% trans 'Foto de perfil' %}" class="w-full h-full object-cover">
                            {% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-900 dark:text-white truncate">{{ user.nombre_completo }}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">{{ user.email }}</p>
                        </div>
                        <svg class="w-4 h-4 text-gray-400 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>

                    <!-- Botón de Logout -->
                    <form method="post" action="{% url 'core:logout' %}" class="w-full">
                        {% csrf_token %}
                        <button type="submit"
                            class="nav-link flex items-center gap-3 px-3 py-2 text-red-600 dark:text-red-500 hover:bg-red-50 dark:hover:bg-red-950/30 rounded-lg text-sm font-medium transition-all duration-200 hover:scale-105 w-full">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            {% trans "Cerrar Sesión" %}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Sidebar - Citas del Día -->
    <div class="right-sidebar" id="rightSidebar" style="position:fixed; top:0; right:0; height:100vh; z-index: 99;" aria-hidden="true">
        <div class="p-6">
            <!-- Título -->
            <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
                <i class="fas fa-calendar-check text-purple-600 dark:text-purple-400 mr-2"></i>
                {% trans "Citas del Día" %}
            </h2>

            <!-- Mini Calendario -->
            <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-4 mb-4">
                <div class="flex items-center justify-between mb-3">
                    <button id="mini-prev-month" class="p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i class="fas fa-chevron-left text-sm text-gray-600 dark:text-gray-400"></i>
                    </button>
                    <h3 id="mini-current-month" class="text-sm font-semibold text-gray-900 dark:text-white"></h3>
                    <button id="mini-next-month" class="p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i class="fas fa-chevron-right text-sm text-gray-600 dark:text-gray-400"></i>
                    </button>
                </div>

                <!-- Días de la semana -->
                <div class="grid grid-cols-7 gap-1 mb-2">
                    <div class="text-center text-xs text-gray-500 dark:text-gray-400">{% trans "D" %}</div>
                    <div class="text-center text-xs text-gray-500 dark:text-gray-400">{% trans "L" %}</div>
                    <div class="text-center text-xs text-gray-500 dark:text-gray-400">{% trans "M" %}</div>
                    <div class="text-center text-xs text-gray-500 dark:text-gray-400">{% trans "X" %}</div>
                    <div class="text-center text-xs text-gray-500 dark:text-gray-400">{% trans "J" %}</div>
                    <div class="text-center text-xs text-gray-500 dark:text-gray-400">{% trans "V" %}</div>
                    <div class="text-center text-xs text-gray-500 dark:text-gray-400">{% trans "S" %}</div>
                </div>

                <!-- Días del mes -->
                <div id="mini-calendar-days" class="grid grid-cols-7 gap-1">
                    <!-- Se llenará con JavaScript -->
                </div>
            </div>

            <!-- Lista de Citas -->
            <div class="space-y-3" id="citas-list">
                <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <i class="fas fa-calendar-times text-3xl mb-2 opacity-50"></i>
                    <p class="text-sm">{% trans "No hay citas para hoy" %}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content-with-sidebars">
        <!-- Top Bar -->
        <div id="topBar" class="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 px-8 py-4 flex items-center justify-between w-full"
            style="position:fixed; top:0; left:0; right:0; z-index:50; width:100vw; margin-left:280px; max-width:calc(100vw - 280px);">
            <div class="flex items-center gap-3">
                <!-- Imagen de perfil -->
                <div class="w-10 h-10 rounded-full overflow-hidden bg-purple-100 dark:bg-purple-900/50">
                    {% if user.imagen %}
                        <img src="{{ user.imagen.url }}" alt="{% trans 'Foto de perfil' %}" class="w-full h-full object-cover">
                    {% else %}
                        <img src="{% static 'img/profile.png' %}" alt="{% trans 'Foto de perfil' %}" class="w-full h-full object-cover">
                    {% endif %}
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-900 dark:text-white">{{ user.nombre_completo }}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">{% trans "Bienvenido de nuevo" %}</p>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <!-- Language Selector -->
                <div class="relative">
                    <button type="button" id="languageDropdownBtn"
                        class="inline-flex items-center font-medium justify-center px-4 py-2 text-sm text-gray-700 dark:text-gray-300 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800">
                        {% get_current_language as LANGUAGE_CODE %}
                        {% if LANGUAGE_CODE == 'es' %}
                        <svg class="w-5 h-5 rounded-full me-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 750 500">
                            <rect width="750" height="500" fill="#c60b1e"/>
                            <rect width="750" height="250" y="125" fill="#ffc400"/>
                        </svg>
                        {% trans "Español" %} (ES)
                        {% else %}
                        <svg class="w-5 h-5 rounded-full me-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30">
                            <clipPath id="s"><path d="M0,0 v30 h60 v-30 z"/></clipPath>
                            <clipPath id="t"><path d="M30,15 h30 v15 z v-30 h-30 z h-30 v15 z v-30 h30 z"/></clipPath>
                            <g clip-path="url(#s)">
                                <path d="M0,0 v30 h60 v-30 z" fill="#012169"/>
                                <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/>
                                <path d="M0,0 L60,30 M60,0 L0,30" clip-path="url(#t)" stroke="#C8102E" stroke-width="4"/>
                                <path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/>
                                <path d="M30,0 v30 M0,15 h60" stroke="#C8102E" stroke-width="6"/>
                            </g>
                        </svg>
                        {% trans "Inglés" %} (US)
                        {% endif %}
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div id="languageDropdown" class="language-dropdown">
                        <form action="{% url 'set_language' %}" method="post" id="languageForm">
                            {% csrf_token %}
                            <input name="next" type="hidden" value="{{ request.get_full_path }}" />
                            
                            <button type="submit" name="language" value="es" 
                                class="language-option {% if LANGUAGE_CODE == 'es' %}selected{% endif %}">
                                <svg class="w-5 h-5 rounded-full flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 750 500">
                                    <rect width="750" height="500" fill="#c60b1e"/>
                                    <rect width="750" height="250" y="125" fill="#ffc400"/>
                                </svg>
                                <span class="flex-1 text-left">{% trans "Español" %}(ES)</span>
                                {% if LANGUAGE_CODE == 'es' %}
                                {% endif %}
                            </button>
                            
                            <button type="submit" name="language" value="en" 
                                class="language-option {% if LANGUAGE_CODE == 'en' %}selected{% endif %}">
                                <svg class="w-5 h-5 rounded-full flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30">
                                    <clipPath id="s2"><path d="M0,0 v30 h60 v-30 z"/></clipPath>
                                    <clipPath id="t2"><path d="M30,15 h30 v15 z v-30 h-30 z h-30 v15 z v-30 h30 z"/></clipPath>
                                    <g clip-path="url(#s2)">
                                        <path d="M0,0 v30 h60 v-30 z" fill="#012169"/>
                                        <path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/>
                                        <path d="M0,0 L60,30 M60,0 L0,30" clip-path="url(#t2)" stroke="#C8102E" stroke-width="4"/>
                                        <path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/>
                                        <path d="M30,0 v30 M0,15 h60" stroke="#C8102E" stroke-width="6"/>
                                    </g>
                                </svg>
                                <span class="flex-1 text-left">{% trans "Inglés" %}(US)</span>
                                {% if LANGUAGE_CODE == 'en' %}
                                {% endif %}
                            </button>
                        </form>
                    </div>
                </div>
                
                <button data-collapse-toggle="navbar-language" type="button"
                    class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:focus:ring-gray-700"
                    aria-controls="navbar-language" aria-expanded="false">
                    <span class="sr-only">{% trans "Abrir menú principal" %}</span>
                    <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 17 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M1 1h15M1 7h15M1 13h15" />
                    </svg>
                </button>
                <div class="relative flex-1 max-w-md">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <input type="text" placeholder="{% trans 'Buscar...' %}"
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-700 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-600">
                </div>

                <!-- Notification Button -->
                <div class="relative">
                    <button id="notificationBtn"
                        class="p-2.5 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl text-gray-600 dark:text-gray-400 relative transition-all hover:scale-105">
                        <i class="far fa-bell text-lg"></i>
                        <span id="notificationBadge"
                            class="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white dark:border-gray-900 animate-pulse hidden"></span>
                    </button>
                    
                    <!-- Dropdown de Notificaciones -->
                    <div id="notificationDropdown" 
                         class="hidden absolute right-0 mt-2 w-96 bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-800 z-[60] max-h-[32rem] overflow-hidden">
                        <!-- Header -->
                        <div class="p-4 border-b border-gray-200 dark:border-gray-800">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white">
                                    <i class="fas fa-bell text-purple-600 dark:text-purple-400 mr-2"></i>
                                    {% trans "Notificaciones" %}
                                </h3>
                                <button id="markAllReadBtn" 
                                        class="text-xs text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 font-medium">
                                    {% trans "Marcar todas como leídas" %}
                                </button>
                            </div>
                        </div>
                        
                        <!-- Lista de Notificaciones -->
                        <div id="notificationList" class="overflow-y-auto max-h-96">
                            <!-- Se llenará con JavaScript -->
                            <div class="flex flex-col items-center justify-center py-12 px-4">
                                <i class="fas fa-spinner fa-spin text-4xl text-gray-400 dark:text-gray-600 mb-3"></i>
                                <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "Cargando notificaciones..." %}</p>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="p-3 border-t border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-800">
                            <a href="{% url 'core:calendar' %}" 
                               class="block text-center text-sm font-medium text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300">
                                {% trans "Ver todas las citas" %} →
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Schedule Button -->
                <a href="{% url 'core:calendar' %}"
                    class="px-5 py-2.5 border border-gray-300 dark:border-gray-700 hover:border-gray-400 dark:hover:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2.5 transition-all hover:shadow-sm">
                    <i class="far fa-calendar-plus text-base"></i>
                    {% trans "Agenda" %}
                </a>

                <!-- Botón para mostrar/ocultar sidebar derecho -->
                <button id="toggleRightSidebarBtn" title="{% trans 'Mostrar/Ocultar Citas del Día' %}" class="px-5 py-2.5 border border-gray-300 dark:border-gray-700 hover:border-gray-400 dark:hover:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2.5 transition-all hover:shadow-sm">
                    <i class="far fa-calendar text-base"></i>
                </button>
            </div>
        </div>

        <!-- Toast de Notificación -->
        <div id="toast-notification" class="fixed top-4 right-4 z-[9999] hidden">
            <div class="bg-white dark:bg-gray-900 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-800 p-4 flex items-center gap-3 animate-slide-in">
                <div id="toast-icon" class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0"></div>
                <div>
                    <p id="toast-message" class="text-sm font-semibold text-gray-900 dark:text-white"></p>
                </div>
                <button onclick="cerrarToast()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 ml-2">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="p-8 min-h-screen transition-colors duration-200" style="padding-top:96px;">
            {% block content %}
            <!-- El contenido específico de cada página se cargará aquí -->
            {% endblock %}
        </div>
    </div>

    <!-- Botón Ir Arriba -->
    <button id="scrollToTopBtn" title="{% trans 'Ir arriba' %}" aria-label="{% trans 'Volver arriba' %}">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Scripts Base -->
    <script src="{% static 'main.js' %}"></script>
    <script>
        // Toggle animado y persistente para el sidebar derecho.
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggleRightSidebarBtn');
            const rightSidebar = document.getElementById('rightSidebar');
            const mainContent = document.querySelector('.main-content-with-sidebars');
            const topBar = document.getElementById('topBar');

            function applySidebarState(open, save = true) {
                if (!rightSidebar || !mainContent || !topBar) return;

                if (open) {
                    rightSidebar.classList.add('open');
                    rightSidebar.setAttribute('aria-hidden', 'false');
                    mainContent.classList.add('shift-right');
                    // Ajustar el topBar mediante estilos inline para sobreescribir el max-width inline existente
                    if (topBar) {
                        topBar.classList.add('shift-right');
                        topBar.style.marginRight = '280px';
                        topBar.style.maxWidth = 'calc(100vw - 560px)';
                    }
                    // Cargar citas del día si la función existe
                    if (typeof window.loadCitasDelDia === 'function') {
                        window.loadCitasDelDia();
                    }
                } else {
                    rightSidebar.classList.remove('open');
                    rightSidebar.setAttribute('aria-hidden', 'true');
                    mainContent.classList.remove('shift-right');
                    if (topBar) {
                        topBar.classList.remove('shift-right');
                        // Restaurar el estilo cerrado (valor original)
                        topBar.style.marginRight = '';
                        topBar.style.maxWidth = 'calc(100vw - 280px)';
                    }
                }

                if (save) localStorage.setItem('rightSidebarOpen', open ? 'true' : 'false');
            }

            // Inicializar desde localStorage (si existe preferencia)
            try {
                const persisted = localStorage.getItem('rightSidebarOpen');
                // Si estaba abierto, mostrarlo animado desde el inicio
                applySidebarState(persisted === 'true', false);
            } catch (e) {
                // Si localStorage no está disponible, no hacemos nada
            }

            if (toggleBtn) {
                toggleBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isOpen = rightSidebar.classList.contains('open');
                    applySidebarState(!isOpen);
                });
            }
        });
    </script>
    
    <!-- Inicializar mensajes de Django -->
    <script>
        {% if messages %}
        document.addEventListener('DOMContentLoaded', function() {
            const djangoMessages = [
                {% for message in messages %}
                { tags: '{{ message.tags }}', message: '{{ message|escapejs }}' }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            procesarMensajesDjango(djangoMessages);
        });
        {% endif %}
    </script>
    
    <!-- Script para auto-eliminar toasts después de 3 segundos -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toasts = document.querySelectorAll('.toast');
            toasts.forEach(function(toast) {
                setTimeout(function() {
                    toast.remove();
                }, 3000);
            });
        });
    </script>

    <!-- Script para dropdown de idiomas -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const languageBtn = document.getElementById('languageDropdownBtn');
            const languageDropdown = document.getElementById('languageDropdown');
            
            if (languageBtn && languageDropdown) {
                languageBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    languageDropdown.classList.toggle('active');
                });
                
                // Cerrar al hacer clic fuera
                document.addEventListener('click', function(e) {
                    if (!languageBtn.contains(e.target) && !languageDropdown.contains(e.target)) {
                        languageDropdown.classList.remove('active');
                    }
                });
            }
        });
    </script>

    <!-- Script para modo oscuro global -->
    <script>
        (function() {
            // Función para cambiar el tema
            window.toggleDarkMode = function(isDark) {
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            };

            // Sincronizar el toggle con el estado actual
            function syncDarkModeToggle() {
                const darkModeToggle = document.getElementById('dark-mode-toggle');
                if (darkModeToggle) {
                    const isDark = document.documentElement.classList.contains('dark');
                    darkModeToggle.checked = isDark;
                }
            }

            // Ejecutar al cargar la página
            syncDarkModeToggle();

            // Observar cambios en el DOM para sincronizar dinámicamente
            const observer = new MutationObserver(syncDarkModeToggle);
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['class']
            });
        })();
    </script>

    <!-- Script para botón Ir Arriba -->
    <script>
        (function() {
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');
            const contentArea = document.getElementById('content-area');

            // Mostrar/ocultar botón según scroll
            function checkScroll() {
                if (window.pageYOffset > 300) {
                    scrollToTopBtn.classList.add('show');
                } else {
                    scrollToTopBtn.classList.remove('show');
                }
            }

            // Scroll suave hacia arriba
            function scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }

            // Event listeners
            window.addEventListener('scroll', checkScroll);
            scrollToTopBtn.addEventListener('click', scrollToTop);

            // Verificar scroll inicial
            checkScroll();
        })();
    </script>
    
    <!-- Script para gestión de citas en sidebar -->
    <script>
        (function initCitasSidebar() {
            const now = new Date();
            let miniCurrentMonth = now.getMonth();
            let miniCurrentYear = now.getFullYear();
            let selectedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let citasConFecha = new Set();

            const miniCalendarDays = document.getElementById('mini-calendar-days');
            const miniCurrentMonthEl = document.getElementById('mini-current-month');
            const miniPrevBtn = document.getElementById('mini-prev-month');
            const miniNextBtn = document.getElementById('mini-next-month');
            const citasList = document.getElementById('citas-list');

            // Cargar citas con fechas del mes
            async function load_citas_del_mes() {
                try {
                    const firstDay = new Date(miniCurrentYear, miniCurrentMonth, 1);
                    const lastDay = new Date(miniCurrentYear, miniCurrentMonth + 1, 0);
                    
                    // Cargar todas las citas del mes para marcar días
                    citasConFecha.clear();
                    for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                        const fecha = d.toISOString().split('T')[0];
                        const response = await fetch("{% url 'core:get_citas_dia' %}?fecha=" + fecha);
                        const data = await response.json();
                        if (data.citas && data.citas.length > 0) {
                            citasConFecha.add(fecha);
                        }
                    }
                    renderMiniCalendar();
                } catch (error) {
                    console.error('Error cargando citas del mes:', error);
                }
            }

            function renderMiniCalendar() {
                miniCalendarDays.innerHTML = '';
                
                const monthNames = [
                    '{% trans "Ene" %}', '{% trans "Feb" %}', '{% trans "Mar" %}', 
                    '{% trans "Abr" %}', '{% trans "May" %}', '{% trans "Jun" %}', 
                    '{% trans "Jul" %}', '{% trans "Ago" %}', '{% trans "Sep" %}', 
                    '{% trans "Oct" %}', '{% trans "Nov" %}', '{% trans "Dic" %}'
                ];
                miniCurrentMonthEl.textContent = `${monthNames[miniCurrentMonth]} ${miniCurrentYear}`;
                miniCurrentMonthEl.textContent = `${monthNames[miniCurrentMonth]} ${miniCurrentYear}`;
                
                const firstDay = new Date(miniCurrentYear, miniCurrentMonth, 1);
                const lastDay = new Date(miniCurrentYear, miniCurrentMonth + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();
                
                // Días vacíos al inicio
                for (let i = 0; i < startingDay; i++) {
                    const emptyDay = document.createElement('div');
                    miniCalendarDays.appendChild(emptyDay);
                }
                
                // Días del mes
                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    const dateStr = `${miniCurrentYear}-${String(miniCurrentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const hasCita = citasConFecha.has(dateStr);
                    
                    dayEl.className = `mini-calendar-day relative ${hasCita ? 'has-cita' : ''}`;
                    dayEl.textContent = day;
                    
                    if (day === today.getDate() && miniCurrentMonth === today.getMonth() && miniCurrentYear === today.getFullYear()) {
                        dayEl.classList.add('text-purple-600', 'dark:text-purple-400', 'font-semibold');
                    }
                    
                    if (day === selectedDate.getDate() && miniCurrentMonth === selectedDate.getMonth() && miniCurrentYear === selectedDate.getFullYear()) {
                        dayEl.classList.add('selected');
                    }
                    
                    dayEl.addEventListener('click', () => selectMiniDate(day));
                    miniCalendarDays.appendChild(dayEl);
                }
            }

            async function selectMiniDate(day) {
                selectedDate = new Date(miniCurrentYear, miniCurrentMonth, day);
                renderMiniCalendar();
                await loadCitasDelDia();
            }

            async function loadCitasDelDia() {
                // Si hay selección manual, usarla; si no, usar la fecha actual solo la primera vez
                if (typeof window.selectedDateSidebar !== 'undefined' && window.selectedDateSidebar) {
                    selectedDate = new Date(window.selectedDateSidebar.getFullYear(), window.selectedDateSidebar.getMonth(), window.selectedDateSidebar.getDate());
                } else if (!selectedDate || isNaN(selectedDate.getTime())) {
                    const now = new Date();
                    selectedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                }
                const fecha = selectedDate.toISOString().split('T')[0];
                
                try {
                    const response = await fetch("{% url 'core:get_citas_dia' %}?fecha=" + fecha);
                    const data = await response.json();
                    
                    citasList.innerHTML = '';
                    
                    if (data.citas.length === 0) {
                        citasList.innerHTML = `
                            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                                <i class="fas fa-calendar-times text-3xl mb-2 opacity-50"></i>
                                <p class="text-sm">{% trans "No hay citas para este día" %}</p>
                            </div>
                        `;
                    } else {
                        data.citas.forEach(cita => {
                            const citaCard = document.createElement('div');
                            citaCard.className = 'cita-card bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3';
                            
                            const fotoUrl = cita.foto_paciente || '{% static "img/profile.png" %}';
                            const completadaClass = cita.completada ? 'opacity-50' : '';
                            const checkIcon = cita.completada ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-300';
                            
                            citaCard.innerHTML = `
                                <div class="flex items-center gap-3 ${completadaClass}">
                                    <img src="${fotoUrl}" alt="${cita.nombre_paciente}" 
                                         class="w-12 h-12 rounded-full object-cover">
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-medium text-gray-900 dark:text-white text-sm truncate">
                                            ${cita.nombre_paciente}
                                        </h4>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">
                                            <i class="far fa-clock mr-1"></i>${cita.hora}
                                        </p>
                                    </div>
                                    <button onclick="toggleCitaCompletada(${cita.id})" 
                                            class="text-lg hover:scale-110 transition-transform">
                                        <i class="fas ${checkIcon}"></i>
                                    </button>
                                </div>
                                ${cita.notas ? `<p class="text-xs text-gray-600 dark:text-gray-400 mt-2 pl-15">${cita.notas}</p>` : ''}
                            `;
                            
                            citasList.appendChild(citaCard);
                        });
                    }
                } catch (error) {
                    console.error('Error cargando citas:', error);
                }
            }

            window.toggleCitaCompletada = async function(citaId) {
                try {
                    const response = await fetch("{% url 'core:marcar_cita_completada' cita_id=0 %}".replace('/0/', `/${citaId}/`), {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        await loadCitasDelDia();
                    }
                } catch (error) {
                    console.error('Error al marcar cita:', error);
                }
            };

            miniPrevBtn.addEventListener('click', () => {
                miniCurrentMonth--;
                if (miniCurrentMonth < 0) {
                    miniCurrentMonth = 11;
                    miniCurrentYear--;
                }
                load_citas_del_mes();
            });

            miniNextBtn.addEventListener('click', () => {
                miniCurrentMonth++;
                if (miniCurrentMonth > 11) {
                    miniCurrentMonth = 0;
                    miniCurrentYear++;
                }
                load_citas_del_mes();
            });

            // Inicializar
            load_citas_del_mes();
            loadCitasDelDia();

            // Recargar citas cada 30 segundos
            setInterval(() => {
                load_citas_del_mes();
                loadCitasDelDia();
            }, 30000);

            // Exponer funciones globalmente
            window.loadCitasDelDia = loadCitasDelDia;
            window.load_citas_del_mes = load_citas_del_mes;
        })();
    </script>
    
    <!-- Script para sistema de notificaciones -->
    <script>
        (function initNotificationSystem() {
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationList = document.getElementById('notificationList');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            
            let notificaciones = [];
            
            // Cargar notificaciones
            async function loadNotificaciones() {
                try {
                    const response = await fetch("{% url 'core:get_notificaciones' %}");
                    const data = await response.json();
                    
                    if (data.success) {
                        notificaciones = data.notificaciones;
                        updateNotificationUI();
                    }
                } catch (error) {
                    console.error('Error cargando notificaciones:', error);
                    notificationList.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-12 px-4">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-3"></i>
                            <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "Error al cargar notificaciones" %}</p>
                        </div>
                    `;
                }
            }
            
            function updateNotificationUI() {
                // Actualizar badge
                const noLeidas = notificaciones.filter(n => n.tipo === 'urgente' || n.tipo === 'error').length;
                if (noLeidas > 0) {
                    notificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.classList.add('hidden');
                }
                
                // Actualizar lista
                if (notificaciones.length === 0) {
                    notificationList.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-12 px-4">
                            <i class="fas fa-check-circle text-4xl text-green-400 mb-3"></i>
                            <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">{% trans "¡Todo al día!" %}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">{% trans "No tienes notificaciones pendientes" %}</p>
                        </div>
                    `;
                } else {
                    notificationList.innerHTML = notificaciones.map(notif => {
                        const iconColor = {
                            'urgente': 'text-red-500',
                            'error': 'text-red-500',
                            'advertencia': 'text-yellow-500',
                            'info': 'text-blue-500',
                            'success': 'text-green-500'
                        }[notif.tipo] || 'text-gray-500';
                        
                        const bgColor = {
                            'urgente': 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800',
                            'error': 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800',
                            'advertencia': 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800',
                            'info': 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800',
                            'success': 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800'
                        }[notif.tipo] || 'bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700';
                        
                        return `
                            <div class="notification-item p-4 border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors cursor-pointer"
                                 data-id="${notif.id || ''}"
                                 data-accion="${notif.accion || ''}">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 rounded-full ${bgColor} border flex items-center justify-center flex-shrink-0">
                                        <i class="fas ${notif.icono} ${iconColor}"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">
                                            ${notif.mensaje}
                                        </p>
                                        ${notif.paciente ? `
                                            <div class="flex items-center gap-2 mt-2">
                                                ${notif.foto ? `
                                                    <img src="${notif.foto}" alt="${notif.paciente}" 
                                                         class="w-6 h-6 rounded-full object-cover">
                                                ` : ''}
                                                <span class="text-xs text-gray-500 dark:text-gray-400">${notif.paciente}</span>
                                            </div>
                                        ` : ''}
                                        ${notif.tiempo ? `
                                            <div class="mt-2">
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${bgColor}">
                                                    <i class="far fa-clock mr-1"></i>
                                                    ${notif.tiempo}
                                                </span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    ${notif.tipo === 'urgente' || notif.tipo === 'error' ? `
                                        <div class="w-2 h-2 rounded-full bg-red-500 flex-shrink-0 mt-2"></div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Agregar event listeners a las notificaciones
                    document.querySelectorAll('.notification-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const accion = this.dataset.accion;
                            const citaId = this.dataset.id;
                            
                            // Cerrar dropdown
                            notificationDropdown.classList.add('hidden');
                            
                            // Ejecutar acción
                            if (accion === 'ver_calendario') {
                                window.location.href = "{% url 'core:calendar' %}";
                            } else if (accion === 'agregar_paciente') {
                                window.location.href = "{% url 'core:lista_ninos' %}";
                            } else if (citaId) {
                                window.location.href = "{% url 'core:calendar' %}";
                            }
                        });
                    });
                }
            }
            
            // Toggle dropdown
            notificationBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationDropdown.classList.toggle('hidden');
                if (!notificationDropdown.classList.contains('hidden')) {
                    loadNotificaciones();
                }
            });
            
            // Cerrar al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
                    notificationDropdown.classList.add('hidden');
                }
            });
            
            // Marcar todas como leídas
            markAllReadBtn.addEventListener('click', function() {
                notificaciones = [];
                updateNotificationUI();
            });
            
            // Cargar notificaciones iniciales
            loadNotificaciones();
            
            // Recargar cada 60 segundos
            setInterval(loadNotificaciones, 60000);
        })();
    </script>
    
    {% block extra_scripts %}{% endblock %}
    <!-- Modal global para seleccionar/crear niño antes de jugar -->
    <div id="modal-seleccion-nino" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-900 rounded-xl w-11/12 md:w-2/3 lg:w-1/2 p-6 animate-fade-in">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Seleccionar o crear niño</h3>
                <button id="modal-close" class="text-gray-500 dark:text-gray-300">✕</button>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <h4 class="font-semibold mb-2 text-gray-800 dark:text-gray-200">Niños asociados</h4>
                    <ul id="lista-ninos-modal" class="space-y-2 max-h-64 overflow-auto text-gray-700 dark:text-gray-300">
                        <!-- se llenará mediante AJAX si se desea -->
                        {% for nino in ninos %}
                        <li class="flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-800 rounded hover:bg-purple-600 hover:text-white transition-all">
                            <span>
                                {{ nino.nombres }} {{ nino.apellidos }} ({{ nino.edad }} años)
                            </span>
                            <div class="flex items-center gap-2">
                                <button class="text-sm bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 transition-all seleccionar-nino-btn" 
                                        data-nino-id="{{ nino.id }}">
                                    Seleccionar
                                </button>
                                <a href="{% url 'core:editar_nino' nino.id %}" 
                                   class="text-sm bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition-all">
                                    Editar
                                </a>
                            </div>
                        </li>
                    {% empty %}
                        <li class="text-center text-gray-500 dark:text-gray-400 italic">
                            No tienes niños asociados. Por favor, crea uno nuevo para continuar.
                        </li>
                    {% endfor %}
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-2 text-gray-800 dark:text-gray-200">Crear nuevo niño</h4>
                    <form id="form-crear-nino-modal">
                        <div class="grid grid-cols-1 gap-2">
                            <input name="nombres" class="border p-2 rounded bg-white dark:bg-gray-800" placeholder="Nombres" required />
                            <input name="apellidos" class="border p-2 rounded bg-white dark:bg-gray-800" placeholder="Apellidos" required />
                            <input name="fecha_nacimiento" type="date" class="border p-2 rounded bg-white dark:bg-gray-800" required />
                            <input name="edad" type="number" min="6" max="12" class="border p-2 rounded bg-white dark:bg-gray-800" placeholder="Edad" required />
                            <select name="genero" class="border p-2 rounded bg-white dark:bg-gray-800">
                                <option value="Masculino">Masculino</option>
                                <option value="Femenino">Femenino</option>
                                <option value="Otro">Otro</option>
                            </select>
                            <input name="idioma_nativo" class="border p-2 rounded bg-white dark:bg-gray-800" placeholder="Idioma Nativo" required />
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded">Crear y seleccionar</button>
                            <button type="button" id="modal-cancel" class="bg-gray-200 dark:bg-gray-800 px-4 py-2 rounded">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación para Seleccionar Niño -->
    <div id="modal-confirmacion-seleccion" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-900 rounded-xl w-11/12 md:w-1/3 lg:w-1/4 p-6 animate-fade-in">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Confirmar selección</h3>
                <button id="modal-confirmacion-close" class="text-gray-500 dark:text-gray-300">✕</button>
            </div>
            <p id="texto-confirmacion-seleccion" class="text-gray-700 dark:text-gray-300 mb-4">
                ¿Estás seguro de que deseas seleccionar a este niño?
            </p>
            <div class="flex justify-end gap-2">
                <button id="btn-cancelar-seleccion"
                    class="px-4 py-2 bg-gray-200 dark:bg-gray-800 rounded-lg text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-700 transition-all">
                    Cancelar
                </button>
                <button id="btn-confirmar-seleccion"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-semibold flex items-center gap-2 transition-all">
                    <i class="fas fa-check"></i>
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('modal-seleccion-nino');
            const modalClose = document.getElementById('modal-close');
            const modalCancel = document.getElementById('modal-cancel');
            const formCrear = document.getElementById('form-crear-nino-modal');

            // Abrir modal desde botones con clase .btn-abrir-seleccion
            document.querySelectorAll('.btn-abrir-seleccion').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    modal.dataset.gameUrl = btn.getAttribute('data-game-url');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                });
            });

            function closeModal() {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            modalClose.addEventListener('click', closeModal);
            modalCancel.addEventListener('click', closeModal);

            formCrear.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(formCrear);
                fetch('{% url "games:crear_nino_ajax" %}', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                }).then(r => r.json())
                .then((data) => {
                    if (data.success) {
                        const gameUrl = modal.dataset.gameUrl || '/';
                        window.location.href = `${gameUrl}?nino_id=${data.nino.id}`;
                    } else {
                        alert('Error al crear niño: ' + (data.error || JSON.stringify(data.errors)));
                    }
                })
                .catch((err) => {
                    console.error(err);
                    alert('Error en la petición');
                });
            });

            // Manejar la selección de un niño existente con confirmación
            document.getElementById('lista-ninos-modal').addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON' && e.target.classList.contains('seleccionar-nino-btn')) {
                    e.preventDefault();

                    const ninoId = e.target.getAttribute('data-nino-id');
                    const ninoNombre = e.target.closest('li').querySelector('span').innerText;

                    // Mostrar el modal de confirmación
                    const modalConfirmacion = document.getElementById('modal-confirmacion-seleccion');
                    const textoConfirmacion = document.getElementById('texto-confirmacion-seleccion');
                    textoConfirmacion.textContent = `¿Estás seguro de que deseas seleccionar a ${ninoNombre}?`;
                    modalConfirmacion.classList.remove('hidden');
                    modalConfirmacion.classList.add('flex');

                    // Botones del modal
                    const btnCancelar = document.getElementById('btn-cancelar-seleccion');
                    const btnConfirmar = document.getElementById('btn-confirmar-seleccion');

                    // Cancelar selección
                    btnCancelar.onclick = () => {
                        modalConfirmacion.classList.add('hidden');
                        modalConfirmacion.classList.remove('flex');
                    };

                    // Confirmar selección
                    btnConfirmar.onclick = () => {
                        const gameUrl = document.getElementById('modal-seleccion-nino').dataset.gameUrl || '/games/game-list';
                        const urlConParametros = `${gameUrl}?nino_id=${ninoId}`;
                        window.location.href = urlConParametros;
                    };

                    // Cerrar modal
                    document.getElementById('modal-confirmacion-close').onclick = () => {
                        modalConfirmacion.classList.add('hidden');
                        modalConfirmacion.classList.remove('flex');
                    };
                }
            });

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
</body>
</html>