{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load dashboard_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<!-- Estilos espec√≠ficos para el dashboard -->
<style>
    .chart-bar {
        animation: slideUp 0.8s ease-out forwards;
        transform: translateY(100%);
    }
    
    @keyframes slideUp {
        to {
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="p-8">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <!-- T√≠tulo -->
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{% trans "Panel Administrativo" %}</h1>
                <p class="text-gray-600 dark:text-gray-400">{% trans "Resumen de actividades y rendimiento" %}</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Column 1 -->
            <div class="space-y-6">
                <!-- Training Analysis Card -->
                <div class="w-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl transition-colors duration-200">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "An√°lisis de Sesiones de Juegos" %}</h3>
                        </div>
                    </div>
                    <hr class="bg-gray-400 dark:bg-gray-700 my-4">

                    <!-- Content -->
                    <div class="flex items-end justify-between">
                        <!-- Left Side Info -->
                        <div class="space-y-4">
                            <div>
                                <p class="text-lg font-bold text-gray-900 dark:text-white">{{ total_sesiones_mes }} {% trans "sesiones" %}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "Completadas este mes" %}</p>
                            </div>

                            <!-- Attendees -->
                            <div class="flex items-center gap-2">
                                <div class="flex -space-x-2">
                                    {% if ninos_participantes %}
                                        {% for nino in ninos_participantes %}
                                            {% if nino.imagen %}
                                                <img src="{{ nino.imagen.url }}" alt="{{ nino.nombre_completo }}"
                                                    class="w-7 h-7 rounded-full border-2 border-white dark:border-gray-900 object-cover"
                                                    title="{{ nino.nombre_completo }}">
                                            {% else %}
                                                <img src="https://i.pravatar.cc/150?img={{ forloop.counter|add:10 }}" alt="{{ nino.nombre_completo }}"
                                                    class="w-7 h-7 rounded-full border-2 border-white dark:border-gray-900 object-cover"
                                                    title="{{ nino.nombre_completo }}">
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png" alt="user1"
                                            class="w-7 h-7 rounded-full border-2 border-white dark:border-gray-900 object-cover">
                                        <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png" alt="user2"
                                            class="w-7 h-7 rounded-full border-2 border-white dark:border-gray-900 object-cover">
                                        <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png" alt="user3"
                                            class="w-7 h-7 rounded-full border-2 border-white dark:border-gray-900 object-cover">
                                    {% endif %}
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    {{ ninos_participantes_mes }} {% trans "ni√±os participaron" %}
                                </p>
                            </div>
                        </div>

                        <!-- Graph -->
                        <div class="flex gap-1.5 items-end h-24">
                            <div class="chart-bar w-3 bg-purple-400 dark:bg-purple-500 rounded-t"
                                style="height: 60%; animation-delay: 0s;"></div>
                            <div class="chart-bar w-3 bg-purple-500 dark:bg-purple-600 rounded-t"
                                style="height: 75%; animation-delay: 0.1s;"></div>
                            <div class="chart-bar w-3 bg-purple-400 dark:bg-purple-500 rounded-t"
                                style="height: 55%; animation-delay: 0.2s;"></div>
                            <div class="chart-bar w-3 bg-purple-500 dark:bg-purple-600 rounded-t"
                                style="height: 85%; animation-delay: 0.3s;"></div>
                            <div class="chart-bar w-3 bg-purple-400 dark:bg-purple-500 rounded-t"
                                style="height: 70%; animation-delay: 0.4s;"></div>
                            <div class="chart-bar w-3 bg-purple-500 dark:bg-purple-600 rounded-t"
                                style="height: 95%; animation-delay: 0.5s;"></div>
                            <div class="chart-bar w-3 bg-purple-400 dark:bg-purple-500 rounded-t"
                                style="height: 65%; animation-delay: 0.6s;"></div>
                        </div>
                    </div>
                </div>

                <!-- Tarjeta de Progreso del Curso -->
                <div class="w-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl transition-colors duration-200">
                    <!-- Encabezado -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "Progreso en Intervenci√≥n de Dislexia" %}</h3>
                        </div>
                    </div>
                    <hr class="bg-gray-400 dark:bg-gray-700 my-4">

                    <!-- Contenido -->
                    <div class="flex items-start gap-4">
                        <!-- Progreso Radial -->
                        <div class="relative w-20 h-20 flex-shrink-0">
                            <svg class="w-full h-full -rotate-90">
                                <!-- C√≠rculo de fondo -->
                                <circle class="text-gray-200 dark:text-gray-700" stroke-width="8" stroke="currentColor" fill="transparent"
                                    r="36" cx="40" cy="40" />
                                <!-- C√≠rculo de progreso -->
                                {% with progreso_decimal=progreso_promedio|div:100 %}
                                {% with offset=226.19|mul:progreso_decimal|sub:226.19|abs_value|floatformat:2 %}
                                <circle class="text-purple-500 dark:text-purple-600" stroke-width="8" stroke-dasharray="226.19"
                                    stroke-dashoffset="{{ offset }}" stroke-linecap="round" stroke="currentColor"
                                    fill="transparent" r="36" cx="40" cy="40"
                                    style="transition: stroke-dashoffset 0.5s ease;" />
                                {% endwith %}
                                {% endwith %}
                            </svg>
                            <span class="absolute inset-0 flex items-center justify-center text-xl font-bold text-gray-900 dark:text-white">{{ progreso_promedio|floatformat:0 }}%</span>
                        </div>

                        <!-- Texto del Curso -->
                        <div class="flex-1 min-w-0">
                            <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-1">{% trans "Programa de Intervenci√≥n Temprana" %}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2 leading-relaxed">{% trans "Dise√±ado para identificar y apoyar a ni√±os con dificultades de lectura desde temprana edad." %}</p>
                        </div>
                    </div>
                </div>

                <!-- Employee Spotlight Card -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6 shadow-sm transition-colors duration-200">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                            </svg>
                            <h3 class="font-semibold text-gray-900 dark:text-white text-base">{% trans "Destacados del Equipo" %}</h3>
                        </div>
                    </div>

                    <!-- Filter Bar -->
                    <div class="flex items-center gap-3 mb-5">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-gray-900 dark:text-white">{% trans "Vista General" %}</span>
                        </div>
                        <div class="flex-1 relative">
                            <input 
                                type="text" 
                                id="search-reportes"
                                placeholder="{% trans 'Buscar paciente...' %}"
                                class="w-full px-4 py-2 pl-10 text-sm bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 dark:focus:ring-purple-400">
                            <svg class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                    </div>

                    <!-- Reports List -->
                    <div id="reportes-list" class="space-y-4 min-h-[200px]">
                        {% if reportes_ia %}
                            {% for reporte in reportes_ia %}
                                <div class="reporte-item flex items-start gap-3" data-nombre="{{ reporte.evaluacion.nino.nombre_completo|lower }}" data-index="{{ forloop.counter0 }}">
                                    {% if reporte.evaluacion.nino.imagen %}
                                        <img src="{{ reporte.evaluacion.nino.imagen.url }}" alt="{{ reporte.evaluacion.nino.nombre_completo }}"
                                            class="w-11 h-11 rounded-full flex-shrink-0 object-cover"
                                            title="{{ reporte.evaluacion.nino.nombre_completo }}">
                                    {% else %}
                                        <img src="https://i.pravatar.cc/150?img={{ forloop.counter|add:20 }}" alt="{{ reporte.evaluacion.nino.nombre_completo }}"
                                            class="w-11 h-11 rounded-full flex-shrink-0 object-cover"
                                            title="{{ reporte.evaluacion.nino.nombre_completo }}">
                                    {% endif %}
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-gray-900 dark:text-white mb-0.5">{{ reporte.evaluacion.nino.nombre_completo }}</p>
                                        <p class="text-sm text-gray-700 dark:text-gray-300">
                                            {% if reporte.clasificacion_riesgo == 'bajo' %}
                                                ‚úÖ {% trans "Bajo riesgo - Seguimiento regular" %}
                                            {% elif reporte.clasificacion_riesgo == 'medio' %}
                                                ‚ö†Ô∏è {% trans "Riesgo medio - Requiere atenci√≥n" %}
                                            {% else %}
                                                üî¥ {% trans "Alto riesgo - Intervenci√≥n urgente" %}
                                            {% endif %}
                                        </p>
                                    </div>
                                    <button class="{% if reporte.clasificacion_riesgo == 'bajo' %}text-green-500 hover:text-green-600{% elif reporte.clasificacion_riesgo == 'medio' %}text-orange-500 hover:text-orange-600{% else %}text-red-500 hover:text-red-600{% endif %} flex-shrink-0 mt-1">
                                        <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20">
                                            <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" />
                                        </svg>
                                    </button>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "No hay reportes recientes" %}</p>
                        {% endif %}
                        <!-- Mensaje cuando no hay resultados de b√∫squeda -->
                        <p id="no-results-message" class="hidden text-sm text-gray-500 dark:text-gray-400 text-center py-4">
                            {% trans "No se encontraron pacientes con ese nombre" %}
                        </p>
                    </div>

                    <!-- Pagination Controls -->
                    {% if reportes_ia %}
                    <div id="pagination-controls" class="flex items-center justify-between pt-2 border-t border-gray-200 dark:border-gray-700">
                        <button id="prev-page" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                            {% trans "Anterior" %}
                        </button>
                        
                        <div class="flex items-center gap-2">
                            <span id="page-info" class="text-sm text-gray-600 dark:text-gray-400">
                                <span id="current-page">1</span> / <span id="total-pages">1</span>
                            </span>
                        </div>

                        <button id="next-page" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            {% trans "Siguiente" %}
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Column 2 -->
            <div class="space-y-6">
                <!-- Time Tracker Card -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6 transition-colors duration-200">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "Rastreador de Tiempo" %}</h3>
                        </div>
                    </div>
                    <hr class="bg-gray-400 dark:bg-gray-700 my-4">

                    <!-- Timer Display -->
                    <div class="text-center mb-6">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">{% trans "Tiempo Total Este Mes" %}</p>
                        <div class="flex items-center justify-center gap-2 mb-4">
                            <span class="text-5xl font-bold text-gray-900 dark:text-white">{{ tiempo_total_horas|stringformat:"02d" }}</span>
                            <span class="text-3xl font-bold text-gray-400 dark:text-gray-600">:</span>
                            <span class="text-5xl font-bold text-gray-900 dark:text-white">{{ tiempo_total_minutos|stringformat:"02d" }}</span>
                            <span class="text-3xl font-bold text-gray-400 dark:text-gray-600">:</span>
                            <span class="text-5xl font-bold text-gray-900 dark:text-white">{{ tiempo_total_segs|stringformat:"02d" }}</span>
                        </div>
                        <div class="flex justify-center">
                            <a href="{% url 'games:session_list' %}"
                            class="inline-flex items-center gap-2 text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 text-sm font-medium text-center">
                                <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z" />
                                </svg>
                                {% trans "Ver Estad√≠sticas Detalladas" %}
                            </a>
                        </div>
                    </div>

                    <!-- Previous Tasks -->
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-5">
                        <p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-4">{% trans "Sesiones Recientes" %}</p>

                        <div class="space-y-4">
                            {% if ultimas_sesiones %}
                                {% for sesion in ultimas_sesiones %}
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 {% cycle 'bg-purple-100 dark:bg-purple-900/30' 'bg-yellow-100 dark:bg-yellow-900/30' 'bg-green-100 dark:bg-green-900/30' %} rounded-lg flex items-center justify-center flex-shrink-0">
                                            <svg class="w-5 h-5 {% cycle 'text-purple-600 dark:text-purple-400' 'text-yellow-600 dark:text-yellow-400' 'text-green-600 dark:text-green-400' %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-semibold text-gray-900 dark:text-white">{{ sesion.juego.nombre }}</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ sesion.evaluacion.nino.nombre_completo }} ‚Ä¢ {{ sesion.tiempo_total_segundos|format_duration }}</p>
                                        </div>
                                        <button class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-400">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                                            </svg>
                                        </button>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">{% trans "No hay sesiones recientes" %}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Notes Card -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6 transition-colors duration-200">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "Estad√≠sticas de Pacientes" %}</h3>
                        </div>
                        <a href="{% url 'core:lista_ninos' %}" class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                            {% trans "Ver todos" %}
                        </a>
                    </div>

                    <!-- Stats Content -->
                    <div class="space-y-6">
                        <!-- Total Pacientes -->
                        <div class="bg-gradient-to-br from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">{% trans "Total de Pacientes Registrados" %}</p>
                                    <p class="text-4xl font-bold text-purple-600 dark:text-purple-400">{{ total_pacientes }}</p>
                                </div>
                                <div class="w-16 h-16 bg-purple-100 dark:bg-purple-900/40 rounded-full flex items-center justify-center">
                                    <svg class="w-8 h-8 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Pacientes Activos Este Mes -->
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">{% trans "Pacientes Activos Este Mes" %}</p>
                                    <p class="text-4xl font-bold text-green-600 dark:text-green-400">{{ pacientes_activos_mes }}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{% trans "Con sesiones completadas" %}</p>
                                </div>
                                <div class="w-16 h-16 bg-green-100 dark:bg-green-900/40 rounded-full flex items-center justify-center">
                                    <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Tasa de Participaci√≥n -->
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-medium text-gray-700 dark:text-gray-300">{% trans "Tasa de Participaci√≥n Mensual" %}</p>
                                {% if total_pacientes > 0 %}
                                    <span class="text-sm font-bold text-blue-600 dark:text-blue-400">
                                        {{ pacientes_activos_mes|floatformat:0 }}/{{ total_pacientes }} ({% widthratio pacientes_activos_mes total_pacientes 100 %}%)
                                    </span>
                                {% else %}
                                    <span class="text-sm font-bold text-gray-400">0%</span>
                                {% endif %}
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                {% if total_pacientes > 0 %}
                                    <div class="bg-blue-600 dark:bg-blue-500 h-2.5 rounded-full transition-all duration-500" 
                                        style="width: {% widthratio pacientes_activos_mes total_pacientes 100 %}%"></div>
                                {% else %}
                                    <div class="bg-gray-400 h-2.5 rounded-full" style="width: 0%"></div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Column 3 -->
            <div class="space-y-6">
                <!-- Team Performance Card -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6 transition-colors duration-200">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "Rendimiento del Equipo" %}</h3>
                        </div>
                    </div>
                    <hr class="bg-gray-400 dark:bg-gray-700 my-4">

                    <!-- Summary Stats -->
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ profesionales|length }}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">{% trans "Profesionales" %}</p>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold text-green-600 dark:text-green-400">{{ total_sesiones_mes }}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">{% trans "Sesiones" %}</p>
                        </div>
                        <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{ total_pacientes }}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">{% trans "Pacientes" %}</p>
                        </div>
                    </div>

                    <!-- Team Members Performance -->
                    <div class="space-y-5">
                        {% if profesionales_con_metricas %}
                            {% for prof_data in profesionales_con_metricas %}
                                <div class="border-b border-gray-100 dark:border-gray-800 pb-4 last:border-0 last:pb-0">
                                    <!-- Professional Info -->
                                    <div class="flex items-center gap-3 mb-3">
                                        {% if prof_data.profesional.imagen %}
                                            <img src="{{ prof_data.profesional.imagen.url }}" alt="{{ prof_data.profesional.nombre_completo }}"
                                                class="w-10 h-10 rounded-full object-cover">
                                        {% else %}
                                            <img src="https://i.pravatar.cc/150?img={{ forloop.counter }}" alt="{{ prof_data.profesional.nombre_completo }}"
                                                class="w-10 h-10 rounded-full object-cover">
                                        {% endif %}
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-semibold text-gray-900 dark:text-white">{{ prof_data.profesional.nombre_completo }}</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">{{ prof_data.profesional.especialidad|default:"Profesional" }}</p>
                                        </div>
                                        <!-- Status Badge -->
                                        {% if prof_data.profesional.ultimo_acceso %}
                                            {% now "U" as current_timestamp %}
                                            {% with time_diff=current_timestamp|sub:prof_data.profesional.ultimo_acceso.timestamp %}
                                                {% if time_diff < 3600 %}
                                                    <span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 text-xs font-medium rounded-full">{% trans "Activo" %}</span>
                                                {% else %}
                                                    <span class="px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 text-xs font-medium rounded-full">{% trans "Ausente" %}</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 text-xs font-medium rounded-full">{% trans "Ausente" %}</span>
                                        {% endif %}
                                    </div>

                                    <!-- Metrics Grid -->
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <div class="text-center">
                                            <p class="text-lg font-bold text-gray-900 dark:text-white">{{ prof_data.pacientes_asignados }}</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">{% trans "Pacientes" %}</p>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-lg font-bold text-gray-900 dark:text-white">{{ prof_data.sesiones_supervisadas }}</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">{% trans "Sesiones" %}</p>
                                        </div>
                                        <div class="text-center">
                                            <p class="text-lg font-bold text-gray-900 dark:text-white">{{ prof_data.reportes_generados }}</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">{% trans "Reportes" %}</p>
                                        </div>
                                    </div>

                                    <!-- Workload Bar -->
                                    <div>
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "Carga de trabajo" %}</span>
                                            <span class="text-xs font-semibold text-gray-900 dark:text-white">{{ prof_data.porcentaje_carga }}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                            {% if prof_data.porcentaje_carga >= 80 %}
                                                <div class="bg-red-500 h-2 rounded-full transition-all duration-500" style="width: {{ prof_data.porcentaje_carga }}%"></div>
                                            {% elif prof_data.porcentaje_carga >= 50 %}
                                                <div class="bg-orange-500 h-2 rounded-full transition-all duration-500" style="width: {{ prof_data.porcentaje_carga }}%"></div>
                                            {% else %}
                                                <div class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: {{ prof_data.porcentaje_carga }}%"></div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">{% trans "No hay profesionales registrados" %}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Upcoming Appointments Card -->
                <div class="bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6 transition-colors duration-200">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "Pr√≥ximas Citas" %}</h3>
                        </div>
                        <a href="{% url 'core:calendar' %}" class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white px-3 py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                            {% trans "Ver calendario" %}
                        </a>
                    </div>
                    <hr class="bg-gray-400 dark:bg-gray-700 my-4">

                    <!-- Appointments List -->
                    <div class="space-y-4">
                        {% if citas %}
                            {% for cita in citas %}
                                <div class="border-l-4 {% if cita.completada %}border-green-500{% else %}{% now "Y-m-d" as today %}{% if cita.fecha|date:"Y-m-d" == today %}border-red-500{% else %}border-blue-500{% endif %}{% endif %} bg-gray-50 dark:bg-gray-800/50 rounded-r-lg p-4 hover:shadow-md transition-shadow">
                                    <!-- Appointment Header -->
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex-1">
                                            <h4 class="text-sm font-bold text-gray-900 dark:text-white mb-1">{{ cita.nombre_paciente }}</h4>
                                            <p class="text-xs text-gray-600 dark:text-gray-400">{{ cita.notas|default:"Cita de seguimiento"|truncatewords:10 }}</p>
                                        </div>
                                        {% if cita.completada %}
                                            <span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 text-xs font-medium rounded-full flex items-center gap-1">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                                </svg>
                                                {% trans "Completada" %}
                                            </span>
                                        {% else %}
                                            {% now "Y-m-d" as today %}
                                            {% if cita.fecha|date:"Y-m-d" == today %}
                                                <span class="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-xs font-medium rounded-full flex items-center gap-1">
                                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                                    </svg>
                                                    {% trans "Hoy" %}
                                                </span>
                                            {% else %}
                                                <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-xs font-medium rounded-full">
                                                    {% trans "Pendiente" %}
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                    </div>

                                    <!-- Date & Time -->
                                    <div class="flex items-center gap-4 mt-3">
                                        <div class="flex items-center gap-2">
                                            <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                            <span class="text-xs font-medium text-gray-700 dark:text-gray-300">{{ cita.fecha|date:"d/m/Y" }}</span>
                                        </div>
                                        {% if cita.hora %}
                                        <div class="flex items-center gap-2">
                                            <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <span class="text-xs font-medium text-gray-700 dark:text-gray-300">{{ cita.hora|time:"H:i" }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <!-- Empty State -->
                            <div class="text-center py-8">
                                <svg class="w-16 h-16 mx-auto text-gray-300 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">{% trans "No hay citas programadas" %}</p>
                                <p class="text-xs text-gray-400 dark:text-gray-500 mb-4">{% trans "Las pr√≥ximas citas aparecer√°n aqu√≠" %}</p>
                                <a href="{% url 'core:calendar' %}" class="inline-flex items-center gap-2 text-sm text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 font-medium">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                    {% trans "Crear nueva cita" %}
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_scripts %}
<!-- Scripts espec√≠ficos para el dashboard -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Animaci√≥n de las barras del gr√°fico
        const chartBars = document.querySelectorAll('.chart-bar');
        chartBars.forEach((bar, index) => {
            setTimeout(() => {
                bar.style.animationDelay = `${index * 0.1}s`;
            }, 100);
        });
        
        // Manejo de checkboxes en las notas
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const parent = this.closest('.flex');
                if (this.checked) {
                    parent.querySelector('.font-semibold').style.textDecoration = 'line-through';
                    parent.style.opacity = '0.7';
                } else {
                    parent.querySelector('.font-semibold').style.textDecoration = 'none';
                    parent.style.opacity = '1';
                }
            });
        });

        // Sistema de paginaci√≥n de reportes
        const itemsPerPage = 3;
        let currentPage = 1;
        let filteredItems = [];
        
        const reportesList = document.getElementById('reportes-list');
        const allReporteItems = document.querySelectorAll('.reporte-item');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        const currentPageSpan = document.getElementById('current-page');
        const totalPagesSpan = document.getElementById('total-pages');
        const paginationControls = document.getElementById('pagination-controls');
        const searchInput = document.getElementById('search-reportes');
        const noResultsMessage = document.getElementById('no-results-message');

        function updatePagination() {
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            
            // Ocultar controles si no hay suficientes items
            if (paginationControls) {
                paginationControls.style.display = filteredItems.length > itemsPerPage ? 'flex' : 'none';
            }
            
            // Ocultar todos los items primero
            allReporteItems.forEach(item => {
                item.style.display = 'none';
            });
            
            // Mostrar solo los items de la p√°gina actual
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const itemsToShow = filteredItems.slice(start, end);
            
            itemsToShow.forEach(item => {
                item.style.display = 'flex';
            });
            
            // Actualizar informaci√≥n de p√°gina
            if (currentPageSpan) currentPageSpan.textContent = filteredItems.length > 0 ? currentPage : 0;
            if (totalPagesSpan) totalPagesSpan.textContent = totalPages;
            
            // Habilitar/deshabilitar botones
            if (prevButton) {
                prevButton.disabled = currentPage === 1;
            }
            if (nextButton) {
                nextButton.disabled = currentPage >= totalPages;
            }
            
            // Mostrar mensaje de no resultados
            if (noResultsMessage) {
                if (filteredItems.length === 0 && searchInput && searchInput.value.trim() !== '') {
                    noResultsMessage.classList.remove('hidden');
                } else {
                    noResultsMessage.classList.add('hidden');
                }
            }
        }

        function filterItems(searchTerm = '') {
            searchTerm = searchTerm.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredItems = Array.from(allReporteItems);
            } else {
                filteredItems = Array.from(allReporteItems).filter(item => {
                    const nombre = item.getAttribute('data-nombre');
                    return nombre.includes(searchTerm);
                });
            }
            
            currentPage = 1; // Reset a la primera p√°gina
            updatePagination();
        }

        // Inicializar con todos los items
        filterItems();

        // Navegaci√≥n de p√°ginas
        if (prevButton) {
            prevButton.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    updatePagination();
                }
            });
        }

        if (nextButton) {
            nextButton.addEventListener('click', function() {
                const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    updatePagination();
                }
            });
        }

        // Filtro de b√∫squeda
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                filterItems(this.value);
            });
        }
        
        console.log('Dashboard cargado correctamente');
    });
</script>
{% endblock %}