{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Reporte de Evaluaci√≥n de Dislexia</title>

    <style>
        /* === ESTILOS ID√âNTICOS AL PDF DE LIAN === */
        
        @page {
            size: a4 portrait;
            margin: 2.2cm 1.5cm 2cm 1.5cm;
        }

        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 9pt;
            color: #000000;
            background-color: #ffffff;
            line-height: 1.5;
            padding: 0;
            margin: 0;
        }

        /* Header */
        .page-header {
            text-align: center;
            padding-bottom: 0;
            margin-bottom: 15px;
        }

        .page-header .header-text {
            color: #000000;
            font-size: 11pt;
            font-weight: bold;
        }

        /* T√≠tulos */
        h1 {
            font-size: 14px;
            font-weight: bold;
            color: #000000;
            margin: 0 0 2px 0;
            padding: 0;
            text-transform: uppercase;
        }

        h2 {
            font-size: 9.5px;
            font-weight: bold;
            color: #000000;
            margin: 22px 0 12px 0;
            padding: 0;
            text-transform: uppercase;
        }

        /* Tablas */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        table td, table th {
            padding: 0;
            vertical-align: top;
        }

        /* Info rows */
        .info-table td {
            padding: 6px 0 6px 0;
            font-size: 9pt;
            line-height: 1.4;
        }

        .info-table td:first-child {
            width: 43%;
            font-weight: normal;
            color: #000000;
        }

        .info-table td:last-child {
            font-weight: normal;
            color: #000000;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 9px;
            font-size: 8pt;
            font-weight: bold;
            text-transform: uppercase;
        }

        .badge-alto {
            background: #e74c3c;
            color: white;
        }

        .badge-medio {
            background: #f39c12;
            color: white;
        }

        .badge-bajo {
            background: #27ae60;
            color: white;
        }

        .badge-success {
            background: #27ae60;
            color: white;
        }

        .badge-no {
            background: #e74c3c;
            color: white;
        }

        /* Cajas de contenido */
        .content-box {
            background-color: #f7f7f7;
            padding: 11px 13px;
            margin: 12px 0 15px 0;
        }

        .content-box-title {
            font-size: 7.5pt;
            font-weight: bold;
            color: #666666;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .content-box-text {
            font-size: 9pt;
            color: #000000;
            line-height: 1.5;
        }

        /* M√©tricas */
        .metrics-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 20px 0;
            margin: 18px 0 18px 0;
        }

        .metrics-table td {
            background: #ffffff;
            padding: 0;
            text-align: center;
            width: 33.33%;
        }

        .metric-label {
            font-size: 7pt;
            font-weight: bold;
            text-transform: uppercase;
            color: #999999;
            margin-bottom: 10px;
            display: block;
        }

        .metric-value {
            font-size: 26px;
            font-weight: bold;
            margin-bottom: 0;
            display: block;
            line-height: 1;
        }

        .metric-value-purple { color: #7c3aed; }
        .metric-value-blue { color: #2563eb; }
        .metric-value-green { color: #16a34a; }

        /* Cajas informativas */
        .info-box {
            background-color: #f7f7f7;
            padding: 11px 13px;
            margin: 12px 0;
            font-size: 9pt;
            line-height: 1.5;
        }

        .info-box-title {
            font-weight: normal;
            margin-bottom: 6px;
            color: #000000;
            font-size: 9pt;
        }

        .warning-box {
            background-color: #fffdf5;
        }

        .pending-box {
            background-color: #fff8e1;
            padding: 10px 13px;
            font-size: 9pt;
            color: #856404;
            text-align: center;
        }

        .validation-box {
            background-color: #f7f7f7;
            padding: 13px;
            margin-bottom: 15px;
        }

        /* Tabla de juegos */
        .games-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8pt;
            margin-top: 10px;
        }

        .games-table thead tr {
            background: #ffffff;
            border-bottom: 1px solid #000000;
        }

        .games-table th {
            padding: 8px 5px 8px 5px;
            text-align: left;
            font-weight: bold;
            color: #000000;
            text-transform: uppercase;
            font-size: 7pt;
        }

        .games-table tbody td {
            padding: 10px 5px 10px 5px;
            font-size: 8.5pt;
        }

        .games-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
        }

        .games-table tbody tr:last-child {
            border-bottom: none;
        }

        .game-name {
            font-weight: bold;
            color: #000000;
            display: block;
            margin-bottom: 3px;
            font-size: 8.5pt;
        }

        .game-meta {
            font-size: 7.5pt;
            color: #666666;
        }

        /* Colores de texto */
        .text-success { color: #16a34a; font-weight: bold; }
        .text-error { color: #dc2626; font-weight: bold; }
        .text-neutral { color: #666666; font-weight: bold; }

        /* Secci√≥n de firma */
        .signature-section {
            text-align: center;
            margin: 30px 0 20px 0;
        }

        .signature-line {
            border-top: 2px solid #000000;
            width: 280px;
            margin: 0 auto 12px auto;
        }

        .signature-name {
            font-size: 10.5pt;
            font-weight: bold;
            color: #000000;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .signature-id {
            font-size: 9pt;
            color: #666666;
            margin-bottom: 3px;
        }

        .signature-title {
            font-size: 9pt;
            font-weight: bold;
            color: #000000;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .signature-org {
            font-size: 8.5pt;
            color: #666666;
            font-style: italic;
        }

        /* Disclaimer */
        .disclaimer-final {
            background-color: #f7f7f7;
            padding: 11px 13px;
            margin: 18px 0;
            font-size: 7pt;
            color: #444444;
            line-height: 1.4;
            text-align: justify;
        }

        .disclaimer-final-title {
            font-weight: bold;
            color: #000000;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        /* Letterhead */
        .letterhead {
            border-bottom: 1px solid #000000;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .letterhead-table td {
            vertical-align: top;
            padding: 0;
        }

        .letterhead-subtitle {
            font-size: 8pt;
            color: #666666;
            margin-top: 3px;
        }

        .letterhead-info {
            font-size: 7.5pt;
            color: #666666;
            line-height: 1.5;
        }

        .letterhead-info div {
            margin-bottom: 2px;
        }

        /* Footer */
        .footer-section {
            width: 100%;
            border-collapse: collapse;
            font-size: 7pt;
            color: #666666;
            border-top: 1px solid #d0d0d0;
            padding-top: 10px;
            margin-top: 28px;
        }

        .footer-section td {
            padding: 2px 0;
            vertical-align: top;
        }

        .footer-title {
            font-weight: bold;
            color: #000000;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        /* Descripci√≥n */
        .game-description {
            font-size: 8pt;
            color: #666666;
            margin-top: 5px;
            margin-bottom: 8px;
        }

        /* Forzar colores */
        * {
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
            print-color-adjust: exact;
        }

        /* Prevenir saltos */
        .content-box, .info-box, .signature-section, .validation-box {
            page-break-inside: avoid;
        }

        h2 {
            page-break-after: avoid;
        }

        /* Ajuste de espaciado en validaci√≥n */
        .validation-box .info-table td {
            padding: 7px 0;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="page-header">
        <span class="header-text">Dislexia IA</span>
    </div>

    <!-- Letterhead -->
    <div class="letterhead">
        <table class="letterhead-table">
            <tr>
                <td style="width: 65%;">
                    <h1>DISLEXIA IA</h1>
                    <div class="letterhead-subtitle">
                        Sistema Inteligente de Evaluaci√≥n y Detecci√≥n de Dislexia
                    </div>
                </td>
                <td style="text-align: right; width: 35%;">
                    <div class="letterhead-info">
                        <div><strong>Reporte ID:</strong> DIA-{{ game_session.id|stringformat:"04d" }}-{{ nino.id|stringformat:"03d" }}</div>
                        <div><strong>Fecha:</strong> {{ game_session.fecha_hora_inicio|date:"d/m/Y H:i" }}</div>
                        <div><strong>Generado:</strong> {% now "d/m/Y H:i" %}</div>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <!-- Resumen Ejecutivo -->
    <h2>RESUMEN EJECUTIVO</h2>
    <table class="info-table">
        <tr>
            <td>Paciente:</td>
            <td><strong>{{ nino.nombre_completo }}</strong></td>
        </tr>
        <tr>
            <td>Fecha de Nacimiento:</td>
            <td>{{ nino.fecha_nacimiento|date:"d/m/Y" }}</td>
        </tr>
        <tr>
            <td>Edad:</td>
            <td>{{ nino.edad }} a√±os</td>
        </tr>
        <tr>
            <td>Profesional Responsable:</td>
            <td>{{ game_session.nino.profesional.nombre_completo }}</td>
        </tr>
        <tr>
            <td>Estado del An√°lisis:</td>
            <td>
                {% with risk_display=reporte.get_clasificacion_riesgo_display %}
                {% if risk_display == "alto" %}
                <span class="badge badge-alto">RIESGO ALTO</span>
                {% elif risk_display == "medio" %}
                <span class="badge badge-medio">RIESGO MEDIO</span>
                {% else %}
                <span class="badge badge-bajo">RIESGO BAJO</span>
                {% endif %}
                {% endwith %}
            </td>
        </tr>
        <tr>
            <td>√çndice de Riesgo:</td>
            <td><strong>{{ reporte.indice_riesgo|floatformat:1 }}%</strong></td>
        </tr>
        <tr>
            <td>Confianza del Modelo:</td>
            <td>{{ reporte.confianza_prediccion }}%</td>
        </tr>
    </table>

    <div class="content-box">
        <div class="content-box-title">RECOMENDACIONES PROFESIONALES</div>
        <div class="content-box-text">{{ reporte.recomendaciones|linebreaksbr }}</div>
    </div>

    <!-- 1. An√°lisis con IA -->
    <h2>1. AN√ÅLISIS CON INTELIGENCIA ARTIFICIAL</h2>
    
    <table class="metrics-table">
        <tr>
            <td>
                <span class="metric-label">√çNDICE DE RIESGO</span>
                <span class="metric-value metric-value-purple">{{ reporte.indice_riesgo|floatformat:1 }}%</span>
            </td>
            <td>
                <span class="metric-label">CONFIANZA DEL MODELO</span>
                <span class="metric-value metric-value-blue">{{ reporte.confianza_prediccion }}%</span>
            </td>
            <td>
                <span class="metric-label">PRECISI√ìN GENERAL</span>
                <span class="metric-value metric-value-green">{{ game_session.precision_promedio|floatformat:1 }}%</span>
            </td>
        </tr>
    </table>

    <div class="info-box">
        <div class="info-box-title">üí° <strong>Recomendaciones Profesionales</strong></div>
        <div>{{ reporte.recomendaciones|linebreaksbr }}</div>
    </div>

    <div class="info-box warning-box">
        <div class="info-box-title">‚ö† <strong>Aviso Importante</strong></div>
        <div>Este an√°lisis es una herramienta de apoyo basada en inteligencia artificial y NO constituye un diagn√≥stico m√©dico oficial. Los resultados deben ser interpretados por un profesional de la salud calificado.</div>
    </div>

    <!-- 2. Validaci√≥n Profesional -->
    <h2>2. VALIDACI√ìN DEL PROFESIONAL</h2>
    {% if reporte.validacion_profesional %}
    <div class="validation-box">
        <div style="margin-bottom: 15px;">
            <span class="badge badge-success">‚úì VALIDACI√ìN REALIZADA</span>
        </div>
        
        <table class="info-table">
            {% if reporte.validacion_profesional.indice_ajustado is not None %}
            <tr>
                <td>√çndice de Riesgo Ajustado:</td>
                <td><strong>{{ reporte.validacion_profesional.indice_ajustado|floatformat:2 }}%</strong></td>
            </tr>
            {% endif %}
            <tr>
                <td>Diagn√≥stico Final:</td>
                <td>{{ reporte.validacion_profesional.diagnostico_final|default:"No especificado" }}</td>
            </tr>
            <tr>
                <td>Notas Cl√≠nicas:</td>
                <td>{{ reporte.validacion_profesional.notas_clinicas|default:"No especificado" }}</td>
            </tr>
            <tr>
                <td>Plan de Tratamiento:</td>
                <td>{{ reporte.validacion_profesional.plan_tratamiento|default:"No especificado" }}</td>
            </tr>
            <tr>
                <td>Requiere Seguimiento:</td>
                <td>
                    {% if reporte.validacion_profesional.requiere_seguimiento %}
                    <span class="badge badge-success">S√ç</span>
                    {% else %}
                    <span class="badge badge-no">NO</span>
                    {% endif %}
                </td>
            </tr>
        </table>
    </div>
    {% else %}
    <div class="pending-box">
        <strong>‚ö† PENDIENTE DE VALIDACI√ìN</strong> ¬∑ Esta evaluaci√≥n a√∫n no ha sido validada por el profesional responsable.
    </div>
    {% endif %}

    <!-- 3. Rendimiento por Juego -->
    <h2>3. RENDIMIENTO POR JUEGO</h2>
    <p class="game-description">
        M√©tricas acumuladas de {{ evaluations|length }} juegos realizados
    </p>

    <table class="games-table">
        <thead>
            <tr>
                <th style="width: 30%;">JUEGO</th>
                <th style="text-align: center; width: 13%;">PUNTOS</th>
                <th style="text-align: center; width: 13%;">ACIERTOS</th>
                <th style="text-align: center; width: 13%;">ERRORES</th>
                <th style="text-align: center; width: 13%;">CLICS</th>
                <th style="text-align: right; width: 18%;">PRECISI√ìN</th>
            </tr>
        </thead>
        <tbody>
            {% for eval in evaluations %}
            <tr>
                <td>
                    <span class="game-name">{{ eval.juego__nombre }}</span>
                    <span class="game-meta">{{ eval.juego__dificultad|capfirst }} ¬∑ {{ eval.veces_jugado }}x jugado</span>
                </td>
                <td style="text-align: center; font-weight: bold;">
                    {{ eval.total_puntaje|floatformat:0 }}
                </td>
                <td style="text-align: center;">
                    <span class="text-success">{{ eval.total_aciertos|floatformat:0 }}</span>
                </td>
                <td style="text-align: center;">
                    <span class="text-error">{{ eval.total_errores|floatformat:0 }}</span>
                </td>
                <td style="text-align: center;">
                    <span class="text-neutral">{{ eval.total_clics|floatformat:0 }}</span>
                </td>
                <td style="text-align: right; font-weight: bold;">
                    {{ eval.avg_precision|floatformat:0 }}%
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- 4. Autorizaci√≥n -->
    <h2>4. AUTORIZACI√ìN Y RESPONSABILIDAD</h2>
    <div class="signature-section">
        {% if firma_data_uri %}
        <div style="margin-bottom: 12px;">
            <img src="{{ firma_data_uri }}" alt="Firma" style="max-width: 70px; height: auto;">
        </div>
        {% endif %}
        <div class="signature-line"></div>
        <div class="signature-name">{{ game_session.nino.profesional.nombre_completo }}</div>
        {% if game_session.nino.profesional.numero_cedula %}
        <div class="signature-id">C.I: {{ game_session.nino.profesional.numero_cedula }}</div>
        {% else %}
        <div class="signature-id">Profesional de la Salud</div>
        {% endif %}
        <div class="signature-title">ESPECIALISTA EN EVALUACI√ìN DE DISLEXIA</div>
        <div class="signature-org">Dislexia IA - Divisi√≥n de Evaluaci√≥n Cognitiva</div>
    </div>

    <div class="disclaimer-final">
        <div class="disclaimer-final-title">AVISO LEGAL Y LIMITACIONES</div>
        Este reporte ha sido generado mediante inteligencia artificial y algoritmos de procesamiento de datos cognitivos. Los resultados representan un an√°lisis probabil√≠stico basado en patrones detectados durante las evaluaciones realizadas. Se recomienda corroborar los resultados a trav√©s de evaluaciones adicionales y ejercer criterio profesional independiente. Dislexia IA no reemplaza el diagn√≥stico de un profesional m√©dico especializado en trastornos del aprendizaje. Este sistema es una herramienta de apoyo para profesionales de la salud y educaci√≥n.
    </div>

    <!-- Footer -->
    <table class="footer-section">
        <tr>
            <td style="width: 50%;">
                <div class="footer-title">DISLEXIA IA</div>
                <div>Sistema Inteligente de Evaluaci√≥n de Dislexia</div>
                <div>Divisi√≥n de Evaluaci√≥n Cognitiva</div>
            </td>
            <td style="text-align: right; width: 50%;">
                <div class="footer-title">INFORMACI√ìN DEL DOCUMENTO</div>
                <div>Generado: {% now "d/m/Y H:i" %}</div>
                <div>Evaluaci√≥n N¬∞: {{ game_session.id }}</div>
                <div>Confidencialidad: Uso Interno - Confidencial</div>
            </td>
        </tr>
    </table>

</body>
</html>