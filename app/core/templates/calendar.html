{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<style>
        .calendar-day {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .calendar-day:hover {
            background-color: #f3f4f6;
        }
        
        .dark .calendar-day:hover {
            background-color: #374151;
        }
        
        .calendar-day.selected {
            background-color: #8b5cf6;
            color: white;
        }
        
        .calendar-day.has-activity {
            position: relative;
        }
        
        .calendar-day.has-activity::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background-color: #8b5cf6;
            border-radius: 50%;
        }
        
        .dark .calendar-day.has-activity::after {
            background-color: #a78bfa;
        }
        
        .calendar-day.selected.has-activity::after {
            background-color: white;
        }
        
        .activity-item {
            transition: all 0.2s ease;
        }
        
        .activity-item:hover {
            transform: translateX(4px);
        }
</style>
{% endblock %}

{% block content %}
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{% trans "Calendario de Actividades" %}</h1>
                <p class="text-gray-600 dark:text-gray-400">{% trans "Organiza y revisa tus sesiones de entrenamiento" %}</p>
            </div>
            
            <div class="flex gap-3">
                <button id="today-btn" class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl text-sm font-medium transition-all hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
                    {% trans "Hoy" %}
                </button>
                <button id="add-cita-btn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl text-sm font-medium transition-all hover:from-blue-600 hover:to-blue-700 flex items-center gap-2">
                    <i class="fas fa-calendar-plus"></i>
                    {% trans "Agendar Cita" %}
                </button>
                <button id="add-activity-btn" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl text-sm font-medium transition-all hover:from-purple-600 hover:to-purple-700 flex items-center gap-2">
                    <i class="fas fa-plus"></i>
                    {% trans "Nueva Actividad" %}
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Calendario -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <!-- Controles del Calendario -->
                    <div class="flex items-center justify-between mb-6">
                        <button id="prev-month" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-chevron-left text-gray-600 dark:text-gray-400"></i>
                        </button>
                        
                        <h2 id="current-month" class="text-xl font-bold text-gray-900 dark:text-white">{% trans "Febrero 2024" %}</h2>
                        
                        <button id="next-month" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-chevron-right text-gray-600 dark:text-gray-400"></i>
                        </button>
                    </div>

                    <!-- Días de la semana -->
                    <div class="grid grid-cols-7 gap-1 mb-4">
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Dom" %}</div>
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Lun" %}</div>
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Mar" %}</div>
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Mié" %}</div>
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Jue" %}</div>
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Vie" %}</div>
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Sáb" %}</div>
                    </div>

                    <!-- Días del mes -->
                    <div id="calendar-days" class="grid grid-cols-7 gap-1">
                        <!-- Los días se generarán dinámicamente con JavaScript -->
                    </div>
                </div>

                <!-- Estadísticas rápidas -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 text-center">
                        <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-play text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <p class="text-lg font-bold text-gray-900 dark:text-white" id="sessions-count">0</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">{% trans "Sesiones este mes" %}</p>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 text-center">
                        <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-check-circle text-green-600 dark:text-green-400"></i>
                        </div>
                        <p class="text-lg font-bold text-gray-900 dark:text-white" id="completed-count">0</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">{% trans "Completadas" %}</p>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 text-center">
                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-clock text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <p class="text-lg font-bold text-gray-900 dark:text-white" id="time-count">0h</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">{% trans "Tiempo total" %}</p>
                    </div>
                </div>
            </div>

            <!-- Registros del día seleccionado -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 sticky top-8">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4" id="selected-date">{% trans "Hoy" %}</h3>
                    
                    <!-- Lista de actividades -->
                    <div id="activities-list" class="space-y-3 mb-6">
                        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                            <i class="fas fa-calendar-day text-3xl mb-2 opacity-50"></i>
                            <p>{% trans "No hay actividades para este día" %}</p>
                        </div>
                    </div>
                    
                    <!-- Resumen del día -->
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-3">{% trans "Resumen del día" %}</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">{% trans "Sesiones completadas:" %}</span>
                                <span class="font-medium text-gray-900 dark:text-white" id="day-sessions">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">{% trans "Tiempo total:" %}</span>
                                <span class="font-medium text-gray-900 dark:text-white" id="day-time">0 min</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">{% trans "Puntos ganados:" %}</span>
                                <span class="font-medium text-green-600 dark:text-green-400" id="day-points">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Modal para agendar cita -->
    <div id="cita-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">{% trans "Agendar Cita" %}</h3>
                <button id="close-cita-modal" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-times text-gray-500 dark:text-gray-400"></i>
                </button>
            </div>
            
            <form id="cita-form" class="space-y-4" enctype="multipart/form-data">
                {% csrf_token %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Nombre del Paciente" %}</label>
                    <input type="text" id="cita-nombre" required
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Foto del Paciente" %}</label>
                    <input type="file" id="cita-foto" accept="image/*"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Fecha" %}</label>
                        <input type="date" id="cita-fecha" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Hora" %}</label>
                        <input type="time" id="cita-hora" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Notas" %}</label>
                    <textarea id="cita-notas" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                              placeholder="{% trans 'Motivo de la consulta, observaciones...' %}"></textarea>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" id="cancel-cita" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        {% trans "Cancelar" %}
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium rounded-xl hover:from-blue-600 hover:to-blue-700 transition-colors">
                        {% trans "Agendar" %}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar actividad -->
    <div id="activity-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">{% trans "Nueva Actividad" %}</h3>
                <button id="close-modal" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-times text-gray-500 dark:text-gray-400"></i>
                </button>
            </div>
            
            <form id="activity-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Juego" %}</label>
                    <select id="activity-game" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="quiz">{% trans "Quiz Interactivo" %}</option>
                        <option value="search">{% trans "Búsqueda de Palabras" %}</option>
                        <option value="order">{% trans "Ordenar Oraciones" %}</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Duración (minutos)" %}</label>
                    <input type="number" id="activity-duration" min="5" max="60" value="15" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Puntos obtenidos" %}</label>
                    <input type="number" id="activity-points" min="0" max="100" value="25" 
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{% trans "Notas" %}</label>
                    <textarea id="activity-notes" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                              placeholder="{% trans 'Agrega alguna observación...' %}"></textarea>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" id="cancel-activity" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        {% trans "Cancelar" %}
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white font-medium rounded-xl hover:from-purple-600 hover:to-purple-700 transition-colors">
                        {% trans "Guardar" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
        // IIFE para ejecutar inmediatamente sin esperar DOMContentLoaded
        (function initCalendarPage() {
            console.log('{% trans "Inicializando calendario..." %}');
            
            // Datos de ejemplo para actividades
            let activities = {
                '2024-02-15': [
                    {
                        id: 1,
                        game: 'quiz',
                        gameName: '{% trans "Quiz Interactivo" %}',
                        duration: 12,
                        points: 80,
                        notes: '{% trans "Excelente rendimiento en comprensión lectora" %}',
                        time: '10:30 AM'
                    },
                    {
                        id: 2,
                        game: 'search',
                        gameName: '{% trans "Búsqueda de Palabras" %}',
                        duration: 8,
                        points: 65,
                        notes: '{% trans "Encontró 12 de 15 palabras" %}',
                        time: '04:15 PM'
                    }
                ],
                '2024-02-10': [
                    {
                        id: 3,
                        game: 'order',
                        gameName: '{% trans "Ordenar Oraciones" %}',
                        duration: 15,
                        points: 45,
                        notes: '{% trans "Dificultad con oraciones complejas" %}',
                        time: '03:00 PM'
                    }
                ],
                '2024-02-05': [
                    {
                        id: 4,
                        game: 'quiz',
                        gameName: '{% trans "Quiz Interactivo" %}',
                        duration: 10,
                        points: 70,
                        notes: '{% trans "Mejoró 15% respecto a la última sesión" %}',
                        time: '11:00 AM'
                    }
                ]
            };

            // Estado del calendario
            let currentDate = new Date();
            let selectedDate = new Date();
            let currentMonth = currentDate.getMonth();
            let currentYear = currentDate.getFullYear();

            // Elementos DOM
            const calendarDays = document.getElementById('calendar-days');
            const currentMonthElement = document.getElementById('current-month');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const todayBtn = document.getElementById('today-btn');
            const selectedDateElement = document.getElementById('selected-date');
            const activitiesList = document.getElementById('activities-list');
            const activityModal = document.getElementById('activity-modal');
            const addActivityBtn = document.getElementById('add-activity-btn');
            const closeModalBtn = document.getElementById('close-modal');
            const cancelActivityBtn = document.getElementById('cancel-activity');
            const activityForm = document.getElementById('activity-form');
            
            // Elementos de estadísticas
            const sessionsCount = document.getElementById('sessions-count');
            const completedCount = document.getElementById('completed-count');
            const timeCount = document.getElementById('time-count');
            const daySessions = document.getElementById('day-sessions');
            const dayTime = document.getElementById('day-time');
            const dayPoints = document.getElementById('day-points');

            console.log('{% trans "Elementos encontrados:" %}', {
                calendarDays: calendarDays ? '{% trans "Sí" %}' : '{% trans "No" %}',
                prevMonthBtn: prevMonthBtn ? '{% trans "Sí" %}' : '{% trans "No" %}',
                activityModal: activityModal ? '{% trans "Sí" %}' : '{% trans "No" %}'
            });

            // Renderizar calendario
            function renderCalendar() {
                calendarDays.innerHTML = '';
                
                // Actualizar título del mes
                const monthNames = [
                    '{% trans "Enero" %}', '{% trans "Febrero" %}', '{% trans "Marzo" %}', 
                    '{% trans "Abril" %}', '{% trans "Mayo" %}', '{% trans "Junio" %}', 
                    '{% trans "Julio" %}', '{% trans "Agosto" %}', '{% trans "Septiembre" %}', 
                    '{% trans "Octubre" %}', '{% trans "Noviembre" %}', '{% trans "Diciembre" %}'
                ];
                currentMonthElement.textContent = `${monthNames[currentMonth]} ${currentYear}`;
                
                // Obtener primer día del mes y cantidad de días
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();
                
                // Días del mes anterior
                const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
                for (let i = 0; i < startingDay; i++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day text-center py-2 text-gray-400 dark:text-gray-600';
                    dayElement.textContent = prevMonthLastDay - startingDay + i + 1;
                    calendarDays.appendChild(dayElement);
                }
                
                // Días del mes actual
                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayElement = document.createElement('div');
                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const hasActivity = activities[dateStr] && activities[dateStr].length > 0;
                    
                    dayElement.className = `calendar-day text-center py-2 rounded-lg text-gray-900 dark:text-gray-100 ${hasActivity ? 'has-activity' : ''}`;
                    
                    if (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                        dayElement.classList.add('font-bold', 'text-purple-600', 'dark:text-purple-400');
                    }
                    
                    if (day === selectedDate.getDate() && currentMonth === selectedDate.getMonth() && currentYear === selectedDate.getFullYear()) {
                        dayElement.classList.add('selected');
                    }
                    
                    dayElement.textContent = day;
                    dayElement.dataset.date = dateStr;
                    dayElement.addEventListener('click', () => selectDate(day));
                    calendarDays.appendChild(dayElement);
                }
                
                // Días del próximo mes
                const totalCells = 42;
                const remainingCells = totalCells - (startingDay + daysInMonth);
                for (let i = 1; i <= remainingCells; i++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day text-center py-2 text-gray-400 dark:text-gray-600';
                    dayElement.textContent = i;
                    calendarDays.appendChild(dayElement);
                }
            }

            function selectDate(day) {
                selectedDate = new Date(currentYear, currentMonth, day);
                renderCalendar();
                updateSelectedDateInfo();
            }

            function updateSelectedDateInfo() {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const locale = '{{ LANGUAGE_CODE }}' === 'en' ? 'en-US' : 'es-ES';
                selectedDateElement.textContent = selectedDate.toLocaleDateString(locale, options);
                
                const dateStr = formatDate(selectedDate);
                const dayActivities = activities[dateStr] || [];
                
                activitiesList.innerHTML = '';
                
                if (dayActivities.length === 0) {
                    activitiesList.innerHTML = `
                        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                            <i class="fas fa-calendar-day text-3xl mb-2 opacity-50"></i>
                            <p>{% trans "No hay actividades para este día" %}</p>
                        </div>
                    `;
                } else {
                    dayActivities.forEach(activity => {
                        const activityElement = document.createElement('div');
                        activityElement.className = 'activity-item bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl p-4';
                        
                        let gameIcon = 'fa-gamepad';
                        let gameColor = 'purple';
                        
                        if (activity.game === 'search') {
                            gameIcon = 'fa-search';
                            gameColor = 'blue';
                        } else if (activity.game === 'order') {
                            gameIcon = 'fa-sort-alpha-down';
                            gameColor = 'orange';
                        }
                        
                        activityElement.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 bg-${gameColor}-100 dark:bg-${gameColor}-900/30 rounded-lg flex items-center justify-center">
                                        <i class="fas ${gameIcon} text-${gameColor}-600 dark:text-${gameColor}-400 text-sm"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-900 dark:text-white">${activity.gameName}</h4>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">${activity.time}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="inline-block bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 text-xs font-medium px-2 py-1 rounded-full">
                                        +${activity.points} {% trans "pts" %}
                                    </span>
                                </div>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                                <span>${activity.duration} {% trans "min" %}</span>
                                <span>${activity.notes}</span>
                            </div>
                        `;
                        
                        activitiesList.appendChild(activityElement);
                    });
                }
                
                daySessions.textContent = dayActivities.length;
                const totalTime = dayActivities.reduce((sum, activity) => sum + activity.duration, 0);
                dayTime.textContent = `${totalTime} {% trans "min" %}`;
                const totalPoints = dayActivities.reduce((sum, activity) => sum + activity.points, 0);
                dayPoints.textContent = totalPoints;
            }

            function updateStatistics() {
                let totalSessions = 0;
                let totalTime = 0;
                
                Object.values(activities).forEach(dayActivities => {
                    totalSessions += dayActivities.length;
                    dayActivities.forEach(activity => {
                        totalTime += activity.duration;
                    });
                });
                
                sessionsCount.textContent = totalSessions;
                completedCount.textContent = totalSessions;
                const hours = Math.round(totalTime / 60);
                const minutes = totalTime % 60;
                timeCount.textContent = `${hours}h ${minutes}m`;
            }

            function goToPreviousMonth() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar();
            }

            function goToNextMonth() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar();
            }

            function goToToday() {
                currentDate = new Date();
                currentMonth = currentDate.getMonth();
                currentYear = currentDate.getFullYear();
                selectedDate = new Date();
                renderCalendar();
                updateSelectedDateInfo();
            }

            function openActivityModal() {
                activityModal.classList.remove('hidden');
            }

            function closeActivityModal() {
                activityModal.classList.add('hidden');
                activityForm.reset();
            }

            function saveActivity(e) {
                e.preventDefault();
                
                const game = document.getElementById('activity-game').value;
                const duration = parseInt(document.getElementById('activity-duration').value);
                const points = parseInt(document.getElementById('activity-points').value);
                const notes = document.getElementById('activity-notes').value;
                
                const dateStr = formatDate(selectedDate);
                
                if (!activities[dateStr]) {
                    activities[dateStr] = [];
                }
                
                const gameNames = {
                    'quiz': '{% trans "Quiz Interactivo" %}',
                    'search': '{% trans "Búsqueda de Palabras" %}',
                    'order': '{% trans "Ordenar Oraciones" %}'
                };
                
                const newActivity = {
                    id: Date.now(),
                    game: game,
                    gameName: gameNames[game],
                    duration: duration,
                    points: points,
                    notes: notes,
                    time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
                };
                
                activities[dateStr].push(newActivity);
                
                closeActivityModal();
                renderCalendar();
                updateSelectedDateInfo();
                updateStatistics();
            }

            function formatDate(date) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            }

            // Inicializar
            renderCalendar();
            updateSelectedDateInfo();
            updateStatistics();
            
            // Event listeners
            prevMonthBtn.addEventListener('click', goToPreviousMonth);
            nextMonthBtn.addEventListener('click', goToNextMonth);
            todayBtn.addEventListener('click', goToToday);
            addActivityBtn.addEventListener('click', openActivityModal);
            closeModalBtn.addEventListener('click', closeActivityModal);
            cancelActivityBtn.addEventListener('click', closeActivityModal);
            activityForm.addEventListener('submit', saveActivity);
            
            // Exponer formatDate y selectedDate globalmente para uso en funciones de citas
            window.calendarUtils = {
                formatDate: formatDate,
                getSelectedDate: () => selectedDate
            };
            
            console.log('{% trans "Calendario inicializado correctamente" %}');
        })();

        // Funcionalidad de citas
        (function initCitas() {
            const citaModal = document.getElementById('cita-modal');
            const addCitaBtn = document.getElementById('add-cita-btn');
            const closeCitaModalBtn = document.getElementById('close-cita-modal');
            const cancelCitaBtn = document.getElementById('cancel-cita');
            const citaForm = document.getElementById('cita-form');

            function openCitaModal() {
                citaModal.classList.remove('hidden');
                // Pre-llenar con la fecha seleccionada
                const selectedDate = window.calendarUtils ? window.calendarUtils.getSelectedDate() : new Date();
                const formatDate = window.calendarUtils ? window.calendarUtils.formatDate : (date) => date.toISOString().split('T')[0];
                document.getElementById('cita-fecha').value = formatDate(selectedDate);
            }

            function closeCitaModal() {
                citaModal.classList.add('hidden');
                citaForm.reset();
            }

            async function saveCita(e) {
                e.preventDefault();
                
                console.log('Enviando cita...');
                
                const formData = new FormData();
                formData.append('nombre_paciente', document.getElementById('cita-nombre').value);
                formData.append('fecha', document.getElementById('cita-fecha').value);
                formData.append('hora', document.getElementById('cita-hora').value);
                formData.append('notas', document.getElementById('cita-notas').value);
                
                const fotoInput = document.getElementById('cita-foto');
                if (fotoInput.files[0]) {
                    formData.append('foto_paciente', fotoInput.files[0]);
                }
                
                try {
                    // Usar la URL correcta con el namespace
                    const response = await fetch("{% url 'core:crear_cita' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: formData
                    });
                    
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers.get('content-type'));
                    
                    // Verificar si la respuesta es realmente JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('Respuesta no es JSON:', text);
                        throw new Error('El servidor no retornó JSON. Posible error en la ruta o permisos.');
                    }
                    
                    const data = await response.json();
                    console.log('Response data:', data);
                    
                    if (response.ok && data.success) {
                        closeCitaModal();
                        
                        // Recargar sidebar de citas
                        if (typeof window.loadCitasDelDia === 'function') {
                            await window.loadCitasDelDia();
                        }
                        if (typeof window.loadCitasDelMes === 'function') {
                            await window.loadCitasDelMes();
                        }
                        
                        // Mostrar notificación de éxito
                        showToast('success', '{% trans "Cita agendada exitosamente" %}');
                    } else {
                        throw new Error(data.error || '{% trans "Error al agendar la cita" %}');
                    }
                } catch (error) {
                    console.error('Error completo al agendar cita:', error);
                    showToast('error', error.message || '{% trans "Error al agendar la cita" %}');
                }
            }

            // Función para mostrar toast notifications
            function showToast(type, message) {
                let toastContainer = document.getElementById('toastContainer');
                
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'toastContainer';
                    toastContainer.className = 'toast-container';
                    document.body.appendChild(toastContainer);
                }
                
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                
                const icons = {
                    'success': 'fa-check-circle',
                    'error': 'fa-exclamation-circle',
                    'warning': 'fa-exclamation-triangle',
                    'info': 'fa-info-circle'
                };
                
                toast.innerHTML = `
                    <i class="toast-icon fas ${icons[type] || icons['info']}"></i>
                    <span class="toast-message">${message}</span>
                `;
                
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            // Event listeners
            if (addCitaBtn) addCitaBtn.addEventListener('click', openCitaModal);
            if (closeCitaModalBtn) closeCitaModalBtn.addEventListener('click', closeCitaModal);
            if (cancelCitaBtn) cancelCitaBtn.addEventListener('click', closeCitaModal);
            if (citaForm) citaForm.addEventListener('submit', saveCita);
            
            console.log('{% trans "Sistema de citas inicializado" %}');
        })();
</script>
{% endblock %}