{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<style>
        .calendar-day {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .calendar-day:hover {
            background-color: #f3f4f6;
        }
        
        .dark .calendar-day:hover {
            background-color: #374151;
        }
        
        .calendar-day.selected {
            background-color: #8b5cf6;
            color: white;
        }
        
        .calendar-day.has-cita {
            position: relative;
        }
        
        .calendar-day.has-cita::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background-color: #8b5cf6;
            border-radius: 50%;
        }
        
        .dark .calendar-day.has-cita::after {
            background-color: #a78bfa;
        }
        
        .calendar-day.selected.has-cita::after {
            background-color: white;
        }
        
        .cita-item {
            transition: all 0.2s ease;
        }
        
        .cita-item:hover {
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }
        
        /* Animaciones del modal */
        @keyframes scale-in {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .animate-scale-in {
            animation: scale-in 0.2s ease-out;
        }
</style>
{% endblock %}

{% block content %}
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{% trans "Calendario de Citas" %}</h1>
                <p class="text-gray-600 dark:text-gray-400">{% trans "Organiza y gestiona tus citas con pacientes" %}</p>
            </div>
            
            <div class="flex gap-3">
                <button id="today-btn" class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl text-sm font-medium transition-all hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
                    <i class="fas fa-calendar-day mr-2"></i>
                    {% trans "Hoy" %}
                </button>
                <button id="add-cita-btn" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl text-sm font-medium transition-all hover:from-purple-600 hover:to-purple-700 flex items-center gap-2 shadow-md hover:shadow-lg">
                    <i class="fas fa-calendar-plus"></i>
                    {% trans "Agendar Cita" %}
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Calendario -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <!-- Controles del Calendario -->
                    <div class="flex items-center justify-between mb-6">
                        <button id="prev-month" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-chevron-left text-gray-600 dark:text-gray-400"></i>
                        </button>
                        
                        <h2 id="current-month" class="text-xl font-bold text-gray-900 dark:text-white"></h2>
                        
                        <button id="next-month" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-chevron-right text-gray-600 dark:text-gray-400"></i>
                        </button>
                    </div>

                    <!-- Días de la semana -->
                    <div class="grid grid-cols-7 gap-1 mb-4">
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Dom" %}</div>
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Lun" %}</div>
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Mar" %}</div>
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Mié" %}</div>
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Jue" %}</div>
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Vie" %}</div>
                        <div class="text-center text-sm font-medium text-gray-500 dark:text-gray-400 py-2">{% trans "Sáb" %}</div>
                    </div>

                    <!-- Días del mes -->
                    <div id="calendar-days" class="grid grid-cols-7 gap-1">
                        <!-- Los días se generarán dinámicamente con JavaScript -->
                    </div>
                </div>

                <!-- Estadísticas rápidas -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 text-center">
                        <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-calendar-check text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <p class="text-lg font-bold text-gray-900 dark:text-white" id="citas-count">0</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">{% trans "Citas este mes" %}</p>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 text-center">
                        <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-check-circle text-green-600 dark:text-green-400"></i>
                        </div>
                        <p class="text-lg font-bold text-gray-900 dark:text-white" id="completed-count">0</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">{% trans "Completadas" %}</p>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 text-center">
                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-clock text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <p class="text-lg font-bold text-gray-900 dark:text-white" id="pendientes-count">0</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">{% trans "Pendientes" %}</p>
                    </div>
                </div>
            </div>

            <!-- Citas del día seleccionado -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 sticky top-8">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4" id="selected-date">{% trans "Hoy" %}</h3>
                    
                    <!-- Lista de citas - ID único para evitar conflictos con base.html -->
                    <div id="calendar-citas-list" class="space-y-3">
                        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                            <i class="fas fa-calendar-times text-3xl mb-2 opacity-50"></i>
                            <p class="text-sm">{% trans "No hay citas para este día" %}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Modal para agendar cita - Diseño mejorado -->
    <div id="cita-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 overflow-y-auto p-4">
        <div class="bg-white dark:bg-gray-900 rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl border border-gray-200 dark:border-gray-800 animate-scale-in">
            <!-- Header del Modal -->
            <div class="sticky top-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 p-6 flex items-center justify-between z-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-calendar-plus text-purple-600 dark:text-purple-400"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                        {% trans "Agendar Nueva Cita" %}
                    </h3>
                </div>
                <button id="close-cita-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Contenido del Modal -->
            <form id="cita-form" class="p-6" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Columna izquierda - Foto del Paciente -->
                    <div class="lg:col-span-1">
                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">
                            <i class="fas fa-user-circle text-purple-600 dark:text-purple-400 mr-2"></i>
                            {% trans "Foto del Paciente" %}
                        </h4>
                        
                        <!-- Image Preview -->
                        <div class="mb-4">
                            <div class="image-preview relative w-full aspect-square rounded-xl overflow-hidden bg-gray-100 dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700">
                                <div id="imagePreviewCita" class="w-full h-full flex flex-col items-center justify-center text-gray-400 dark:text-gray-600">
                                    <i class="fas fa-user-circle text-6xl mb-2"></i>
                                    <p class="text-sm">{% trans "Sin foto" %}</p>
                                </div>
                                <img id="imageCitaSrc" src="" alt="Preview" class="w-full h-full object-cover hidden">
                            </div>
                        </div>
                        
                        <!-- Drag & Drop Area -->
                        <div class="drag-drop-area border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl p-6 text-center cursor-pointer hover:border-purple-500 dark:hover:border-purple-400 transition-all"
                             id="dragDropAreaCita">
                            <input type="file" 
                                   id="cita-foto" 
                                   accept="image/*" 
                                   class="hidden">
                            <label for="cita-foto" class="cursor-pointer block">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 dark:text-gray-600 mb-2 block"></i>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
                                    {% trans "Haz clic para subir" %}
                                </p>
                                <p class="text-xs text-gray-500 dark:text-gray-500">
                                    {% trans "o arrastra y suelta" %}
                                </p>
                                <p class="text-xs text-gray-400 dark:text-gray-600 mt-2">
                                    PNG, JPG (max. 5MB)
                                </p>
                            </label>
                        </div>
                        
                        <!-- Remove Image Button -->
                        <button type="button" 
                                id="removeImageBtnCita"
                                class="w-full mt-4 px-4 py-2 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg text-sm font-medium hover:bg-red-100 dark:hover:bg-red-900/50 transition-all hidden">
                            <i class="fas fa-trash mr-2"></i>
                            {% trans "Eliminar foto" %}
                        </button>
                    </div>

                    <!-- Columna derecha - Datos de la Cita -->
                    <div class="lg:col-span-2">
                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">
                            <i class="fas fa-info-circle text-purple-600 dark:text-purple-400 mr-2"></i>
                            {% trans "Información de la Cita" %}
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Nombre del Paciente -->
                            <div class="md:col-span-2">
                                <label for="cita-nombre" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {% trans "Nombre del Paciente" %} <span class="text-red-500">*</span>
                                </label>
                                <input type="text" 
                                       id="cita-nombre" 
                                       required
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"
                                       placeholder="{% trans 'Ej: Juan Pérez López' %}">
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="error-nombre"></p>
                            </div>

                            <!-- Email de los Padres -->
                            <div class="md:col-span-2">
                                <label for="cita-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {% trans "Correo Electrónico de los Padres" %} <span class="text-red-500">*</span>
                                </label>
                                <input type="email" 
                                       id="cita-email" 
                                       required
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"
                                       placeholder="{% trans 'correo@ejemplo.com' %}">
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="error-email"></p>
                            </div>

                            <!-- Fecha -->
                            <div>
                                <label for="cita-fecha" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {% trans "Fecha" %} <span class="text-red-500">*</span>
                                </label>
                                <input type="date" 
                                       id="cita-fecha" 
                                       required
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200">
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="error-fecha"></p>
                            </div>
                            
                            <!-- Hora -->
                            <div>
                                <label for="cita-hora" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {% trans "Hora" %} <span class="text-red-500">*</span>
                                </label>
                                <input type="time" 
                                       id="cita-hora" 
                                       required
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200">
                                <p class="mt-1 text-xs text-red-600 dark:text-red-400 hidden" id="error-hora"></p>
                            </div>

                            <!-- Notas / Motivo de Consulta -->
                            <div class="md:col-span-2">
                                <label for="cita-notas" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    {% trans "Notas / Motivo de Consulta" %}
                                </label>
                                <textarea id="cita-notas" 
                                          rows="4" 
                                          class="w-full px-4 py-3 border border-gray-300 dark:border-gray-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200"
                                          placeholder="{% trans 'Motivo de la consulta, observaciones importantes...' %}"></textarea>
                            </div>

                            <!-- Recordatorio -->
                            <div class="md:col-span-2">
                                <div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg p-3">
                                    <p class="text-xs font-medium text-purple-900 dark:text-purple-300 mb-1 flex items-center">
                                        <i class="fas fa-bell mr-1"></i>{% trans "Recordatorio:" %}
                                    </p>
                                    <p class="text-xs text-purple-700 dark:text-purple-400">
                                        {% trans "Se enviará un recordatorio de esta cita 30 minutos antes de la hora programada." %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="flex gap-3 mt-6 pt-6 border-t border-gray-200 dark:border-gray-800">
                    <button type="button"
                            id="cancel-cita"
                            class="flex-1 px-6 py-3 bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-xl text-sm font-semibold hover:bg-gray-300 dark:hover:bg-gray-700 transition-all">
                        <i class="fas fa-times mr-2"></i>
                        {% trans "Cancelar" %}
                    </button>
                    <button type="submit"
                            id="btnGuardarCita"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-800 hover:from-purple-500 hover:to-purple-700 text-white rounded-xl text-sm font-bold transition-all shadow-md hover:shadow-lg">
                        <i class="fas fa-calendar-check mr-2"></i>
                        {% trans "Agendar Cita" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
        // Sistema de gestión de calendario de citas
        (function initCalendarPage() {
            console.log('{% trans "Inicializando calendario de citas..." %}');
            
            // Estado del calendario
            let currentDate = new Date();
            let selectedDate = new Date();
            let currentMonth = currentDate.getMonth();
            let currentYear = currentDate.getFullYear();
            let citasConFecha = new Set();

            // Elementos DOM
            const calendarDays = document.getElementById('calendar-days');
            const currentMonthElement = document.getElementById('current-month');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const todayBtn = document.getElementById('today-btn');
            const selectedDateElement = document.getElementById('selected-date');
            const citasList = document.getElementById('calendar-citas-list'); // ID único
            
            // Elementos de estadísticas
            const citasCount = document.getElementById('citas-count');
            const completedCount = document.getElementById('completed-count');
            const pendientesCount = document.getElementById('pendientes-count');

            // Cargar citas con fechas del mes
            async function loadCitasDelMes() {
                try {
                    const firstDay = new Date(currentYear, currentMonth, 1);
                    const lastDay = new Date(currentYear, currentMonth + 1, 0);
                    
                    citasConFecha.clear();
                    let totalCitas = 0;
                    let totalCompletadas = 0;
                    
                    for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                        const fecha = d.toISOString().split('T')[0];
                        const response = await fetch("{% url 'core:get_citas_dia' %}?fecha=" + fecha);
                        const data = await response.json();
                        if (data.citas.length > 0) {
                            citasConFecha.add(fecha);
                            totalCitas += data.citas.length;
                            totalCompletadas += data.citas.filter(c => c.completada).length;
                        }
                    }
                    
                    // Actualizar estadísticas
                    citasCount.textContent = totalCitas;
                    completedCount.textContent = totalCompletadas;
                    pendientesCount.textContent = totalCitas - totalCompletadas;
                    
                    renderCalendar();
                } catch (error) {
                    console.error('Error cargando citas del mes:', error);
                }
            }

            // Renderizar calendario
            function renderCalendar() {
                calendarDays.innerHTML = '';
                
                const monthNames = [
                    '{% trans "Enero" %}', '{% trans "Febrero" %}', '{% trans "Marzo" %}', 
                    '{% trans "Abril" %}', '{% trans "Mayo" %}', '{% trans "Junio" %}', 
                    '{% trans "Julio" %}', '{% trans "Agosto" %}', '{% trans "Septiembre" %}', 
                    '{% trans "Octubre" %}', '{% trans "Noviembre" %}', '{% trans "Diciembre" %}'
                ];
                currentMonthElement.textContent = `${monthNames[currentMonth]} ${currentYear}`;
                
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();
                
                // Días vacíos al inicio
                for (let i = 0; i < startingDay; i++) {
                    const emptyDay = document.createElement('div');
                    calendarDays.appendChild(emptyDay);
                }
                
                // Días del mes
                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const hasCita = citasConFecha.has(dateStr);
                    
                    dayEl.className = `calendar-day relative text-center py-2 rounded-lg text-gray-900 dark:text-gray-100 ${hasCita ? 'has-cita' : ''}`;
                    dayEl.textContent = day;
                    
                    if (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                        dayEl.classList.add('text-purple-600', 'dark:text-purple-400', 'font-semibold');
                    }
                    
                    if (day === selectedDate.getDate() && currentMonth === selectedDate.getMonth() && currentYear === selectedDate.getFullYear()) {
                        dayEl.classList.add('selected');
                    }
                    
                    dayEl.addEventListener('click', () => selectDate(day));
                    calendarDays.appendChild(dayEl);
                }
            }

            function selectDate(day) {
                selectedDate = new Date(currentYear, currentMonth, day);
                renderCalendar();
                updateSelectedDateInfo();
            }

            async function updateSelectedDateInfo() {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const locale = '{{ LANGUAGE_CODE }}' === 'en' ? 'en-US' : 'es-ES';
                selectedDateElement.textContent = selectedDate.toLocaleDateString(locale, options);
                
                const fecha = selectedDate.toISOString().split('T')[0];
                
                try {
                    const response = await fetch("{% url 'core:get_citas_dia' %}?fecha=" + fecha);
                    const data = await response.json();
                    
                    if (!citasList) {
                        console.error('No se encontró el elemento calendar-citas-list');
                        return;
                    }
                    
                    citasList.innerHTML = '';
                    
                    if (data.citas.length === 0) {
                        citasList.innerHTML = `
                            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                                <i class="fas fa-calendar-times text-3xl mb-2 opacity-50"></i>
                                <p class="text-sm">{% trans "No hay citas para este día" %}</p>
                            </div>
                        `;
                    } else {
                        data.citas.forEach(cita => {
                            const citaCard = document.createElement('div');
                            citaCard.className = 'cita-item bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl p-3';
                            
                            const fotoUrl = cita.foto_paciente || '{% static "img/profile.png" %}';
                            const completadaClass = cita.completada ? 'opacity-50' : '';
                            const checkIcon = cita.completada ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-300';
                            
                            citaCard.innerHTML = `
                                <div class="flex items-center gap-3 ${completadaClass}">
                                    <img src="${fotoUrl}" alt="${cita.nombre_paciente}" 
                                         class="w-12 h-12 rounded-full object-cover border-2 border-gray-200 dark:border-gray-600">
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-medium text-gray-900 dark:text-white text-sm truncate">
                                            ${cita.nombre_paciente}
                                        </h4>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">
                                            <i class="far fa-clock mr-1"></i>${cita.hora}
                                        </p>
                                    </div>
                                    <button onclick="window.toggleCitaCompletadaCalendar(${cita.id})" 
                                            class="text-lg hover:scale-110 transition-transform"
                                            title="${cita.completada ? '{% trans "Marcar como pendiente" %}' : '{% trans "Marcar como completada" %}'}">
                                        <i class="fas ${checkIcon}"></i>
                                    </button>
                                </div>
                                ${cita.notas ? `<p class="text-xs text-gray-600 dark:text-gray-400 mt-2 pl-15">${cita.notas}</p>` : ''}
                            `;
                            
                            citasList.appendChild(citaCard);
                        });
                    }
                } catch (error) {
                    console.error('Error cargando citas:', error);
                    if (citasList) {
                        citasList.innerHTML = `
                            <div class="text-center py-8 text-red-500 dark:text-red-400">
                                <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                                <p class="text-sm">{% trans "Error al cargar las citas" %}</p>
                            </div>
                        `;
                    }
                }
            }

            // Función específica del calendario para marcar citas como completadas
            window.toggleCitaCompletadaCalendar = async function(citaId) {
                try {
                    const response = await fetch("{% url 'core:marcar_cita_completada' cita_id=0 %}".replace('/0/', `/${citaId}/`), {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        // Recargar vista de calendario
                        await updateSelectedDateInfo();
                        await loadCitasDelMes();
                        
                        // Actualizar sidebar de base.html si está disponible
                        if (typeof window.loadCitasDelDia === 'function') {
                            await window.loadCitasDelDia();
                        }
                        if (typeof window.load_citas_del_mes === 'function') {
                            await window.load_citas_del_mes();
                        }
                        
                        mostrarToast('success', '{% trans "Estado de la cita actualizado" %}');
                    }
                } catch (error) {
                    console.error('Error al marcar cita:', error);
                    mostrarToast('error', '{% trans "Error al actualizar la cita" %}');
                }
            };

            function goToPreviousMonth() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                loadCitasDelMes();
            }

            function goToNextMonth() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                loadCitasDelMes();
            }

            function goToToday() {
                currentDate = new Date();
                currentMonth = currentDate.getMonth();
                currentYear = currentDate.getFullYear();
                selectedDate = new Date();
                loadCitasDelMes();
                updateSelectedDateInfo();
            }

            // Inicializar
            loadCitasDelMes();
            updateSelectedDateInfo();
            
            // Event listeners
            prevMonthBtn.addEventListener('click', goToPreviousMonth);
            nextMonthBtn.addEventListener('click', goToNextMonth);
            todayBtn.addEventListener('click', goToToday);
            
            // Exponer funciones globalmente
            window.calendarUtils = {
                formatDate: (date) => date.toISOString().split('T')[0],
                getSelectedDate: () => selectedDate,
                refreshCalendar: () => {
                    loadCitasDelMes();
                    updateSelectedDateInfo();
                }
            };
            
            console.log('{% trans "Calendario de citas inicializado correctamente" %}');
        })();

        // Funcionalidad del modal de citas
        (function initCitasModal() {
            const citaModal = document.getElementById('cita-modal');
            const addCitaBtn = document.getElementById('add-cita-btn');
            const closeCitaModalBtn = document.getElementById('close-cita-modal');
            const cancelCitaBtn = document.getElementById('cancel-cita');
            const citaForm = document.getElementById('cita-form');
            const fotoInput = document.getElementById('cita-foto');
            const dragDropArea = document.getElementById('dragDropAreaCita');
            const imagePreview = document.getElementById('imagePreviewCita');
            const imageSrc = document.getElementById('imageCitaSrc');
            const removeImageBtn = document.getElementById('removeImageBtnCita');

            function openCitaModal() {
                citaModal.classList.remove('hidden');
                citaModal.classList.add('flex');
                document.body.style.overflow = 'hidden';
                
                const selectedDate = window.calendarUtils ? window.calendarUtils.getSelectedDate() : new Date();
                const formatDate = window.calendarUtils ? window.calendarUtils.formatDate : (date) => date.toISOString().split('T')[0];
                document.getElementById('cita-fecha').value = formatDate(selectedDate);
            }

            function closeCitaModal() {
                citaModal.classList.add('hidden');
                citaModal.classList.remove('flex');
                document.body.style.overflow = 'auto';
                citaForm.reset();
                
                // Reset image preview
                imageSrc.src = '';
                imageSrc.classList.add('hidden');
                imagePreview.classList.remove('hidden');
                removeImageBtn.classList.add('hidden');
                
                // Reset errors
                document.querySelectorAll('[id^="error-"]').forEach(el => {
                    el.classList.add('hidden');
                    el.textContent = '';
                });
            }

            // Preview de imagen
            function handleFileSelect(file) {
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        mostrarToast('error', '{% trans "El archivo es demasiado grande. Máximo 5MB." %}');
                        fotoInput.value = '';
                        return;
                    }

                    if (!file.type.startsWith('image/')) {
                        mostrarToast('error', '{% trans "Por favor selecciona una imagen válida." %}');
                        fotoInput.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imageSrc.src = e.target.result;
                        imageSrc.classList.remove('hidden');
                        imagePreview.classList.add('hidden');
                        removeImageBtn.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Event listeners para imagen
            fotoInput.addEventListener('change', function(e) {
                handleFileSelect(e.target.files[0]);
            });

            // Drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, () => {
                    dragDropArea.classList.add('border-purple-500', 'bg-purple-50', 'dark:bg-purple-900/20');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dragDropArea.addEventListener(eventName, () => {
                    dragDropArea.classList.remove('border-purple-500', 'bg-purple-50', 'dark:bg-purple-900/20');
                }, false);
            });

            dragDropArea.addEventListener('drop', function(e) {
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fotoInput.files = dataTransfer.files;
                    handleFileSelect(file);
                } else {
                    mostrarToast('error', '{% trans "Por favor, arrastra un archivo de imagen válido." %}');
                }
            });

            // Remover imagen
            removeImageBtn.addEventListener('click', function() {
                fotoInput.value = '';
                imageSrc.src = '';
                imageSrc.classList.add('hidden');
                imagePreview.classList.remove('hidden');
                removeImageBtn.classList.add('hidden');
            });

            async function saveCita(e) {
                e.preventDefault();
                
                const btnGuardar = document.getElementById('btnGuardarCita');
                const originalText = btnGuardar.innerHTML;
                
                btnGuardar.disabled = true;
                btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>{% trans "Guardando..." %}';

                document.querySelectorAll('[id^="error-"]').forEach(el => {
                    el.classList.add('hidden');
                    el.textContent = '';
                });
                
                const formData = new FormData();
                formData.append('nombre_paciente', document.getElementById('cita-nombre').value);
                formData.append('email_padres', document.getElementById('cita-email').value);
                formData.append('fecha', document.getElementById('cita-fecha').value);
                formData.append('hora', document.getElementById('cita-hora').value);
                formData.append('notas', document.getElementById('cita-notas').value);
                
                if (fotoInput.files[0]) {
                    formData.append('foto_paciente', fotoInput.files[0]);
                }
                
                try {
                    const response = await fetch("{% url 'core:crear_cita' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        closeCitaModal();
                        
                        // Recargar calendario
                        if (window.calendarUtils && window.calendarUtils.refreshCalendar) {
                            window.calendarUtils.refreshCalendar();
                        }
                        
                        // Recargar sidebar de base.html
                        if (typeof window.loadCitasDelDia === 'function') {
                            await window.loadCitasDelDia();
                        }
                        if (typeof window.load_citas_del_mes === 'function') {
                            await window.load_citas_del_mes();
                        }
                        
                        mostrarToast('success', '{% trans "Cita agendada exitosamente" %}');
                    } else {
                        if (data.errors) {
                            Object.keys(data.errors).forEach(field => {
                                const errorEl = document.getElementById(`error-${field}`);
                                if (errorEl) {
                                    const errorMsg = Array.isArray(data.errors[field]) 
                                        ? data.errors[field][0] 
                                        : data.errors[field];
                                    errorEl.textContent = errorMsg;
                                    errorEl.classList.remove('hidden');
                                }
                            });
                        }
                        mostrarToast('error', data.error || '{% trans "Error al agendar la cita" %}');
                    }
                } catch (error) {
                    console.error('Error al agendar cita:', error);
                    mostrarToast('error', error.message || '{% trans "Error al agendar la cita" %}');
                } finally {
                    btnGuardar.disabled = false;
                    btnGuardar.innerHTML = originalText;
                }
            }

            // Event listeners
            if (addCitaBtn) addCitaBtn.addEventListener('click', openCitaModal);
            if (closeCitaModalBtn) closeCitaModalBtn.addEventListener('click', closeCitaModal);
            if (cancelCitaBtn) cancelCitaBtn.addEventListener('click', closeCitaModal);
            if (citaForm) citaForm.addEventListener('submit', saveCita);
            
            // Cerrar modal con ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && citaModal.classList.contains('flex')) {
                    closeCitaModal();
                }
            });

            // Cerrar al hacer clic fuera
            citaModal.addEventListener('click', function(e) {
                if (e.target === citaModal) {
                    closeCitaModal();
                }
            });
        })();
</script>
{% endblock %}