{% extends 'base.html' %}

{% load static %}
{% load i18n %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/games.css' %}">
{% endblock %}

{% block content %}
<div class="flex flex-col" id="fullscreen-container">
    <!-- Header minimalista profesional -->
    <div class="game-header dark:bg-gray-900 bg-white border-b border-gray-200 dark:border-gray-800">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between gap-6">
                <!-- Logo y t√≠tulo -->
                <div class="flex items-center gap-4 min-w-0">
                    <div class="icon-box gradient-icon flex-shrink-0 dark:bg-purple-700 bg-purple-500">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" />
                        </svg>
                    </div>
                    <div class="min-w-0">
                        <h1 class="text-lg font-semibold text-gray-900 dark:text-white">{{ juego.nombre }}</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400">{{ juego.descripcion }}</p>
                    </div>
                </div>

                <!-- Controles -->
                <div class="flex items-center gap-2 flex-shrink-0">
                    <button id="btn-pause-game" 
                            class="btn-primary btn-yellow dark:bg-yellow-700 dark:text-white"
                            title="{% trans 'Pausar juego' %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pause-icon lucide-pause"><rect x="14" y="3" width="5" height="18" rx="1"/><rect x="5" y="3" width="5" height="18" rx="1"/></svg>
                        <span class="hidden sm:inline text-xs">{% trans "Pausar" %}</span>
                    </button>
                    
                    <button id="btn-fullscreen" 
                            class="btn-primary btn-blue dark:bg-blue-700 dark:text-white"
                            title="{% trans 'Pantalla completa' %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-monitor-icon lucide-monitor"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>
                        <span class="hidden sm:inline text-xs" id="fullscreen-text">{% trans "Pantalla" %}</span>
                    </button>
                    
                    <button id="btn-finish-game" 
                            class="btn-primary btn-red dark:bg-red-700 dark:text-white"
                            title="{% trans 'Salir del juego' %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out-icon lucide-log-out"><path d="m16 17 5-5-5-5"/><path d="M21 12H9"/><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/></svg>
                        <span class="hidden sm:inline text-xs">{% trans "Salir" %}</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="flex-1 overflow-auto dark:bg-gray-950 bg-white">
        <div class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-5">
                <!-- Panel lateral izquierdo - Estad√≠sticas -->
                <div class="space-y-5">
                    <!-- Timer Card -->
                    <div class="game-card rounded-lg p-5 dark:bg-gray-900 bg-white border border-gray-200 dark:border-gray-800">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <div class="icon-box" style="background: #dbeafe;" class="dark:bg-blue-900">
                                    <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <span class="text-sm font-semibold text-gray-900 dark:text-white">{% trans "Tiempo" %}</span>
                            </div>
                            <div class="badge badge-status dark:bg-blue-900 dark:text-blue-300">
                                <span id="timer-status-badge">{% trans "Activo" %}</span>
                            </div>
                        </div>
                        
                        <div class="divider dark:border-gray-800"></div>
                        
                        <div class="text-center">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">{% trans "Transcurrido" %}</p>
                            <div class="flex items-center justify-center gap-1 mb-3">
                                <span class="timer-display text-3xl text-gray-900 dark:text-white" id="timer-minutes">00</span>
                                <span class="text-xl text-gray-400 dark:text-gray-500">:</span>
                                <span class="timer-display text-3xl text-gray-900 dark:text-white" id="timer-seconds">00</span>
                            </div>
                            <div class="flex items-center justify-center gap-1.5">
                                <div class="w-1.5 h-1.5 bg-green-500 dark:bg-green-400 rounded-full animate-pulse" id="timer-indicator"></div>
                                <span class="text-xs font-medium text-green-600 dark:text-green-400" id="timer-status">{% trans "En juego" %}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Progreso Card -->
                    <div class="game-card rounded-lg p-5 dark:bg-gray-900 bg-white border border-gray-200 dark:border-gray-800">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="icon-box" style="background: #f3e8ff;" class="dark:bg-purple-900">
                                <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                            <span class="text-sm font-semibold text-gray-900 dark:text-white">{% trans "Progreso" %}</span>
                        </div>

                        <div class="divider dark:border-gray-800"></div>

                        <!-- Nivel -->
                        <div class="mb-3">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-xs text-gray-600 dark:text-gray-400 font-medium">{% trans "Nivel" %}</span>
                                <span class="badge badge-info dark:bg-purple-900 dark:text-purple-300">{{ sesion.nivel_seleccionado }}</span>
                            </div>
                        </div>

                        <!-- Puntaje -->
                        <div class="mb-3 dark:bg-gray-800 bg-gray-50 rounded-md p-3 flex flex-col items-center">
                            <div class="flex items-center justify-center gap-2 mb-2">
                                <svg class="w-5 h-5 text-amber-500 dark:text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                            </div>
                            <div class="text-2xl font-bold text-gray-900 dark:text-white mb-0.5" id="puntaje-actual">{{ sesion.puntaje_total }}</div>
                            <div class="text-xs text-gray-600 dark:text-gray-400 font-medium">{% trans "Puntos totales" %}</div>
                        </div>

                        <!-- Preguntas -->
                        <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-md">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-medium text-gray-600 dark:text-gray-400">{% trans "Preguntas" %}</span>
                                <span class="text-sm font-bold text-blue-600 dark:text-blue-400">{{ sesion.preguntas_respondidas }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Participante Card -->
<div class="game-card rounded-lg p-5 dark:bg-gray-900 bg-white border border-gray-200 dark:border-gray-800">
    <div class="flex items-center gap-2 mb-3">
        <div class="icon-box" style="background: #f0fdf4;" class="dark:bg-green-900">
            <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
        </div>
        <span class="text-sm font-semibold text-gray-900 dark:text-white">{% trans "Participante" %}</span>
    </div>

    <div class="divider dark:border-gray-800"></div>

    <div class="p-3 bg-blue-50 dark:bg-blue-900 rounded-md border border-blue-100 dark:border-blue-800">
        <div class="flex items-center gap-3">
            
            <!-- Foto del ni√±o -->
            <div class="w-16 h-16 rounded-full overflow-hidden ring-2 ring-purple-200 dark:ring-purple-500/30 flex-shrink-0">
                {% if nino.imagen %}
                    <img src="{{ nino.imagen.url }}" alt="{{ nino.nombres }} {{ nino.apellidos }}" class="w-full h-full object-cover">
                {% else %}
                    <div class="w-full h-full bg-gradient-to-br from-purple-400 to-purple-600 dark:from-purple-700 dark:to-purple-900 flex items-center justify-center text-white text-2xl font-bold">
                        {{ nino.nombre_completo|slice:":2"|upper }}
                    </div>
                {% endif %}
            </div>

            <!-- Datos del ni√±o -->
            <div class="min-w-0">
                <p class="text-xs font-bold text-gray-900 dark:text-white truncate">{{ nino.nombre_completo }}</p>
                <div class="flex items-center gap-1 mt-1 flex-wrap">
                    <span class="badge badge-active text-xs dark:bg-green-900 dark:text-green-300">{{ nino.edad }} {% trans "a√±os" %}</span>
                    <span class="badge badge-status text-xs dark:bg-blue-900 dark:text-blue-300">{% trans "Activo" %}</span>
                </div>
            </div>
        </div>
    </div>
</div>

            </div>

                <!-- Panel derecho - √Årea de juego mejorada -->
                <div class="lg:col-span-3">
                    <div class="game-area-container dark:bg-gray-900 bg-white rounded-xl border border-gray-200 dark:border-gray-800">
                        <div id="game-area" class="flex items-center justify-center">
                            <!-- Estado de carga mejorado -->
                            <div class="loading-state text-center">
                                <div class="relative mb-6">
                                    <div class="loading-spinner mx-auto"></div>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <svg class="w-8 h-8 text-purple-600 dark:text-purple-400 animate-bounce" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                                        </svg>
                                    </div>
                                </div>
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">{% trans "Cargando juego" %}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">{% trans "Preparando tu experiencia de aprendizaje" %}</p>
                                <div class="flex items-center justify-center gap-2">
                                    <div class="w-2 h-2 bg-purple-600 dark:bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                                    <div class="w-2 h-2 bg-purple-600 dark:bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                                    <div class="w-2 h-2 bg-purple-600 dark:bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Pausa (con l√≠mites) - Dentro de fullscreen-container -->
    <div id="pause-overlay" class="fixed inset-0 bg-black bg-opacity-30 dark:bg-black/70 hidden flex items-center justify-center p-4 modal-overlay" style="z-index: 9999 !important;">
    <div class="modal-content max-w-md w-full p-6 dark:bg-gray-900 bg-white rounded-xl border border-gray-200 dark:border-gray-800 shadow-2xl">
        <div class="text-center mb-5">
            <div class="w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3" style="background: #fef3c7;" class="dark:bg-yellow-900/30">
                <svg class="w-7 h-7 text-amber-600 dark:text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">{% trans "Juego en Pausa" %}</h3>
            <p class="text-xs text-gray-600 dark:text-gray-400">{% trans "T√≥mate un descanso. Contin√∫a cuando est√©s listo." %}</p>
        </div>

        <!-- L√≠mites de pausa -->
        <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 mb-4">
            <div class="flex items-center justify-between text-xs">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-amber-600 dark:text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="text-amber-700 dark:text-amber-300 font-medium">Pausas restantes: <span id="pause-count-display" class="font-bold">2/2</span></span>
                </div>
            </div>
        </div>

        <!-- Temporizador de descanso -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-5">
            <div class="text-center">
                <p class="text-xs text-blue-600 dark:text-blue-400 mb-2">{% trans "Tiempo de descanso" %}</p>
                <div class="text-3xl font-bold text-blue-700 dark:text-blue-300 font-mono" id="pause-timer">03:00</div>
                <p class="text-xs text-blue-500 dark:text-blue-400 mt-1">{% trans "m√°ximo 3 minutos" %}</p>
            </div>
        </div>

        <!-- Stats en pausa -->
        <div class="grid grid-cols-2 gap-3 mb-5">
            <div class="p-3 rounded-lg bg-purple-50 dark:bg-purple-900 border border-purple-100 dark:border-purple-800">
                <div class="text-lg font-bold text-purple-600 dark:text-purple-400" id="pause-score">0</div>
                <div class="text-xs text-gray-600 dark:text-gray-400 font-medium">{% trans "Puntos" %}</div>
            </div>
            <div class="p-3 rounded-lg bg-green-50 dark:bg-green-900 border border-green-100 dark:border-green-800">
                <div class="text-lg font-bold text-green-600 dark:text-green-400" id="pause-time">00:00</div>
                <div class="text-xs text-gray-600 dark:text-gray-400 font-medium">{% trans "Tiempo jugado" %}</div>
            </div>
        </div>

        <button id="btn-resume-game" 
                class="w-full btn-primary btn-green dark:bg-green-700 dark:text-white justify-center"
                style="padding: 0.75rem 1.25rem;">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" />
            </svg>
            {% trans "Continuar" %}
        </button>
    </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Finalizar (Mejorado) - Dentro de fullscreen-container -->
    <div id="modal-finish" class="fixed inset-0 bg-black/50 dark:bg-black/80 backdrop-blur-sm hidden items-center justify-center" style="z-index: 9998 !important;">
    <div class="bg-white dark:bg-gray-900 rounded-2xl w-11/12 md:w-[500px] p-6 shadow-2xl border border-gray-200 dark:border-gray-800 transform transition-all duration-300 scale-95 opacity-0" id="modal-finish-content">
        <!-- Header -->
        <div class="flex items-center gap-3 mb-6">
            <div class="w-16 h-16 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-amber-600 dark:text-amber-400 text-2xl"></i>
            </div>
            <div class="flex-1">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                    {% trans "¬øFinalizar Juego?" %}
                </h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    {% trans "Esta acci√≥n cerrar√° el juego actual" %}
                </p>
            </div>
        </div>
        
        <!-- Informaci√≥n del juego -->
        <div class="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-xl p-5 mb-6 border border-amber-200 dark:border-amber-800">
            <div class="space-y-3">
                <div class="flex items-center gap-3">
                    <i class="fas fa-gamepad text-amber-600 dark:text-amber-400"></i>
                    <div class="flex-1">
                        <p class="text-xs text-gray-600 dark:text-gray-400">{% trans "Juego Actual" %}</p>
                        <p class="font-semibold text-gray-900 dark:text-white">{{ juego.nombre }}</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <i class="fas fa-star text-amber-600 dark:text-amber-400"></i>
                    <div class="flex-1">
                        <p class="text-xs text-gray-600 dark:text-gray-400">{% trans "Puntaje Actual" %}</p>
                        <p id="modal-puntaje-display" class="font-semibold text-gray-900 dark:text-white text-lg">0</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Advertencia -->
        <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4 mb-6">
            <p class="text-sm text-gray-800 dark:text-gray-200 flex items-start gap-2">
                <i class="fas fa-exclamation-triangle text-amber-600 dark:text-amber-400 mt-0.5 flex-shrink-0"></i>
                <span>
                    {% if evaluacion %}
                        <strong class="text-amber-800 dark:text-amber-300">{% trans "La evaluaci√≥n ser√° marcada como interrumpida." %}</strong><br>
                        {% trans "Tu progreso se guardar√° autom√°ticamente. Podr√°s reanudar la evaluaci√≥n m√°s tarde desde el listado de evaluaciones." %}
                    {% else %}
                        {% trans "Tu progreso actual se guardar√°. Podr√°s volver a jugar cuando quieras." %}
                    {% endif %}
                </span>
            </p>
        </div>
        
        <!-- Botones -->
        <div class="flex gap-3">
            <button id="btn-cancel-finish"
                    class="flex-1 px-6 py-3 bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-xl text-base font-semibold hover:bg-gray-300 dark:hover:bg-gray-700 transition-all flex items-center justify-center gap-2">
                <i class="fas fa-times"></i>
                {% trans "Cancelar" %}
            </button>
            <button id="btn-confirm-finish"
                    class="flex-1 px-6 py-3 bg-gradient-to-r from-red-600 to-red-800 dark:from-red-700 dark:to-red-900 hover:from-red-500 hover:to-red-700 text-white rounded-xl text-base font-bold transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-sign-out-alt"></i>
                {% trans "S√≠, Finalizar" %}
            </button>
        </div>
    </div>
    </div>

    <!-- Modal de √âxito - Dentro de fullscreen-container -->
    <div id="modal-success" class="fixed inset-0 bg-black/50 dark:bg-black/80 backdrop-blur-sm hidden items-center justify-center" style="z-index: 9997 !important;">
    <div class="bg-white dark:bg-gray-900 rounded-2xl w-11/12 md:w-[400px] p-8 shadow-2xl text-center transform transition-all duration-300 scale-95 opacity-0" id="modal-success-content">
        <div class="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-check-circle text-green-600 dark:text-green-400 text-4xl"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-3">
            ¬°√âxito!
        </h3>
        <p id="modal-success-message" class="text-gray-600 dark:text-gray-400 whitespace-pre-line leading-relaxed">
            <!-- Mensaje din√°mico -->
        </p>
    </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/game-alerts.js' %}"></script>
<script src="{% static 'js/game-utils.js' %}"></script>
<script src="{% static 'js/base-game.js' %}"></script>
<script src="{% static 'js/' %}{{ juego.slug }}.js"></script>

<script>
    window.gameSessionData = {
        url_sesion: '{{ sesion.url_sesion }}',
        juego_slug: '{{ juego.slug }}',
        juego_nombre: '{{ juego.nombre }}',
        evaluacion_id: '{{ evaluacion.id }}',
        nino_id: '{{ nino.id }}',
        es_evaluacion_ia: {{ es_evaluacion_ia|yesno:"true,false" }}, 
        juegos: {{ juegos_json|safe }},
        api_urls: {
            question_response: '{% url "games:save_question_response" %}',
            level_complete: '{% url "games:save_level_complete" %}',
            finish_game: '{% url "games:finish_game_session" url_sesion=sesion.url_sesion %}',
            game_list: '{% url "games:game_list" %}'
        }
    };

    window.gameConfig = {{ game_config_json|safe }};

    (function initGamePage() {
        console.log('üéÆ Inicializando juego...');
        
        const startTime = new Date('{{ sesion.fecha_inicio|date:"c" }}');
        let isPaused = false;
        let pauseStartTime = null;
        
        // ‚≠ê IMPORTANTE: Inicializar con el tiempo pausado acumulado de sesiones anteriores
        let totalPausedTime = {{ tiempo_pausado_segundos|default:0 }};
        console.log(`‚è∏Ô∏è Tiempo pausado previo: ${totalPausedTime}s`);
        
        let timerInterval = null;
        
        // Control de pausas
        let pauseCount = 0;
        const MAX_PAUSES = 2;
        const MAX_PAUSE_TIME = 180; // 3 minutos en segundos
        let pauseTimer = null;
        let pauseTimeRemaining = MAX_PAUSE_TIME;
        
        const fullscreenContainer = document.getElementById('fullscreen-container');
        const btnFullscreen = document.getElementById('btn-fullscreen');
        const fullscreenIcon = document.getElementById('fullscreen-icon');
        const fullscreenText = document.getElementById('fullscreen-text');
        
        function updateTimer() {
            if (isPaused) return;
            
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000) - totalPausedTime;
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;
            
            const timerMinutes = document.getElementById('timer-minutes');
            const timerSeconds = document.getElementById('timer-seconds');
            
            if (timerMinutes && timerSeconds) {
                timerMinutes.textContent = String(minutes).padStart(2, '0');
                timerSeconds.textContent = String(seconds).padStart(2, '0');
            }
        }
        
        btnFullscreen?.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                fullscreenContainer.requestFullscreen().catch(err => {
                    console.error('Error:', err);
                });
            } else {
                document.exitFullscreen();
            }
        });
        
        const pauseOverlay = document.getElementById('pause-overlay');
        const btnPause = document.getElementById('btn-pause-game');
        const btnResume = document.getElementById('btn-resume-game');
        
        function updatePauseTimer() {
            if (pauseTimeRemaining <= 0) {
                // Tiempo de pausa agotado, reanudar autom√°ticamente
                resumeGame();
                return;
            }
            
            pauseTimeRemaining--;
            const minutes = Math.floor(pauseTimeRemaining / 60);
            const seconds = pauseTimeRemaining % 60;
            
            const pauseTimerEl = document.getElementById('pause-timer');
            if (pauseTimerEl) {
                pauseTimerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                // Advertencia cuando quedan 30 segundos
                if (pauseTimeRemaining <= 30) {
                    pauseTimerEl.classList.add('text-red-600', 'dark:text-red-400');
                    pauseTimerEl.classList.remove('text-blue-700', 'dark:text-blue-300');
                }
            }
        }
        
        function pauseGame() {
            // Verificar si se pueden hacer m√°s pausas
            if (pauseCount >= MAX_PAUSES) {
                alert('{% trans "Has alcanzado el m√°ximo de pausas permitidas (2)." %}');
                return;
            }
            
            isPaused = true;
            pauseCount++;
            pauseStartTime = Date.now();
            pauseTimeRemaining = MAX_PAUSE_TIME;
            
            // Mostrar modal
            pauseOverlay.classList.remove('hidden');
            pauseOverlay.style.display = 'flex';
            
            // Actualizar stats en modal
            const timerMinutes = document.getElementById('timer-minutes');
            const timerSeconds = document.getElementById('timer-seconds');
            document.getElementById('pause-time').textContent = 
                `${timerMinutes.textContent}:${timerSeconds.textContent}`;
            document.getElementById('pause-score').textContent = 
                document.getElementById('puntaje-actual').textContent;
            
            // Actualizar contador de pausas
            document.getElementById('pause-count-display').textContent = 
                `${MAX_PAUSES - pauseCount}/${MAX_PAUSES}`;
            
            // Deshabilitar bot√≥n si no quedan pausas
            if (pauseCount >= MAX_PAUSES) {
                btnPause.disabled = true;
                btnPause.classList.add('opacity-50', 'cursor-not-allowed');
                btnPause.title = '{% trans "No quedan pausas disponibles" %}';
            }
            
            // Iniciar timer de pausa
            pauseTimer = setInterval(updatePauseTimer, 1000);
            document.getElementById('pause-timer').textContent = '03:00';
            document.getElementById('pause-timer').classList.remove('text-red-600', 'dark:text-red-400');
            document.getElementById('pause-timer').classList.add('text-blue-700', 'dark:text-blue-300');
            
            // Pausar timer del juego (ya est√° en updateTimer con isPaused)
            
            // Pausar timer del juego activo (pregunta actual)
            if (window.gameInstance && typeof window.gameInstance.pauseGame === 'function') {
                window.gameInstance.pauseGame();
            }
            
            // Actualizar UI
            document.getElementById('timer-indicator').classList.remove('animate-pulse');
            document.getElementById('timer-indicator').style.background = '#fbbf24';
            document.getElementById('timer-status').textContent = '{% trans "En pausa" %}';
            document.getElementById('timer-status').style.color = '#b45309';
            document.getElementById('timer-status-badge').textContent = '{% trans "Pausado" %}';
        }
        
        function resumeGame() {
            const pauseDuration = Math.floor((Date.now() - pauseStartTime) / 1000);
            totalPausedTime += pauseDuration;
            isPaused = false;
            
            // Detener timer de pausa
            if (pauseTimer) {
                clearInterval(pauseTimer);
                pauseTimer = null;
            }
            
            // Ocultar modal
            pauseOverlay.classList.add('hidden');
            pauseOverlay.style.display = 'none';
            
            // Reanudar timer del juego activo
            if (window.gameInstance && typeof window.gameInstance.resumeGame === 'function') {
                window.gameInstance.resumeGame();
            }
            
            // Actualizar UI
            document.getElementById('timer-indicator').classList.add('animate-pulse');
            document.getElementById('timer-indicator').style.background = '#22c55e';
            document.getElementById('timer-status').textContent = '{% trans "En juego" %}';
            document.getElementById('timer-status').style.color = '#16a34a';
            document.getElementById('timer-status-badge').textContent = '{% trans "Activo" %}';
        }
        
        btnPause?.addEventListener('click', pauseGame);
        btnResume?.addEventListener('click', resumeGame);
        
        window.updateScore = function(newScore) {
            // Actualizar puntaje en el panel lateral
            const scoreElement = document.getElementById('puntaje-actual');
            if (scoreElement) {
                scoreElement.textContent = newScore;
                scoreElement.style.animation = 'pulse 0.3s ease-in-out';
                setTimeout(() => {
                    scoreElement.style.animation = '';
                }, 300);
            }
            
            // Actualizar puntaje en el encabezado del juego
            const gameScoreElement = document.getElementById('game-score');
            if (gameScoreElement) {
                gameScoreElement.textContent = newScore;
                gameScoreElement.style.animation = 'pulse 0.3s ease-in-out';
                setTimeout(() => {
                    gameScoreElement.style.animation = '';
                }, 300);
            }
        };
        
        const btnFinish = document.getElementById('btn-finish-game');
        const modal = document.getElementById('modal-finish');
        const btnCancel = document.getElementById('btn-cancel-finish');
        const btnConfirm = document.getElementById('btn-confirm-finish');
        
        function getCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            return cookieValue || '';
        }
        // ============================================
        // MODAL DE FINALIZAR JUEGO (MEJORADO)
        // ============================================
        if (btnFinish && modal) {
            btnFinish.addEventListener('click', () => {
                // Actualizar puntaje en el modal
                const puntajeActual = document.getElementById('puntaje-actual')?.textContent || '0';
                document.getElementById('modal-puntaje-display').textContent = puntajeActual;
                
                // Mostrar modal con animaci√≥n
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // Animar entrada
                setTimeout(() => {
                    const content = document.getElementById('modal-finish-content');
                    if (content) {
                        content.style.transform = 'scale(1)';
                        content.style.opacity = '1';
                    }
                }, 10);
            });
        }

        if (btnCancel && modal) {
            btnCancel.addEventListener('click', () => {
                cerrarModal('modal-finish');
            });
        }

        if (btnConfirm) {
            btnConfirm.addEventListener('click', async () => {
                // Deshabilitar bot√≥n mientras procesa
                btnConfirm.disabled = true;
                btnConfirm.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                
                try {
                    const csrfToken = getCsrfToken();
                    console.log('CSRF Token:', csrfToken); // Debug
                    
                    let finishUrl;
                    if (window.gameSessionData.es_evaluacion_ia) {
                        finishUrl = `/es/games/evaluation/finish/{{ sesion.url_sesion }}/`;
                    } else {
                        finishUrl = `/es/games/individual/finish/{{ sesion.url_sesion }}/`;
                    }
                    
                    const response = await fetch(finishUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            total_score: document.getElementById('puntaje-actual')?.textContent || 0,
                            total_correct: 0,
                            total_incorrect: 0,
                            total_time_seconds: Math.floor((new Date() - startTime) / 1000) - totalPausedTime
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Cerrar modal de confirmaci√≥n
                        cerrarModal('modal-finish');
                        
                        // ‚≠ê Mostrar modal de √©xito con mensaje apropiado
                        if (data.interrumpida) {
                            // Evaluaci√≥n interrumpida
                            mostrarModalExito(`‚ö†Ô∏è Evaluaci√≥n Interrumpida\n\n${data.message}\n\nProgreso: ${data.progreso.completadas}/${data.progreso.totales} sesiones completadas`);
                        } else if (window.gameSessionData.es_evaluacion_ia && data.progreso) {
                            // Evaluaci√≥n IA: mostrar progreso
                            mostrarModalExito(`${data.message}\n\nProgreso: ${data.progreso.completadas}/${data.progreso.totales} sesiones`);
                        } else {
                            // Juego individual: mostrar mensaje simple
                            mostrarModalExito('¬°Juego finalizado correctamente!\n\nTu progreso ha sido guardado.');
                        }
                        
                        // Redirigir despu√©s de 2 segundos
                        setTimeout(() => {
                            window.location.href = data.redirect_url;
                        }, 2000);
                    } else {
                        cerrarModal('modal-finish');
                        alert('{% trans "Error:" %} ' + (data.error || '{% trans "Intenta de nuevo" %}'));
                        btnConfirm.disabled = false;
                        btnConfirm.innerHTML = '<i class="fas fa-sign-out-alt"></i> {% trans "S√≠, Finalizar" %}';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    cerrarModal('modal-finish');
                    alert('{% trans "Error de conexi√≥n" %}');
                    btnConfirm.disabled = false;
                    btnConfirm.innerHTML = '<i class="fas fa-sign-out-alt"></i> {% trans "S√≠, Finalizar" %}';
                }
            });
        }

        // Funciones auxiliares para modales
        function cerrarModal(modalId) {
            const modal = document.getElementById(modalId);
            const content = document.getElementById(modalId + '-content');
            
            if (content) {
                content.style.transform = 'scale(0.95)';
                content.style.opacity = '0';
            }
            
            setTimeout(() => {
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            }, 200);
        }

        function mostrarModalExito(mensaje) {
            const modal = document.getElementById('modal-success');
            const messageEl = document.getElementById('modal-success-message');
            const content = document.getElementById('modal-success-content');
            
            if (modal && messageEl) {
                messageEl.textContent = mensaje;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                setTimeout(() => {
                    if (content) {
                        content.style.transform = 'scale(1)';
                        content.style.opacity = '1';
                    }
                }, 10);
            }
        }

        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', function(event) {
            if (event.target.id === 'modal-finish') {
                cerrarModal('modal-finish');
            }
            if (event.target.id === 'modal-success') {
                cerrarModal('modal-success');
            }
        });
        
        timerInterval = setInterval(updateTimer, 1000);
        updateTimer();
        
        console.log('‚úÖ Juego inicializado correctamente');
    })();
</script>
{% endblock %}