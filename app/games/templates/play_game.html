{% extends 'base.html' %}

{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<style>
    /* Animaciones suaves */
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    
    .stat-card {
        animation: slideUp 0.5s ease-out forwards;
    }
    
    .stat-card:nth-child(1) { animation-delay: 0.05s; }
    .stat-card:nth-child(2) { animation-delay: 0.1s; }
    .stat-card:nth-child(3) { animation-delay: 0.15s; }
    .stat-card:nth-child(4) { animation-delay: 0.2s; }
    
    /* Estilos globales minimalistas profesionales */
    * {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
    }

    body {
        background: #f8f9fa;
    }

    /* Contenedor principal */
    #fullscreen-container:fullscreen {
        background: #f8f9fa;
    }

    /* Cards profesionales */
    .game-card {
        background: white;
        border: 1px solid #e8ecf1;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .game-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-color: #dce4ed;
    }

    /* Header profesional */
    .game-header {
        background: white;
        border-bottom: 1px solid #e8ecf1;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        position: sticky;
        top: 0;
    }

    /* Badges minimalistas */
    .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8125rem;
        font-weight: 500;
        letter-spacing: 0.3px;
    }

    .badge-status {
        background: #f0f7ff;
        color: #0369a1;
        border: 1px solid #bae6fd;
    }

    .badge-active {
        background: #f0fdf4;
        color: #166534;
        border: 1px solid #bbf7d0;
    }

    .badge-info {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }

    /* Botones profesionales minimalistas */
    .btn-primary {
        padding: 0.625rem 1rem;
        border-radius: 6px;
        border: none;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        letter-spacing: 0.3px;
    }

    .btn-yellow {
        background: #fbbf24;
        color: white;
        box-shadow: 0 2px 4px rgba(251, 191, 36, 0.2);
    }

    .btn-yellow:hover {
        background: #f59e0b;
        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
    }

    .btn-blue {
        background: #3b82f6;
        color: white;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
    }

    .btn-blue:hover {
        background: #2563eb;
        box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
    }

    .btn-red {
        background: #ef4444;
        color: white;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
    }

    .btn-red:hover {
        background: #dc2626;
        box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
    }

    .btn-green {
        background: #10b981;
        color: white;
    }

    .btn-green:hover {
        background: #059669;
    }

    /* Timer display profesional */
    .timer-display {
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
        font-weight: 700;
        letter-spacing: 1px;
    }

    /* Iconos con background sutil */
    .icon-box {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f3f4f6;
        transition: all 0.2s;
    }

    /* Separadores profesionales */
    .divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
        margin: 1rem 0;
    }

    /* Score highlight profesional */
    .score-card {
        background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 100%);
        border: 1px solid #e5e7eb;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
    }

    /* Loading animation */
    .loading-spinner {
        width: 3rem;
        height: 3rem;
        border: 3px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Modal profesional */
    .modal-overlay {
        animation: fadeIn 0.3s ease-out;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        border: 1px solid #e8ecf1;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    /* Texto profesional */
    .text-xs {
        font-size: 0.75rem;
        letter-spacing: 0.3px;
    }

    .text-sm {
        font-size: 0.875rem;
    }

    .text-base {
        font-size: 1rem;
    }

    .font-semibold {
        font-weight: 600;
        letter-spacing: 0.25px;
    }

    /* Gradiente sutil */
    .gradient-icon {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    }

    /* Estilo del √°rea de juego mejorado */
    .game-area-container {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    }

    .dark .game-area-container {
        background: #111827;
        border-color: #374151;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .game-area-container:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .dark .game-area-container:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    }

    /* √Årea de juego con padding responsive */
    #game-area {
        padding: 3rem;
        min-height: 700px;
    }

    @media (max-width: 768px) {
        #game-area {
            padding: 1.5rem;
            min-height: 500px;
        }
    }

    @media (min-width: 1024px) {
        #game-area {
            min-height: 750px;
        }
    }

    @media (min-width: 1280px) {
        #game-area {
            min-height: 800px;
        }
    }

    /* Estilos para el estado de carga */
    .loading-state {
        animation: fadeIn 0.5s ease-in-out;
    }

    .loading-spinner {
        width: 3rem;
        height: 3rem;
        border: 3px solid #e5e7eb;
        border-top-color: #8b5cf6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .dark .loading-spinner {
        border-color: #374151;
        border-top-color: #a78bfa;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Estilos para resultados de nivel */
    .level-results {
        animation: slideUp 0.6s ease-out;
    }

    .result-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .result-card:hover {
        transform: translateY(-4px) scale(1.02);
    }

    .stat-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        font-size: 2rem;
        font-weight: 700;
        position: relative;
        overflow: hidden;
    }

    .stat-badge::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 2s infinite;
    }

    /* Botones de acci√≥n mejorados */
    .action-button {
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .action-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .action-button:hover::before {
        width: 300px;
        height: 300px;
    }

    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    /* Animaci√≥n de celebraci√≥n */
    @keyframes celebrate {
        0%, 100% { transform: rotate(0deg) scale(1); }
        25% { transform: rotate(-5deg) scale(1.1); }
        75% { transform: rotate(5deg) scale(1.1); }
    }

    .celebrate {
        animation: celebrate 0.5s ease-in-out;
    }

    /* Responsividad */
    @media (max-width: 1024px) {
        .btn-primary span {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col" id="fullscreen-container">
    <!-- Header minimalista profesional -->
    <div class="game-header">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between gap-6">
                <!-- Logo y t√≠tulo -->
                <div class="flex items-center gap-4 min-w-0">
                    <div class="icon-box gradient-icon flex-shrink-0">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" />
                        </svg>
                    </div>
                    <div class="min-w-0">
                        <h1 class="text-lg font-semibold text-gray-900">{{ juego.nombre }}</h1>
                        <p class="text-xs text-gray-500">{{ juego.descripcion }}</p>
                    </div>
                </div>

                <!-- Controles -->
                <div class="flex items-center gap-2 flex-shrink-0">
                    <button id="btn-pause-game" 
                            class="btn-primary btn-yellow"
                            title="Pausar juego">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M5.75 1.5A.75.75 0 005 2.25v15.5a.75.75 0 001.5 0V2.25A.75.75 0 005.75 1.5zm8.5 0A.75.75 0 0013 2.25v15.5a.75.75 0 001.5 0V2.25a.75.75 0 00-1.5 0z" />
                        </svg>
                        <span class="hidden sm:inline text-xs">Pausar</span>
                    </button>
                    
                    <button id="btn-fullscreen" 
                            class="btn-primary btn-blue"
                            title="Pantalla completa">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="fullscreen-icon">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 6H6v4m12-4h4v4M6 18h4v-4m8 4h-4v-4" />
                        </svg>
                        <span class="hidden sm:inline text-xs" id="fullscreen-text">Pantalla</span>
                    </button>
                    
                    <button id="btn-finish-game" 
                            class="btn-primary btn-red"
                            title="Salir del juego">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.078l5.5 5.25a.75.75 0 010 1.06l-5.5 5.25a.75.75 0 11-1.04-1.078l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                        </svg>
                        <span class="hidden sm:inline text-xs">Salir</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="flex-1 overflow-auto">
        <div class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-5">
                <!-- Panel lateral izquierdo - Estad√≠sticas -->
                <div class="space-y-5">
                    <!-- Timer Card -->
                    <div class="stat-card game-card rounded-lg p-5">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <div class="icon-box" style="background: #dbeafe;">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <span class="text-sm font-semibold text-gray-900">Tiempo</span>
                            </div>
                            <div class="badge badge-status">
                                <span id="timer-status-badge">Activo</span>
                            </div>
                        </div>
                        
                        <div class="divider"></div>
                        
                        <div class="text-center">
                            <p class="text-xs text-gray-500 mb-2">Transcurrido</p>
                            <div class="flex items-center justify-center gap-1 mb-3">
                                <span class="timer-display text-3xl text-gray-900" id="timer-minutes">00</span>
                                <span class="text-xl text-gray-400">:</span>
                                <span class="timer-display text-3xl text-gray-900" id="timer-seconds">00</span>
                            </div>
                            <div class="flex items-center justify-center gap-1.5">
                                <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse" id="timer-indicator"></div>
                                <span class="text-xs font-medium text-green-600" id="timer-status">En juego</span>
                            </div>
                        </div>
                    </div>

                    <!-- Progreso Card -->
                    <div class="stat-card game-card rounded-lg p-5">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="icon-box" style="background: #f3e8ff;">
                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                            </div>
                            <span class="text-sm font-semibold text-gray-900">Progreso</span>
                        </div>

                        <div class="divider"></div>

                        <!-- Nivel -->
                        <div class="mb-3">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-xs text-gray-600 font-medium">Nivel</span>
                                <span class="badge badge-info">{{ sesion.nivel_seleccionado }}</span>
                            </div>
                        </div>

                        <!-- Puntaje -->
                        <div class="score-card mb-3">
                            <div class="flex items-center justify-center gap-2 mb-2">
                                <svg class="w-5 h-5 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                            </div>
                            <div class="text-2xl font-bold text-gray-900 mb-0.5" id="puntaje-actual">{{ sesion.puntaje_total }}</div>
                            <div class="text-xs text-gray-600 font-medium">Puntos totales</div>
                        </div>

                        <!-- Preguntas -->
                        <div class="p-3 bg-gray-50 rounded-md">
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-medium text-gray-600">Preguntas</span>
                                <span class="text-sm font-bold text-blue-600">{{ sesion.preguntas_respondidas }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Participante Card -->
                    <div class="stat-card game-card rounded-lg p-5">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="icon-box" style="background: #f0fdf4;">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <span class="text-sm font-semibold text-gray-900">Participante</span>
                        </div>

                        <div class="divider"></div>
                        
                        <div class="p-3 bg-blue-50 rounded-md border border-blue-100">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full gradient-icon flex items-center justify-center flex-shrink-0">
                                    <span class="text-white font-bold text-xs">{{ nino.nombre_completo|slice:":2"|upper }}</span>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-xs font-bold text-gray-900 truncate">{{ nino.nombre_completo }}</p>
                                    <div class="flex items-center gap-1 mt-1 flex-wrap">
                                        <span class="badge badge-active text-xs">{{ nino.edad }} a.</span>
                                        <span class="badge badge-status text-xs">Activo</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel derecho - √Årea de juego mejorada -->
                <div class="lg:col-span-3">
                    <div class="game-area-container">
                        <div id="game-area" class="flex items-center justify-center">
                            <!-- Estado de carga mejorado -->
                            <div class="loading-state text-center">
                                <div class="relative mb-6">
                                    <div class="loading-spinner mx-auto"></div>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <svg class="w-8 h-8 text-purple-600 dark:text-purple-400 animate-bounce" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                                        </svg>
                                    </div>
                                </div>
                                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Cargando juego</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Preparando tu experiencia de aprendizaje</p>
                                <div class="flex items-center justify-center gap-2">
                                    <div class="w-2 h-2 bg-purple-600 dark:bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                                    <div class="w-2 h-2 bg-purple-600 dark:bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                                    <div class="w-2 h-2 bg-purple-600 dark:bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Pausa -->
<div id="pause-overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-50 flex items-center justify-center p-4 modal-overlay">
    <div class="modal-content max-w-sm w-full p-6">
        <div class="text-center mb-5">
            <div class="w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3" style="background: #fef3c7;">
                <svg class="w-7 h-7 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h3 class="text-lg font-bold text-gray-900 mb-1">Juego en Pausa</h3>
            <p class="text-xs text-gray-600">T√≥mate un descanso. Contin√∫a cuando est√©s listo.</p>
        </div>

        <!-- Stats en pausa -->
        <div class="grid grid-cols-2 gap-3 mb-5">
            <div class="p-3 rounded-lg" style="background: #f3e8ff; border: 1px solid #e9d5ff;">
                <div class="text-lg font-bold text-purple-600" id="pause-score">0</div>
                <div class="text-xs text-gray-600 font-medium">Puntos</div>
            </div>
            <div class="p-3 rounded-lg" style="background: #dbeafe; border: 1px solid #bae6fd;">
                <div class="text-lg font-bold text-blue-600" id="pause-time">00:00</div>
                <div class="text-xs text-gray-600 font-medium">Tiempo</div>
            </div>
        </div>

        <button id="btn-resume-game" 
                class="w-full btn-primary btn-green justify-center"
                style="padding: 0.75rem 1.25rem;">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" />
            </svg>
            Continuar
        </button>
    </div>
</div>

<!-- Modal de confirmaci√≥n -->
<div id="modal-finish" class="fixed inset-0 bg-black bg-opacity-30 hidden z-50 flex items-center justify-center p-4 modal-overlay">
    <div class="modal-content max-w-sm w-full p-6">
        <div class="flex items-start gap-3 mb-4">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center flex-shrink-0" style="background: #fee2e2;">
                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <div>
                <h3 class="font-bold text-gray-900 text-sm mb-0.5">¬øFinalizar juego?</h3>
                <p class="text-xs text-gray-600">No se puede deshacer</p>
            </div>
        </div>

        <p class="text-xs text-gray-600 mb-5 leading-relaxed">
            Tu progreso se guardar√° autom√°ticamente. ¬øEst√°s seguro de que deseas salir?
        </p>

        <div class="flex gap-3">
            <button id="btn-cancel-finish" 
                    class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors border border-gray-300">
                Cancelar
            </button>
            <button id="btn-confirm-finish" 
                    class="flex-1 btn-primary btn-red justify-center"
                    style="padding: 0.5rem;">
                Finalizar
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/' %}{{ juego.slug }}.js"></script>

<script>
    window.gameSessionData = {
        url_sesion: '{{ sesion.url_sesion }}',
        juego_slug: '{{ juego.slug }}',
        juego_nombre: '{{ juego.nombre }}',
        evaluacion_id: '{{ evaluacion.id }}',
        nino_id: '{{ nino.id }}',
        api_urls: {
            question_response: '{% url "games:save_question_response" %}',
            level_complete: '{% url "games:save_level_complete" %}',
            finish_game: '{% url "games:finish_game_session" url_sesion=sesion.url_sesion %}',
            game_list: '{% url "games:game_list" %}'
        }
    };

    window.gameConfig = {{ game_config_json|safe }};

    (function initGamePage() {
        console.log('üéÆ Inicializando juego...');
        
        const startTime = new Date('{{ sesion.fecha_inicio|date:"c" }}');
        let isPaused = false;
        let pauseStartTime = null;
        let totalPausedTime = 0;
        let timerInterval = null;
        
        const fullscreenContainer = document.getElementById('fullscreen-container');
        const btnFullscreen = document.getElementById('btn-fullscreen');
        const fullscreenIcon = document.getElementById('fullscreen-icon');
        const fullscreenText = document.getElementById('fullscreen-text');
        
        function updateTimer() {
            if (isPaused) return;
            
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000) - totalPausedTime;
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;
            
            const timerMinutes = document.getElementById('timer-minutes');
            const timerSeconds = document.getElementById('timer-seconds');
            
            if (timerMinutes && timerSeconds) {
                timerMinutes.textContent = String(minutes).padStart(2, '0');
                timerSeconds.textContent = String(seconds).padStart(2, '0');
            }
        }
        
        btnFullscreen?.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                fullscreenContainer.requestFullscreen().catch(err => {
                    console.error('Error:', err);
                });
            } else {
                document.exitFullscreen();
            }
        });
        
        const pauseOverlay = document.getElementById('pause-overlay');
        const btnPause = document.getElementById('btn-pause-game');
        const btnResume = document.getElementById('btn-resume-game');
        
        btnPause?.addEventListener('click', () => {
            isPaused = true;
            pauseStartTime = Date.now();
            pauseOverlay.classList.remove('hidden');
            
            const timerMinutes = document.getElementById('timer-minutes');
            const timerSeconds = document.getElementById('timer-seconds');
            document.getElementById('pause-time').textContent = 
                `${timerMinutes.textContent}:${timerSeconds.textContent}`;
            document.getElementById('pause-score').textContent = 
                document.getElementById('puntaje-actual').textContent;
            
            document.getElementById('timer-indicator').classList.remove('animate-pulse');
            document.getElementById('timer-indicator').style.background = '#fbbf24';
            document.getElementById('timer-status').textContent = 'En pausa';
            document.getElementById('timer-status').style.color = '#b45309';
            document.getElementById('timer-status-badge').textContent = 'Pausado';
        });
        
        btnResume?.addEventListener('click', () => {
            const pauseDuration = Math.floor((Date.now() - pauseStartTime) / 1000);
            totalPausedTime += pauseDuration;
            isPaused = false;
            pauseOverlay.classList.add('hidden');
            
            document.getElementById('timer-indicator').classList.add('animate-pulse');
            document.getElementById('timer-indicator').style.background = '#22c55e';
            document.getElementById('timer-status').textContent = 'En juego';
            document.getElementById('timer-status').style.color = '#16a34a';
            document.getElementById('timer-status-badge').textContent = 'Activo';
        });
        
        window.updateScore = function(newScore) {
            // Actualizar puntaje en el panel lateral
            const scoreElement = document.getElementById('puntaje-actual');
            if (scoreElement) {
                scoreElement.textContent = newScore;
                scoreElement.style.animation = 'pulse 0.3s ease-in-out';
                setTimeout(() => {
                    scoreElement.style.animation = '';
                }, 300);
            }
            
            // Actualizar puntaje en el encabezado del juego
            const gameScoreElement = document.getElementById('game-score');
            if (gameScoreElement) {
                gameScoreElement.textContent = newScore;
                gameScoreElement.style.animation = 'pulse 0.3s ease-in-out';
                setTimeout(() => {
                    gameScoreElement.style.animation = '';
                }, 300);
            }
        };
        
        const btnFinish = document.getElementById('btn-finish-game');
        const modal = document.getElementById('modal-finish');
        const btnCancel = document.getElementById('btn-cancel-finish');
        const btnConfirm = document.getElementById('btn-confirm-finish');
        
        if (btnFinish && modal) {
            btnFinish.addEventListener('click', () => {
                modal.classList.remove('hidden');
            });
        }
        
        if (btnCancel && modal) {
            btnCancel.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
        }
        
        if (btnConfirm) {
            btnConfirm.addEventListener('click', async () => {
                try {
                    const response = await fetch(`{% url 'games:finish_game_session' url_sesion=sesion.url_sesion %}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            total_score: document.getElementById('puntaje-actual').textContent,
                            total_correct: 0,
                            total_incorrect: 0,
                            total_time_seconds: Math.floor((new Date() - startTime) / 1000) - totalPausedTime
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        window.location.href = '{% url "games:game_list" %}';
                    } else {
                        alert('Error: ' + (data.error || 'Intenta de nuevo'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error de conexi√≥n');
                }
                
                modal.classList.add('hidden');
            });
        }
        
        function getCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            return cookieValue || '';
        }
        
        timerInterval = setInterval(updateTimer, 1000);
        updateTimer();
        
        console.log('‚úÖ Juego inicializado correctamente');
    })();
</script>
{% endblock %}