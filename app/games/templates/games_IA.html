{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Análisis con IA - DislexIA" %}{% endblock %}

{% block extra_head %}
<style>
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fadeIn 0.2s ease-out;
    }

    .animate-slide-up {
        animation: slideUp 0.3s ease-out;
    }

    .animate-spin-slow {
    animation: spin-slow 3s linear infinite;
    }

    .bg-gradient-conic {
    background: conic-gradient(from 0deg, #60a5fa, #a78bfa, #60a5fa);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8 flex items-start">
        <!-- GIF a la izquierda -->
        <img src="{% static 'img/ia_carga.gif' %}" alt="IA Icon" class="w-20 h-20 mr-4 flex-shrink-0">

        <!-- Texto a la derecha -->
        <div class="text-left">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
                {% trans "Análisis con IA" %}
            </h1>
            <p class="text-gray-600 dark:text-gray-400">
                {% trans "Evaluación cognitiva integral con análisis inteligente del desempeño" %}
            </p>
        </div>
    </div>

    <!-- Card Principal - Sesión Integral -->
    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 rounded-2xl border border-purple-200 dark:border-purple-800 p-8 mb-8">
        <div class="flex items-start gap-6">

            <!-- Contenido -->
            <div class="flex-1">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-3">
                    {% trans "Sesión de Evaluación Cognitiva Completa" %}
                </h2>
                <p class="text-gray-700 dark:text-gray-300 mb-4 leading-relaxed">
                    {% trans "Esta sesión integral combina los 6 juegos cognitivos diseñados específicamente para evaluar diferentes áreas del desarrollo neuropsicológico. La inteligencia artificial analizará automáticamente el desempeño en tiempo real y generará un informe completo con recomendaciones personalizadas." %}
                </p>

                <!-- Características -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="flex items-center gap-3 bg-white dark:bg-gray-800 rounded-lg p-3 shadow-sm">
                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-900 dark:text-white">{% trans "Duración" %}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">{% trans "30-45 minutos" %}</p>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 bg-white dark:bg-gray-800 rounded-lg p-3 shadow-sm">
                        <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                            <i class="fas fa-gamepad text-green-600 dark:text-green-400"></i>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-900 dark:text-white">{% trans "Juegos" %}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">{% trans "6 actividades cognitivas" %}</p>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 bg-white dark:bg-gray-800 rounded-lg p-3 shadow-sm">
                        <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-900 dark:text-white">{% trans "Análisis IA" %}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">{% trans "Informe automático" %}</p>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 bg-white dark:bg-gray-800 rounded-lg p-3 shadow-sm">
                        <div class="w-10 h-10 bg-orange-100 dark:bg-orange-900/30 rounded-lg flex items-center justify-center">
                            <i class="fas fa-medal text-orange-600 dark:text-orange-400"></i>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-900 dark:text-white">{% trans "Resultados" %}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">{% trans "Inmediatos y detallados" %}</p>
                        </div>
                    </div>
                </div>

                <!-- Botón de Iniciar Prueba -->
                <div class="flex justify-center items-center mt-8">
                    <div class="relative p-1 rounded-xl animate-spin-slow bg-gradient-conic from-blue-400 via-purple-500 to-blue-400">
                        <button id="iniciarSesionBtn" onclick="abrirModalSeleccionNino()"
                            class="relative px-8 py-4 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg font-semibold text-lg flex items-center gap-3">
                            <img src="{% static 'img/ia_carga.gif' %}" alt="IA Icon" class="w-8 h-8 flex-shrink-0">
                            {% trans "Iniciar Prueba Cognitiva" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Juegos Incluidos -->
    <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">
            <i class="fas fa-list-check text-purple-600 dark:text-purple-400 mr-2"></i>
            {% trans "Juegos Incluidos en la Evaluación" %}
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Juego 1 -->
            <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 rounded-lg border border-blue-200 dark:border-blue-800">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-shapes text-white"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "Memoria Visual" %}</h3>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    {% trans "Evalúa la capacidad de recordar patrones visuales y formas." %}
                </p>
            </div>

            <!-- Juego 2 -->
            <div class="p-4 bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 rounded-lg border border-green-200 dark:border-green-800">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-font text-white"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "Reconocimiento Letras" %}</h3>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    {% trans "Mide la velocidad de identificación de letras y símbolos." %}
                </p>
            </div>

            <!-- Juego 3 -->
            <div class="p-4 bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 rounded-lg border border-purple-200 dark:border-purple-800">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-brain text-white"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "Atención Sostenida" %}</h3>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    {% trans "Evalúa la capacidad de mantener la concentración." %}
                </p>
            </div>

            <!-- Juego 4 -->
            <div class="p-4 bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-900/20 dark:to-yellow-800/20 rounded-lg border border-yellow-200 dark:border-yellow-800">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-yellow-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-puzzle-piece text-white"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "Razonamiento Lógico" %}</h3>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    {% trans "Analiza la capacidad de resolver problemas complejos." %}
                </p>
            </div>

            <!-- Juego 5 -->
            <div class="p-4 bg-gradient-to-br from-red-50 to-red-100 dark:from-red-900/20 dark:to-red-800/20 rounded-lg border border-red-200 dark:border-red-800">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-red-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-hand-pointer text-white"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "Coordinación Motora" %}</h3>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    {% trans "Mide la precisión y velocidad de respuesta motriz." %}
                </p>
            </div>

            <!-- Juego 6 -->
            <div class="p-4 bg-gradient-to-br from-indigo-50 to-indigo-100 dark:from-indigo-900/20 dark:to-indigo-800/20 rounded-lg border border-indigo-200 dark:border-indigo-800">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-book-open text-white"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "Comprensión Lectora" %}</h3>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    {% trans "Evalúa la velocidad y comprensión de lectura." %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Selección de Niño -->
<div id="modal-seleccion-nino" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 overflow-y-auto p-4">
    <div class="bg-white dark:bg-gray-900 rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden shadow-2xl border border-gray-200 dark:border-gray-800 animate-slide-up">
        <!-- Header del Modal -->
        <div class="sticky top-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 p-6 z-10">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-user-check text-purple-600 dark:text-purple-400 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">
                            {% trans "Selecciona un Niño" %}
                        </h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            {% trans "Elige quién realizará la evaluación completa" %}
                        </p>
                    </div>
                </div>
                <button onclick="cerrarModalSeleccionNino()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Buscador -->
            {% if ninos %}
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400 dark:text-gray-600"></i>
                </div>
                <input type="text" 
                       id="searchNinoModal" 
                       placeholder="{% trans 'Buscar por nombre, apellido o edad...' %}"
                       class="w-full pl-11 pr-4 py-3 border border-gray-300 dark:border-gray-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-600 transition-all">
            </div>
            
            <!-- Contador de resultados -->
            <div class="mt-3 text-sm text-gray-600 dark:text-gray-400">
                <span id="resultsCounterModal">{% trans "Mostrando" %} <strong>{{ ninos|length }}</strong> {% trans "niño(s)" %}</span>
            </div>
            {% endif %}
        </div>

        <!-- Contenido del Modal -->
        <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 200px);">
            {% if ninos %}
                <!-- Grid de niños -->
                <div id="ninosGridModal" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    {% for nino in ninos %}
                    <div class="nino-card-select bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6 cursor-pointer hover:border-purple-500 dark:hover:border-purple-400 transition-all"
                         data-nino-id="{{ nino.id }}"
                         data-nombre="{{ nino.nombres|lower }}"
                         data-apellido="{{ nino.apellidos|lower }}"
                         data-edad="{{ nino.edad }}"
                         onclick="seleccionarNino('{{ nino.id }}')">
                        
                        <!-- Header with Avatar -->
                        <div class="flex flex-col items-center mb-4">
                            <div class="w-20 h-20 rounded-full overflow-hidden ring-4 ring-purple-200 dark:ring-purple-500/30 mb-3">
                                {% if nino.imagen %}
                                    <img src="{{ nino.imagen.url }}" alt="{{ nino.nombres }}" class="w-full h-full object-cover">
                                {% else %}
                                    <div class="w-full h-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center text-white text-2xl font-bold">
                                        {{ nino.nombres.0 }}{{ nino.apellidos.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <h4 class="text-lg font-bold text-gray-900 dark:text-white text-center">
                                {{ nino.nombres }} {{ nino.apellidos }}
                            </h4>
                        </div>

                        <hr class="border-gray-200 dark:border-gray-800 my-4">

                        <!-- Details -->
                        <div class="space-y-2">
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-birthday-cake text-purple-600 dark:text-purple-400 w-5"></i>
                                <span class="text-gray-700 dark:text-gray-300">
                                    {{ nino.edad }} {% trans "años" %}
                                </span>
                            </div>
                            
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-calendar text-purple-600 dark:text-purple-400 w-5"></i>
                                <span class="text-gray-700 dark:text-gray-300">
                                    {{ nino.fecha_nacimiento|date:"d/m/Y" }}
                                </span>
                            </div>
                            
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-venus-mars text-purple-600 dark:text-purple-400 w-5"></i>
                                <span class="text-gray-700 dark:text-gray-300">
                                    {{ nino.genero }}
                                </span>
                            </div>
                        </div>

                        <!-- Botón de selección -->
                        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-800">
                            <div class="flex items-center justify-center gap-2 text-purple-600 dark:text-purple-400 font-semibold text-sm">
                                <i class="fas fa-play-circle"></i>
                                <span>{% trans "Seleccionar" %}</span>
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- No results message -->
                <div id="noResultsModal" class="hidden text-center py-12">
                    <i class="fas fa-search text-6xl text-gray-300 dark:text-gray-700 mb-4"></i>
                    <p class="text-gray-500 dark:text-gray-400 text-lg">
                        {% trans "No se encontraron niños con ese criterio de búsqueda" %}
                    </p>
                </div>
            {% else %}
                <div class="text-center py-16">
                    <div class="w-24 h-24 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-users text-5xl text-gray-400 dark:text-gray-600"></i>
                    </div>
                    <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-3">
                        {% trans "No hay niños registrados" %}
                    </h4>
                    <p class="text-gray-500 dark:text-gray-400 mb-8 max-w-md mx-auto">
                        {% trans "Para poder realizar la evaluación, primero debes registrar al menos un niño en el sistema" %}
                    </p>
                    <a href="{% url 'core:lista_ninos' %}" 
                       class="inline-flex items-center gap-2 px-8 py-4 bg-gradient-to-r from-purple-600 to-purple-800 hover:from-purple-500 hover:to-purple-700 text-white rounded-xl font-bold text-lg transition-all shadow-lg hover:shadow-xl transform hover:scale-105">
                        <i class="fas fa-plus"></i>
                        {% trans "Registrar Primer Niño" %}
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Footer con botón para gestionar niños -->
        {% if ninos %}
        <div class="border-t border-gray-200 dark:border-gray-800 p-6 bg-gray-50 dark:bg-gray-800/50">
            <a href="{% url 'core:lista_ninos' %}" 
               class="flex items-center justify-center gap-2 w-full px-6 py-3 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-xl font-semibold hover:bg-gray-100 dark:hover:bg-gray-700 hover:border-purple-500 dark:hover:border-purple-400 transition-all">
                <i class="fas fa-cog"></i>
                {% trans "Gestionar Niños Registrados" %}
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Confirmación de Niño Seleccionado -->
<div id="modal-confirmacion-nino" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-[60] animate-fade-in">
    <div class="bg-white dark:bg-gray-900 rounded-2xl w-11/12 md:w-[500px] p-6 shadow-2xl border border-gray-200 dark:border-gray-800 animate-slide-up">
        <!-- Header -->
        <div class="flex items-center gap-3 mb-6">
            <div class="w-16 h-16 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas fa-user-check text-purple-600 dark:text-purple-400 text-2xl"></i>
            </div>
            <div class="flex-1">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                    {% trans "Confirmar Selección" %}
                </h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    {% trans "Verifica antes de continuar" %}
                </p>
            </div>
        </div>
        
        <!-- Información del niño seleccionado -->
        <div class="bg-gradient-to-br from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 rounded-xl p-6 mb-6 border border-purple-200 dark:border-purple-800">
            <div class="flex items-center gap-4 mb-4">
                <!-- Avatar del niño -->
                <div id="confirmacion-avatar" class="w-20 h-20 rounded-full overflow-hidden ring-4 ring-purple-300 dark:ring-purple-600 flex-shrink-0">
                    <!-- Se llenará dinámicamente -->
                </div>
                
                <div class="flex-1">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
                        {% trans "El niño seleccionado para la evaluación es:" %}
                    </p>
                    <h4 id="confirmacion-nombre" class="text-2xl font-bold text-gray-900 dark:text-white">
                        <!-- Se llenará dinámicamente -->
                    </h4>
                </div>
            </div>
            
            <!-- Detalles adicionales -->
            <div class="grid grid-cols-2 gap-3 pt-4 border-t border-purple-200 dark:border-purple-800">
                <div class="flex items-center gap-2 text-sm">
                    <i class="fas fa-birthday-cake text-purple-600 dark:text-purple-400"></i>
                    <span id="confirmacion-edad" class="text-gray-700 dark:text-gray-300">
                        <!-- Se llenará dinámicamente -->
                    </span>
                </div>
                <div class="flex items-center gap-2 text-sm">
                    <i class="fas fa-venus-mars text-purple-600 dark:text-purple-400"></i>
                    <span id="confirmacion-genero" class="text-gray-700 dark:text-gray-300">
                        <!-- Se llenará dinámicamente -->
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Pregunta de confirmación -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
            <p class="text-center text-gray-800 dark:text-gray-200 font-semibold flex items-center justify-center gap-2">
                <i class="fas fa-question-circle text-blue-600 dark:text-blue-400"></i>
                {% trans "¿Estás seguro de continuar con este niño?" %}
            </p>
        </div>
        
        <!-- Botones de acción -->
        <div class="flex gap-3">
            <button onclick="cerrarModalConfirmacion()"
                    class="flex-1 px-6 py-3.5 bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-xl text-base font-semibold hover:bg-gray-300 dark:hover:bg-gray-700 transition-all flex items-center justify-center gap-2">
                <i class="fas fa-times"></i>
                {% trans "No, Cambiar" %}
            </button>
            <button id="btn-confirmar-jugar"
                    onclick="confirmarYJugar()"
                    class="flex-1 px-6 py-3.5 bg-gradient-to-r from-purple-600 to-purple-800 hover:from-purple-500 hover:to-purple-700 text-white rounded-xl text-base font-bold transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-check-circle"></i>
                {% trans "Sí, Continuar" %}
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let ninoSeleccionadoData = null;

    function abrirModalSeleccionNino() {
        ninoSeleccionadoData = null;
        
        const modal = document.getElementById('modal-seleccion-nino');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
        
        // Limpiar búsqueda al abrir
        const searchInput = document.getElementById('searchNinoModal');
        if (searchInput) {
            searchInput.value = '';
            filterNinosModal();
        }
    }

    function cerrarModalSeleccionNino() {
        const modal = document.getElementById('modal-seleccion-nino');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = 'auto';
        
        if (!ninoSeleccionadoData) {
            ninoSeleccionadoData = null;
        }
    }

    function seleccionarNino(ninoId) {
        console.log('=== Seleccionando niño:', ninoId);
        
        // Encontrar la tarjeta del niño seleccionado
        const ninoCard = document.querySelector(`#ninosGridModal [data-nino-id="${ninoId}"]`);
        if (!ninoCard) {
            console.error('No se encontró el niño seleccionado');
            return;
        }

        // Extraer información del niño
        const nombreCompleto = ninoCard.querySelector('h4').textContent.trim();
        const edad = ninoCard.dataset.edad;
        
        // Buscar el género
        const generoSpans = ninoCard.querySelectorAll('.space-y-2 .flex span.text-gray-700');
        let genero = 'No especificado';
        generoSpans.forEach(span => {
            const parentDiv = span.parentElement;
            if (parentDiv && parentDiv.querySelector('.fa-venus-mars')) {
                genero = span.textContent.trim();
            }
        });
        
        // Clonar el avatar HTML
        const avatarContainer = ninoCard.querySelector('.w-20.h-20');
        const avatarHTML = avatarContainer ? avatarContainer.innerHTML : '';
        
        // Guardar datos del niño seleccionado
        ninoSeleccionadoData = {
            id: ninoId,
            nombre: nombreCompleto,
            edad: edad,
            genero: genero,
            avatarHTML: avatarHTML
        };

        console.log('Datos del niño seleccionado:', ninoSeleccionadoData);

        // Llenar modal de confirmación
        document.getElementById('confirmacion-nombre').textContent = nombreCompleto;
        document.getElementById('confirmacion-edad').textContent = `${edad} años`;
        document.getElementById('confirmacion-genero').textContent = genero;
        document.getElementById('confirmacion-avatar').innerHTML = avatarHTML;

        // Cerrar modal de selección
        const modalSeleccion = document.getElementById('modal-seleccion-nino');
        modalSeleccion.classList.add('hidden');
        modalSeleccion.classList.remove('flex');
        
        // Abrir modal de confirmación
        setTimeout(() => {
            const modalConfirmacion = document.getElementById('modal-confirmacion-nino');
            modalConfirmacion.classList.remove('hidden');
            modalConfirmacion.classList.add('flex');
        }, 150);
    }

    function cerrarModalConfirmacion() {
        const modal = document.getElementById('modal-confirmacion-nino');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        
        ninoSeleccionadoData = null;
        
        // Volver a abrir el modal de selección
        setTimeout(() => {
            const modalSeleccion = document.getElementById('modal-seleccion-nino');
            modalSeleccion.classList.remove('hidden');
            modalSeleccion.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }, 150);
    }

    function confirmarYJugar() {
        console.log('=== Confirmando y comenzando evaluación ===');
        console.log('ninoSeleccionadoData:', ninoSeleccionadoData);
        
        if (!ninoSeleccionadoData) {
            console.error('No hay datos del niño seleccionado');
            return;
        }

        const btnConfirmar = document.getElementById('btn-confirmar-jugar');
        const originalText = btnConfirmar.innerHTML;
        
        // Mostrar estado de carga
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Iniciando Evaluación...';

        // Aquí deberías redirigir a la URL de inicio de la sesión IA con el ID del niño
        // Por ejemplo: /es/games/ia/init/?nino_id=123
        const urlInicio = `/es/games/ia/init/?nino_id=${ninoSeleccionadoData.id}`;
        
        console.log('URL de inicio generada:', urlInicio);
        console.log('ninoSeleccionadoData.id:', ninoSeleccionadoData.id);
        
        // Redirigir después de un pequeño delay
        setTimeout(() => {
            window.location.href = urlInicio;
        }, 500);
    }

    // Filtrado de niños en el modal
    function filterNinosModal() {
        const searchInput = document.getElementById('searchNinoModal');
        if (!searchInput) return;
        
        const searchTerm = searchInput.value.toLowerCase();
        const ninoCards = document.querySelectorAll('#ninosGridModal .nino-card-select');
        const resultsCounter = document.getElementById('resultsCounterModal');
        const ninosGrid = document.getElementById('ninosGridModal');
        const noResults = document.getElementById('noResultsModal');
        
        let visibleCount = 0;

        ninoCards.forEach(card => {
            const nombre = card.dataset.nombre || '';
            const apellido = card.dataset.apellido || '';
            const edad = card.dataset.edad || '';

            const matchesSearch = nombre.includes(searchTerm) || 
                                apellido.includes(searchTerm) ||
                                edad.includes(searchTerm);

            if (matchesSearch) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // Actualizar contador
        if (resultsCounter) {
            resultsCounter.innerHTML = `Mostrando <strong>${visibleCount}</strong> niño(s)`;
        }
        
        // Mostrar/ocultar mensaje de no resultados
        if (ninosGrid && noResults) {
            if (visibleCount === 0) {
                ninosGrid.classList.add('hidden');
                noResults.classList.remove('hidden');
            } else {
                ninosGrid.classList.remove('hidden');
                noResults.classList.add('hidden');
            }
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchNinoModal');
        if (searchInput) {
            searchInput.addEventListener('input', filterNinosModal);
            
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    searchInput.value = '';
                    filterNinosModal();
                }
            });
        }
    });

    // Cerrar modales con Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modalConfirmacion = document.getElementById('modal-confirmacion-nino');
            const modalSeleccion = document.getElementById('modal-seleccion-nino');
            
            if (!modalConfirmacion.classList.contains('hidden')) {
                cerrarModalConfirmacion();
            } else if (!modalSeleccion.classList.contains('hidden')) {
                cerrarModalSeleccionNino();
            }
        }
    });

    // Cerrar modales al hacer clic fuera
    document.getElementById('modal-seleccion-nino')?.addEventListener('click', function(e) {
        if (e.target === this) {
            cerrarModalSeleccionNino();
        }
    });

    document.getElementById('modal-confirmacion-nino')?.addEventListener('click', function(e) {
        if (e.target === this) {
            cerrarModalConfirmacion();
        }
    });
</script>
{% endblock %}