{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/games.css' %}">
{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <!-- Título -->
    <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{% trans "Juegos de Entrenamiento" %}</h1>
        <p class="text-gray-600 dark:text-gray-400">{% trans "Mejora tus habilidades cognitivas con nuestros juegos interactivos" %}</p>
    </div>

    <!-- Buscador y Filtros -->
    <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
        <!-- Buscador -->
        <div class="relative w-full sm:w-64">
            <input type="text" id="search-input" placeholder="{% trans 'Buscar juegos...' %}"
                class="w-full pl-10 pr-4 py-3 rounded-full border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500"></i>
        </div>

        <!-- Filtros de dificultad -->
        <div class="flex gap-2">
            <button
                class="filter-btn px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl text-sm font-medium transition-all hover:bg-purple-50 dark:hover:bg-purple-900/30 text-gray-700 dark:text-gray-300 active"
                data-filter="all">
                {% trans "Todos" %}
            </button>
            <button
                class="filter-btn px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl text-sm font-medium transition-all hover:bg-green-50 dark:hover:bg-green-900/30 text-gray-700 dark:text-gray-300"
                data-filter="facil">
                {% trans "Fácil" %}
            </button>
            <button
                class="filter-btn px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl text-sm font-medium transition-all hover:bg-yellow-50 dark:hover:bg-yellow-900/30 text-gray-700 dark:text-gray-300"
                data-filter="medio">
                {% trans "Medio" %}
            </button>
            <button
                class="filter-btn px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl text-sm font-medium transition-all hover:bg-red-50 dark:hover:bg-red-900/30 text-gray-700 dark:text-gray-300"
                data-filter="dificil">
                {% trans "Difícil" %}
            </button>
        </div>
    </div>
</div>

<!-- Stats Section -->
{% if juegos %}
<div class="p-8 grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 text-center">
        <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="fas fa-clock text-purple-600 dark:text-purple-400 text-xl"></i>
        </div>
        <p class="text-2xl font-bold text-gray-900 dark:text-white mb-1">
            15-25 {% trans "min" %}
        </p>
        <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "Tiempo estimado total" %}</p>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 text-center">
        <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="fas fa-gamepad text-green-600 dark:text-green-400 text-xl"></i>
        </div>
        <p class="text-2xl font-bold text-gray-900 dark:text-white mb-1">{{ juegos|length }}</p>
        <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "Juegos disponibles" %}</p>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 text-center">
        <div class="w-12 h-12 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="fas fa-star text-yellow-600 dark:text-yellow-400 text-xl"></i>
        </div>
        <p class="text-2xl font-bold text-gray-900 dark:text-white mb-1">4.7</p>
        <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "Puntuación promedio" %}</p>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 text-center">
        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="fas fa-users text-blue-600 dark:text-blue-400 text-xl"></i>
        </div>
        <p class="text-2xl font-bold text-gray-900 dark:text-white mb-1">
            {% regroup juegos by total_jugadas as jugadas_list %}{{ jugadas_list|length|default:0 }}
        </p>
        <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "Total jugadas" %}</p>
    </div>
</div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6" id="games-container">
    {% for juego in juegos %}
    <div class="game-card bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden"
         data-difficulty="{{ juego.dificultad }}"
         data-name="{{ juego.nombre|lower }}"
         data-description="{{ juego.descripcion|lower }}">
        
        <div class="game-image relative h-48">
            <img class="w-full h-full object-cover" 
                 src="{% if juego.imagen %}{{ juego.imagen.url }}{% else %}{% static 'img/default-game.png' %}{% endif %}" 
                 alt="{{ juego.nombre }}" />
            
            <!-- Badge de dificultad -->
            <div class="absolute top-4 right-4">
                <span class="difficulty-badge px-3 py-1 difficulty-{{ juego.dificultad }} text-white text-xs font-semibold rounded-full">
                    {{ juego.get_dificultad_display }}
                </span>
            </div>
            
            <!-- Información flotante -->
            <div class="absolute bottom-4 left-4 z-10">
                <div class="flex items-center gap-2">
                    <div class="px-3 py-1 bg-white/20 backdrop-blur-md rounded-full">
                        <span class="text-white text-sm font-medium">⭐ {{ juego.puntuacion_promedio }}</span>
                    </div>
                    <div class="px-3 py-1 bg-white/20 backdrop-blur-md rounded-full">
                        <span class="text-white text-sm font-medium">⏱️ {{ juego.duracion_estimada_minutos }} {% trans "min" %}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-6">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">{{ juego.nombre }}</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4 leading-relaxed">
                {{ juego.descripcion }}
            </p>

            <!-- Estadísticas -->
            <div class="flex items-center gap-4 mb-4 text-sm text-gray-500 dark:text-gray-400">
                <div class="flex items-center gap-1">
                    <i class="fas fa-gamepad text-{{ juego.color_tema }}-500"></i>
                    <span>{{ juego.total_jugadas }} {% trans "jugadas" %}</span>
                </div>
                <div class="flex items-center gap-1">
                    <i class="fas fa-trophy text-yellow-500"></i>
                    <span>{{ juego.total_completados }} {% trans "completados" %}</span>
                </div>
            </div>

            <!-- Barra de progreso -->
            <div class="mb-4">
                <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mb-1">
                    <span>{% trans "Progreso" %}</span>
                    <span>{{ juego.porcentaje_completado }}%</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                    <div class="bg-gradient-to-r from-{{ juego.color_gradiente_inicio }} to-{{ juego.color_gradiente_fin }} h-2 rounded-full"
                         style="width: {{ juego.porcentaje_completado }}%"></div>
                </div>
            </div>

            <!-- Botón para jugar -->
            <button
               onclick="abrirModalSeleccionNino('{{ juego.slug }}', '{% url 'games:init_game' juego_slug=juego.slug %}')"
               class="w-full bg-gradient-to-r from-{{ juego.color_gradiente_inicio }} to-{{ juego.color_gradiente_fin }} hover:from-{{ juego.color_tema }}-600 hover:to-{{ juego.color_tema }}-700 text-white font-semibold py-3 rounded-xl transition-all duration-200 flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                <i class="fas fa-play"></i>
                {% trans "Jugar Ahora" %}
            </button>
        </div>
    </div>
    {% empty %}
    <div class="col-span-full text-center py-12">
        <div class="text-gray-400 dark:text-gray-600 mb-4">
            <i class="fas fa-gamepad text-6xl"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">{% trans "No hay juegos disponibles" %}</h3>
        <p class="text-gray-500 dark:text-gray-500">{% trans "Los juegos están siendo configurados. Vuelve pronto." %}</p>
    </div>
    {% endfor %}
</div>

<!-- Modal de Selección de Niño -->
<div id="modal-seleccion-nino" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 overflow-y-auto p-4" style="z-index:99999;">
    <div class="bg-white dark:bg-gray-900 rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden shadow-2xl border border-gray-200 dark:border-gray-800 animate-slide-up">
        <!-- Header del Modal -->
        <div class="sticky top-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 p-6 z-10">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-user-check text-purple-600 dark:text-purple-400 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white">
                            {% trans "Selecciona un Niño" %}
                        </h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            {% trans "Elige quién jugará esta sesión" %}
                        </p>
                    </div>
                </div>
                <button onclick="cerrarModalSeleccionNino()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Buscador -->
            {% if ninos %}
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400 dark:text-gray-600"></i>
                </div>
                <input type="text" 
                       id="searchNinoModal" 
                       placeholder="{% trans 'Buscar por nombre, apellido o edad...' %}"
                       class="w-full pl-11 pr-4 py-3 border border-gray-300 dark:border-gray-700 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-600 transition-all">
            </div>
            
            <!-- Contador de resultados -->
            <div class="mt-3 text-sm text-gray-600 dark:text-gray-400">
                <span id="resultsCounterModal">{% trans "Mostrando" %} <strong>{{ ninos|length }}</strong> {% trans "niño(s)" %}</span>
            </div>
            {% endif %}
        </div>

        <!-- Contenido del Modal -->
        <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 200px);">
            {% if ninos %}
                <!-- Grid de niños -->
                <div id="ninosGridModal" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    {% for nino in ninos %}
                    <div class="nino-card-select bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-800 p-6 cursor-pointer hover:border-purple-500 dark:hover:border-purple-400 transition-all"
                         data-nino-id="{{ nino.id }}"
                         data-nombre="{{ nino.nombres|lower }}"
                         data-apellido="{{ nino.apellidos|lower }}"
                         data-edad="{{ nino.edad }}"
                         onclick="seleccionarNino('{{ nino.id }}')">
                        
                        <!-- Header with Avatar -->
                        <div class="flex flex-col items-center mb-4">
                            <div class="w-20 h-20 rounded-full overflow-hidden ring-4 ring-purple-200 dark:ring-purple-500/30 mb-3">
                                {% if nino.imagen %}
                                    <img src="{{ nino.imagen.url }}" alt="{{ nino.nombres }}" class="w-full h-full object-cover">
                                {% else %}
                                    <div class="w-full h-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center text-white text-2xl font-bold">
                                        {{ nino.nombres.0 }}{{ nino.apellidos.0 }}
                                    </div>
                                {% endif %}
                            </div>
                            <h4 class="text-lg font-bold text-gray-900 dark:text-white text-center">
                                {{ nino.nombres }} {{ nino.apellidos }}
                            </h4>
                        </div>

                        <hr class="border-gray-200 dark:border-gray-800 my-4">

                        <!-- Details -->
                        <div class="space-y-2">
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-birthday-cake text-purple-600 dark:text-purple-400 w-5"></i>
                                <span class="text-gray-700 dark:text-gray-300">
                                    {{ nino.edad }} {% trans "años" %}
                                </span>
                            </div>
                            
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-calendar text-purple-600 dark:text-purple-400 w-5"></i>
                                <span class="text-gray-700 dark:text-gray-300">
                                    {{ nino.fecha_nacimiento|date:"d/m/Y" }}
                                </span>
                            </div>
                            
                            <div class="flex items-center gap-2 text-sm">
                                <i class="fas fa-venus-mars text-purple-600 dark:text-purple-400 w-5"></i>
                                <span class="text-gray-700 dark:text-gray-300">
                                    {{ nino.genero }}
                                </span>
                            </div>
                        </div>

                        <!-- Botón de selección -->
                        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-800">
                            <div class="flex items-center justify-center gap-2 text-purple-600 dark:text-purple-400 font-semibold text-sm">
                                <i class="fas fa-play-circle"></i>
                                <span>{% trans "Seleccionar" %}</span>
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- No results message -->
                <div id="noResultsModal" class="hidden text-center py-12">
                    <i class="fas fa-search text-6xl text-gray-300 dark:text-gray-700 mb-4"></i>
                    <p class="text-gray-500 dark:text-gray-400 text-lg">
                        {% trans "No se encontraron niños con ese criterio de búsqueda" %}
                    </p>
                </div>
            {% else %}
                <div class="text-center py-16">
                    <div class="w-24 h-24 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-users text-5xl text-gray-400 dark:text-gray-600"></i>
                    </div>
                    <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-3">
                        {% trans "No hay niños registrados" %}
                    </h4>
                    <p class="text-gray-500 dark:text-gray-400 mb-8 max-w-md mx-auto">
                        {% trans "Para poder jugar, primero debes registrar al menos un niño en el sistema" %}
                    </p>
                    <a href="{% url 'core:lista_ninos' %}" 
                       class="inline-flex items-center gap-2 px-8 py-4 bg-gradient-to-r from-purple-600 to-purple-800 hover:from-purple-500 hover:to-purple-700 text-white rounded-xl font-bold text-lg transition-all shadow-lg hover:shadow-xl transform hover:scale-105">
                        <i class="fas fa-plus"></i>
                        {% trans "Registrar Primer Niño" %}
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Footer con botón para gestionar niños -->
        {% if ninos %}
        <div class="border-t border-gray-200 dark:border-gray-800 p-6 bg-gray-50 dark:bg-gray-800/50">
            <a href="{% url 'core:lista_ninos' %}" 
               class="flex items-center justify-center gap-2 w-full px-6 py-3 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 rounded-xl font-semibold hover:bg-gray-100 dark:hover:bg-gray-700 hover:border-purple-500 dark:hover:border-purple-400 transition-all">
                <i class="fas fa-cog"></i>
                {% trans "Gestionar Niños Registrados" %}
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Confirmación de Niño Seleccionado -->
<div id="modal-confirmacion-nino" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-[60] animate-fade-in" style="z-index:99999;">
    <div class="bg-white dark:bg-gray-900 rounded-2xl w-11/12 md:w-[500px] p-6 shadow-2xl border border-gray-200 dark:border-gray-800 animate-scale-in">
        <!-- Header -->
        <div class="flex items-center gap-3 mb-6">
            <div class="w-16 h-16 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas fa-user-check text-purple-600 dark:text-purple-400 text-2xl"></i>
            </div>
            <div class="flex-1">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                    {% trans "Confirmar Selección" %}
                </h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    {% trans "Verifica antes de continuar" %}
                </p>
            </div>
        </div>
        
        <!-- Información del niño seleccionado -->
        <div class="bg-gradient-to-br from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 rounded-xl p-6 mb-6 border border-purple-200 dark:border-purple-800">
            <div class="flex items-center gap-4 mb-4">
                <!-- Avatar del niño -->
                <div id="confirmacion-avatar" class="w-20 h-20 rounded-full overflow-hidden ring-4 ring-purple-300 dark:ring-purple-600 flex-shrink-0">
                    <!-- Se llenará dinámicamente -->
                </div>
                
                <div class="flex-1">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
                        {% trans "El niño seleccionado para jugar es:" %}
                    </p>
                    <h4 id="confirmacion-nombre" class="text-2xl font-bold text-gray-900 dark:text-white">
                        <!-- Se llenará dinámicamente -->
                    </h4>
                </div>
            </div>
            
            <!-- Detalles adicionales -->
            <div class="grid grid-cols-2 gap-3 pt-4 border-t border-purple-200 dark:border-purple-800">
                <div class="flex items-center gap-2 text-sm">
                    <i class="fas fa-birthday-cake text-purple-600 dark:text-purple-400"></i>
                    <span id="confirmacion-edad" class="text-gray-700 dark:text-gray-300">
                        <!-- Se llenará dinámicamente -->
                    </span>
                </div>
                <div class="flex items-center gap-2 text-sm">
                    <i class="fas fa-venus-mars text-purple-600 dark:text-purple-400"></i>
                    <span id="confirmacion-genero" class="text-gray-700 dark:text-gray-300">
                        <!-- Se llenará dinámicamente -->
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Pregunta de confirmación -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
            <p class="text-center text-gray-800 dark:text-gray-200 font-semibold flex items-center justify-center gap-2">
                <i class="fas fa-question-circle text-blue-600 dark:text-blue-400"></i>
                {% trans "¿Estás seguro de continuar con este niño?" %}
            </p>
        </div>
        
        <!-- Botones de acción -->
        <div class="flex gap-3">
            <button onclick="cerrarModalConfirmacion()"
                    class="flex-1 px-6 py-3.5 bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-xl text-base font-semibold hover:bg-gray-300 dark:hover:bg-gray-700 transition-all flex items-center justify-center gap-2">
                <i class="fas fa-times"></i>
                {% trans "No, Cambiar" %}
            </button>
            <button id="btn-confirmar-jugar"
                    onclick="confirmarYJugar()"
                    class="flex-1 px-6 py-3.5 bg-gradient-to-r from-purple-600 to-purple-800 hover:from-purple-500 hover:to-purple-700 text-white rounded-xl text-base font-bold transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                <i class="fas fa-check-circle"></i>
                {% trans "Sí, Continuar" %}
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Lista de juegos disponibles
    const juegos = [
        {% for juego in juegos %}
        {
            slug: '{{ juego.slug }}',
            nombre: '{{ juego.nombre }}',
            init_url: '{% url "games:init_game" juego_slug=juego.slug %}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    let juegoSeleccionado = {
        slug: '',
        url: ''
    };

    let ninoSeleccionadoData = null;

    function abrirModalSeleccionNino(juegoSlug, juegoUrl) {
        juegoSeleccionado = {
            slug: juegoSlug,
            url: juegoUrl
        };
        
        // Reset ninoSeleccionadoData
        ninoSeleccionadoData = null;
        
        const modal = document.getElementById('modal-seleccion-nino');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
        
        // Limpiar búsqueda al abrir
        const searchInput = document.getElementById('searchNinoModal');
        if (searchInput) {
            searchInput.value = '';
            filterNinosModal();
        }
    }

    function cerrarModalSeleccionNino() {
        const modal = document.getElementById('modal-seleccion-nino');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = 'auto';
        
        // Solo resetear si no vamos a confirmar
        if (!ninoSeleccionadoData) {
            juegoSeleccionado = { slug: '', url: '' };
        }
    }

    function seleccionarNino(ninoId) {
        console.log('=== Seleccionando niño:', ninoId);
        
        // Permitir selección si hay juego seleccionado o si es para iniciar automáticamente
        if (!juegoSeleccionado.url && juegos.length === 0) {
            console.error('No hay juego seleccionado y no hay juegos disponibles');
            return;
        }

        // Encontrar la tarjeta del niño seleccionado en el modal ANTES de cerrarlo
        const ninoCard = document.querySelector(`#ninosGridModal [data-nino-id="${ninoId}"]`);
        if (!ninoCard) {
            console.error('No se encontró el niño seleccionado');
            return;
        }

        // Extraer información del niño
        const nombreCompleto = ninoCard.querySelector('h4').textContent.trim();
        const edad = ninoCard.dataset.edad;
        
        // Buscar el género de forma más robusta
        const generoSpans = ninoCard.querySelectorAll('.space-y-2 .flex span.text-gray-700');
        let genero = 'No especificado';
        generoSpans.forEach(span => {
            const parentDiv = span.parentElement;
            if (parentDiv && parentDiv.querySelector('.fa-venus-mars')) {
                genero = span.textContent.trim();
            }
        });
        
        // Clonar el avatar HTML
        const avatarContainer = ninoCard.querySelector('.w-20.h-20');
        const avatarHTML = avatarContainer ? avatarContainer.innerHTML : '';
        
        // Guardar datos del niño seleccionado
        ninoSeleccionadoData = {
            id: ninoId,
            nombre: nombreCompleto,
            edad: edad,
            genero: genero,
            avatarHTML: avatarHTML
        };

        console.log('Datos del niño seleccionado:', ninoSeleccionadoData);

        // Llenar modal de confirmación ANTES de cerrar el modal de selección
        document.getElementById('confirmacion-nombre').textContent = nombreCompleto;
        document.getElementById('confirmacion-edad').textContent = `${edad} años`;
        document.getElementById('confirmacion-genero').textContent = genero;
        document.getElementById('confirmacion-avatar').innerHTML = avatarHTML;

        // Cerrar modal de selección
        const modalSeleccion = document.getElementById('modal-seleccion-nino');
        modalSeleccion.classList.add('hidden');
        modalSeleccion.classList.remove('flex');
        
        // Abrir modal de confirmación con un pequeño delay
        setTimeout(() => {
            const modalConfirmacion = document.getElementById('modal-confirmacion-nino');
            modalConfirmacion.classList.remove('hidden');
            modalConfirmacion.classList.add('flex');
            // Asegurar que no se pueda hacer scroll del body mientras el modal de confirmación esté abierto
            document.body.style.overflow = 'hidden';
        }, 150);
    }

    function cerrarModalConfirmacion() {
        const modal = document.getElementById('modal-confirmacion-nino');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        
        // Limpiar datos del niño seleccionado
        ninoSeleccionadoData = null;
        
        // Volver a abrir el modal de selección con un pequeño delay
        setTimeout(() => {
            const modalSeleccion = document.getElementById('modal-seleccion-nino');
            modalSeleccion.classList.remove('hidden');
            modalSeleccion.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }, 150);
    }

    function confirmarYJugar() {
        console.log('=== Confirmando y jugando ===');
        console.log('ninoSeleccionadoData:', ninoSeleccionadoData);
        console.log('juegoSeleccionado:', juegoSeleccionado);
        
        if (!ninoSeleccionadoData) {
            console.error('No hay niño seleccionado');
            return;
        }

        // Si no hay juego seleccionado, usar el primer juego para iniciar automáticamente
        let juegoUrl = juegoSeleccionado.url;
        if (!juegoUrl && juegos.length > 0) {
            juegoUrl = juegos[0].init_url;
            console.log('Usando primer juego:', juegos[0]);
        }

        if (!juegoUrl) {
            console.error('No hay URL de juego disponible');
            return;
        }

        const btnConfirmar = document.getElementById('btn-confirmar-jugar');
        const originalText = btnConfirmar.innerHTML;
        
        // Mostrar estado de carga
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Iniciando...';

        // Construir URL con el ID del niño
        const urlConNino = `${juegoUrl}?nino_id=${ninoSeleccionadoData.id}`;
        
        console.log('URL final:', urlConNino);
        
        // Pequeño delay para dar feedback visual y luego redirigir
        setTimeout(() => {
            window.location.href = urlConNino;
        }, 500);
    }

    // Filtrado de niños en el modal
    function filterNinosModal() {
        const searchInput = document.getElementById('searchNinoModal');
        if (!searchInput) return;
        
        const searchTerm = searchInput.value.toLowerCase();
        const ninoCards = document.querySelectorAll('#ninosGridModal .nino-card-select');
        const resultsCounter = document.getElementById('resultsCounterModal');
        const ninosGrid = document.getElementById('ninosGridModal');
        const noResults = document.getElementById('noResultsModal');
        
        let visibleCount = 0;

        ninoCards.forEach(card => {
            const nombre = card.dataset.nombre || '';
            const apellido = card.dataset.apellido || '';
            const edad = card.dataset.edad || '';

            const matchesSearch = nombre.includes(searchTerm) || 
                                apellido.includes(searchTerm) ||
                                edad.includes(searchTerm);

            if (matchesSearch) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // Actualizar contador
        if (resultsCounter) {
            resultsCounter.innerHTML = `Mostrando <strong>${visibleCount}</strong> niño(s)`;
        }
        
        // Mostrar/ocultar mensaje de no resultados
        if (ninosGrid && noResults) {
            if (visibleCount === 0) {
                ninosGrid.classList.add('hidden');
                noResults.classList.remove('hidden');
            } else {
                ninosGrid.classList.remove('hidden');
                noResults.classList.add('hidden');
            }
        }
    }

    // Event listener para el buscador del modal
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchNinoModal');
        if (searchInput) {
            searchInput.addEventListener('input', filterNinosModal);
            
            // Limpiar búsqueda con Escape
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    searchInput.value = '';
                    filterNinosModal();
                }
            });
        }

        // Verificar si se debe abrir el modal automáticamente
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('abrir_modal') === '1') {
            abrirModalSeleccionNino('', ''); // Abrir modal sin juego seleccionado
        }
    });

    // Cerrar modal con Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modalConfirmacion = document.getElementById('modal-confirmacion-nino');
            const modalSeleccion = document.getElementById('modal-seleccion-nino');
            
            if (!modalConfirmacion.classList.contains('hidden')) {
                cerrarModalConfirmacion();
            } else if (!modalSeleccion.classList.contains('hidden')) {
                cerrarModalSeleccionNino();
                document.body.style.overflow = 'auto';
            }
        }
    });

    // Cerrar modales al hacer clic fuera
    document.getElementById('modal-seleccion-nino')?.addEventListener('click', function(e) {
        if (e.target === this) {
            cerrarModalSeleccionNino();
            document.body.style.overflow = 'auto';
        }
    });

    document.getElementById('modal-confirmacion-nino')?.addEventListener('click', function(e) {
        if (e.target === this) {
            cerrarModalConfirmacion();
        }
    });

    // Filtrado por dificultad
    const filterButtons = document.querySelectorAll('.filter-btn');
    const gameCards = document.querySelectorAll('.game-card');
    const searchInput = document.getElementById('search-input');

    filterButtons.forEach(button => {
        button.addEventListener('click', function () {
            // Remover clase activa de todos los botones
            filterButtons.forEach(btn => {
                btn.classList.remove('active', 'bg-purple-500', 'text-white');
                btn.classList.add('text-gray-700', 'dark:text-gray-300');
            });

            // Agregar clase activa al botón clickeado
            this.classList.add('active', 'bg-purple-500', 'text-white');
            this.classList.remove('text-gray-700', 'dark:text-gray-300');

            const filter = this.getAttribute('data-filter');

            gameCards.forEach(card => {
                if (filter === 'all') {
                    card.style.display = 'block';
                } else {
                    if (card.getAttribute('data-difficulty') === filter) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
        });
    });

    // Búsqueda de juegos
    if (searchInput) {
        searchInput.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();

            gameCards.forEach(card => {
                const name = card.getAttribute('data-name') || '';
                const description = card.getAttribute('data-description') || '';

                if (name.includes(searchTerm) || description.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    }
</script>
{% endblock %}